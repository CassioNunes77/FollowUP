<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gest√£o de Fichas de Terceirizados</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@400;600&family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <!-- Firebase Configuration -->
  <script type="module" src="firebase-auth.js"></script>
  <style>
    :root {
      /* Nova paleta de cores moderna e leg√≠vel */
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --primary-50: #eff6ff;
      --primary-100: #dbeafe;
      --primary-200: #bfdbfe;
      
      --accent: #f1f5f9;
      --accent-light: #f8fafc;
      --accent-dark: #e2e8f0;
      
      --bg: #ffffff;
      --bg-secondary: #f8fafc;
      --surface: #ffffff;
      --surface-hover: #f8fafc;
      
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --border-dark: #cbd5e1;
      
      --text: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --text-light: #94a3b8;
      
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --error: #ef4444;
      --error-light: #fee2e2;
      
      --radius: 12px;
      --radius-lg: 16px;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --sidebar-width: 280px;
    }
    
    * { 
      box-sizing: border-box; 
    }
    
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg-secondary);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      line-height: 1.6;
    }
    
    /* Sidebar moderna com cores atualizadas */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--surface);
      color: var(--text);
      box-shadow: var(--shadow-xl);
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 100;
      display: flex;
      flex-direction: column;
      transition: transform var(--transition);
      border-right: 1px solid var(--border);
    }
    
    .sidebar-header {
      padding: 2rem 1.5rem 1.5rem 1.5rem;
      border-bottom: 1px solid var(--border);
      background: var(--primary-50);
    }
    
    .sidebar-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      color: var(--primary);
      letter-spacing: -0.025em;
      font-family: 'Poppins', sans-serif;
    }
    
    .sidebar-nav {
      padding: 1.5rem 0;
      flex: 1;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      padding: 0.875rem 1.5rem;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all var(--transition);
      cursor: pointer;
      border-left: 3px solid transparent;
      border-radius: 0 8px 8px 0;
      margin: 0.25rem 0;
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
      font-weight: 500;
    }
    
    .nav-item:hover {
      background: var(--primary-50);
      color: var(--primary);
      border-left: 3px solid var(--primary);
    }
    
    .nav-item.active {
      background: var(--primary-50);
      color: var(--primary);
      border-left: 3px solid var(--primary);
      font-weight: 600;
    }
    
    .nav-item i, .nav-item .material-icons {
      margin-right: 0.875rem;
      font-size: 1.25rem;
      width: 24px;
      text-align: center;
      vertical-align: middle;
    }
    
    .nav-item span {
      font-weight: 500;
    }
    
    /* Bot√£o mobile atualizado */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 200;
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1.25rem;
      box-shadow: var(--shadow-lg);
      transition: all var(--transition);
    }
    
    .mobile-menu-toggle:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }
    
    /* Content wrapper atualizado */
    .content-wrapper {
      flex: 1;
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg-secondary);
    }
    
    .content-header {
      background: var(--surface);
      padding: 1rem 1.5rem;
      box-shadow: var(--shadow);
      border-bottom: 1px solid var(--border);
      font-family: 'Inter', sans-serif;
      height: 85px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .content-header h2 {
      margin: 0;
      font-size: 1.75rem;
      color: var(--text);
      font-weight: 700;
      font-family: 'Poppins', sans-serif;
    }
    
    .content-body {
      flex: 1;
      padding: 2rem;
    }
    
    /* Main content atualizado */
    main {
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 2rem 2.5rem;
      animation: fadeIn 0.7s;
      border: 1px solid var(--border);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Form sections atualizadas */
    .form-section {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-light);
      background: var(--bg-secondary);
      padding: 1.5rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    
    .form-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 1.5rem;
    }
    
    .form-section h2 {
      font-size: 1.125rem;
      color: var(--text);
      margin-bottom: 1.25rem;
      font-weight: 600;
      letter-spacing: -0.025em;
      font-family: 'Poppins', sans-serif;
    }
    
    /* Form elements atualizados */
    form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .form-row {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    
    .form-group {
      flex: 1 1 200px;
      display: flex;
      flex-direction: column;
    }
    
    label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }
    
    input, select {
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      background: var(--surface);
      transition: all var(--transition);
      outline: none;
      font-family: 'Inter', sans-serif;
      color: var(--text);
    }
    
    input:focus, select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-100);
    }
    
    input:disabled {
      background: var(--accent);
      color: var(--text-muted);
      cursor: not-allowed;
    }
    
    /* Tabelas atualizadas */
    .sizes-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.75rem;
      background: var(--surface);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    
    .sizes-table th, .sizes-table td {
      border: 1px solid var(--border);
      padding: 0.75rem 1rem;
      text-align: center;
      font-size: 0.875rem;
    }
    
    .sizes-table th {
      background: var(--primary-50);
      color: var(--primary);
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }
    
    /* Actions atualizadas */
    .actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    
    .actions button {
      padding: 0.875rem 2rem;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      background: var(--primary);
      color: white;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: all var(--transition);
      font-family: 'Inter', sans-serif;
    }
    
    .actions button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .actions button:active {
      transform: scale(0.98);
    }
    
    .actions button.secondary {
      background: var(--text-muted);
      color: white;
    }
    
    .actions button.secondary:hover {
      background: var(--text-secondary);
    }
    
    /* Tabela de listagem atualizada */
    .list-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      animation: fadeIn 0.7s;
      background: var(--surface);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }
    
    .list-table th, .list-table td {
      border: 1px solid var(--border);
      padding: 1rem 1.25rem;
      text-align: center;
      font-size: 0.875rem;
    }
    
    .list-table th {
      background: var(--primary-50);
      color: var(--primary);
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .list-table tr:nth-child(even) {
      background: var(--accent-light);
    }
    
    .list-table tr:hover {
      background: var(--primary-50);
    }
    
    /* Bot√µes de a√ß√£o atualizados */
    .delete-btn {
      background: none;
      border: none;
      color: var(--error);
      font-size: 1.125rem;
      cursor: pointer;
      transition: all var(--transition);
      padding: 0.5rem;
      border-radius: var(--radius);
    }
    
    .delete-btn:hover {
      color: #dc2626;
      background: var(--error-light);
    }
    
    .edit-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 1.125rem;
      cursor: pointer;
      transition: all var(--transition);
      margin-right: 0.5rem;
      padding: 0.5rem;
      border-radius: var(--radius);
    }
    
    .edit-btn:hover {
      color: var(--primary-dark);
      background: var(--primary-50);
    }
    
    /* Modal atualizado */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
      backdrop-filter: blur(4px);
    }
    
    .modal {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideIn 0.3s;
      border: 1px solid var(--border);
    }
    
    .modal-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--primary-50);
    }
    
    .modal-header h3 {
      margin: 0;
      color: var(--primary);
      font-size: 1.25rem;
      font-weight: 700;
      font-family: 'Poppins', sans-serif;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all var(--transition);
    }
    
    .modal-close:hover {
      background: var(--error-light);
      color: var(--error);
    }
    
    .modal-body {
      padding: 2rem;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Dashboard cards atualizados */
    .dashboard-section > div {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      transition: all var(--transition);
      margin-bottom: 0.5rem;
    }
    
    .dashboard-section > div:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .dashboard-section > div > div {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
      font-family: 'Poppins', sans-serif;
    }
    
    /* Responsividade atualizada */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .mobile-menu-toggle {
        display: block;
      }
      .content-wrapper {
        margin-left: 0;
      }
      .content-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }
      #user-info {
        width: 100%;
        justify-content: space-between;
      }
      .content-body {
        padding: 1rem;
      }
      main {
        padding: 1rem;
        margin: 1rem 0.5rem;
        max-width: calc(100vw - 1rem);
      }
      .form-row { 
        flex-direction: column; 
        gap: 1rem; 
      }
      .form-group {
        flex: none;
        max-width: 100%;
        min-width: auto;
      }
      .actions { 
        flex-direction: column; 
        gap: 0.8rem; 
      }
      .actions button {
        width: 100%;
        padding: 1rem 2rem;
      }
      .table-wrapper, .list-table { 
        max-width: 100vw; 
        overflow-x: auto;
      }
      .list-table { 
        min-width: 600px; 
        font-size: 0.8rem;
      }
      .list-table th, .list-table td {
        padding: 0.5rem 0.3rem;
      }
      form { 
        max-width: 100vw; 
        padding: 0;
      }
      .form-section {
        padding: 1rem;
        margin-bottom: 1.5rem;
      }
      .sizes-table {
        min-width: 300px;
        font-size: 0.8rem;
      }
      .sizes-table th, .sizes-table td {
        padding: 0.3rem 0.2rem;
      }
      .sizes-table input {
        padding: 0.3rem;
        font-size: 0.8rem;
      }
      input, select {
        padding: 0.8rem 0.8rem;
        font-size: 1rem;
      }
      .dashboard-section {
        padding: 0;
      }
      .dashboard-section > div:first-child {
        grid-template-columns: 1fr;
        gap: 0.8rem;
      }
      .dashboard-section > div:last-child {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      #pieChart, #lineChart {
        width: 250px !important;
        height: 250px !important;
      }
      header {
        padding: 1rem 1rem;
        flex-direction: column;
        gap: 1rem;
      }
      nav {
        display: flex;
        gap: 0.5rem;
        width: 100%;
        justify-content: center;
      }
      nav button {
        margin-left: 0;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        flex: 1;
        max-width: 120px;
      }
    }
    
    @media (max-width: 480px) {
      main {
        margin: 0.5rem 0.25rem;
        padding: 0.8rem 0.8rem;
      }
      .list-table {
        min-width: 500px;
        font-size: 0.75rem;
      }
      .sizes-table {
        min-width: 250px;
        font-size: 0.75rem;
      }
      input, select {
        padding: 0.7rem 0.6rem;
        font-size: 0.95rem;
      }
      .form-section h2 {
        font-size: 1rem;
        margin-bottom: 0.8rem;
      }
      h2 {
        font-size: 1.2rem;
        margin-bottom: 1rem;
      }
    }
    
    /* Responsividade para os gr√°ficos do dashboard */
    @media (max-width: 1024px) {
      .dashboard-charts-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
    }
    
    @media (max-width: 768px) {
      .dashboard-charts-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .dashboard-charts-grid canvas {
        max-width: 100%;
        height: auto;
      }
    }
    
    /* Ajustes para √≠cones Material */
    .edit-btn, .delete-btn {
      font-family: 'Material Icons';
      font-size: 1.25rem;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      transition: all var(--transition);
      border-radius: var(--radius);
      margin: 0;
      min-width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .action-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
      flex-wrap: nowrap;
    }
    
    .edit-btn { 
      color: var(--primary); 
      background: var(--primary-50);
    }
    
    .edit-btn:hover { 
      color: var(--primary-dark);
      background: var(--primary-100);
      transform: scale(1.05);
    }
    
    .delete-btn { 
      color: var(--error); 
      background: var(--error-light);
    }
    
    .delete-btn:hover { 
      color: #dc2626;
      background: #fecaca;
      transform: scale(1.05);
    }
    
    /* Tabela estilo Material atualizada */
    .list-table th {
      background: var(--primary-50);
      color: var(--primary);
      font-weight: 700;
      font-family: 'Inter', sans-serif;
    }
    
    .list-table tr:nth-child(even) {
      background: var(--accent-light);
    }
    
    .list-table tr:hover {
      background: var(--primary-50);
    }
    
    /* Responsividade e detalhes atualizados */
    @media (max-width: 768px) {
      .sidebar {
        box-shadow: var(--shadow-xl);
      }
    }
    
    @media (max-width: 1200px) {
      .dashboard-section > div {
        min-width: 220px;
      }
    }
    
    @media (max-width: 900px) {
      .dashboard-section > div {
        min-width: 180px;
      }
      .dashboard-section {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (max-width: 600px) {
      .dashboard-section {
        grid-template-columns: 1fr;
      }
      .dashboard-section > div {
        min-width: 100%;
        flex-direction: column;
        align-items: flex-start;
      }
    }
    
    .sidebar {
      border-top-right-radius: var(--radius-lg);
      border-bottom-right-radius: var(--radius-lg);
    }
    
    .main-content, .content-wrapper {
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
    }
    
    /* Cadastro responsivo e agrad√°vel atualizado */
    #create-section form {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 2rem 2.5rem;
      max-width: 600px;
      margin: 2rem auto;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      border: 1px solid var(--border);
    }
    
    #create-section .form-section {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 0;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    
    #create-section .form-section h2 {
      font-size: 1.125rem;
      color: var(--primary);
      margin-bottom: 1rem;
      font-weight: 700;
      letter-spacing: -0.025em;
      font-family: 'Poppins', sans-serif;
    }
    
    #create-section .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    
    #create-section .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    #create-section label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }
    
    #create-section input, #create-section select {
      padding: 0.875rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      background: var(--surface);
      transition: all var(--transition);
      outline: none;
      font-family: 'Inter', sans-serif;
      color: var(--text);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    #create-section select {
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }
    
    #create-section input:focus, #create-section select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-100), 0 1px 2px rgba(0, 0, 0, 0.05);
      background: var(--surface);
    }
    
    #create-section input:hover, #create-section select:hover {
      border-color: var(--border-dark);
    }
    
    /* Fixar tamanho dos campos Cluster e Categoria */
    #create-section #cluster,
    #create-section #categoria {
      width: 200px;
      min-width: 200px;
      max-width: 200px;
    }
    
    /* Estilo para campos desabilitados */
    #create-section #quantidade,
    #create-section #valorTotal {
      background-color: var(--bg-secondary) !important;
      color: var(--text-muted) !important;
      cursor: not-allowed !important;
      border-color: var(--border-light) !important;
    }
    
    #create-section #quantidade:focus,
    #create-section #valorTotal:focus {
      border-color: var(--border-light) !important;
      box-shadow: none !important;
      background-color: var(--bg-secondary) !important;
    }
    
    #create-section #quantidade:hover,
    #create-section #valorTotal:hover {
      border-color: var(--border-light) !important;
      background-color: var(--bg-secondary) !important;
    }
    
    #create-section textarea {
      font-family: 'Inter', sans-serif;
      line-height: 1.5;
    }
    
    #create-section textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-100);
    }
    
    #create-section textarea:hover {
      border-color: var(--border-dark);
    }
    
    /* Inputs de tamanhos responsivos e agrupados atualizados */
    #create-section .sizes-table {
      width: 100%;
      border: none;
      background: none;
      box-shadow: none;
      margin-top: 0.75rem;
      margin-bottom: 0;
      padding: 0;
    }
    
    #create-section .sizes-table thead {
      display: none;
    }
    
    #create-section .sizes-table tbody tr {
      display: flex;
      gap: 1rem;
      justify-content: flex-start;
      flex-wrap: wrap;
      background: none;
      border: none;
    }
    
    #create-section .sizes-table td {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      background: none;
      border: none;
      padding: 0;
      min-width: 80px;
      margin-bottom: 0.5rem;
    }
    
    #create-section .sizes-table label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }
    
    #create-section .sizes-table input {
      width: 100%;
      min-width: 0;
      padding: 0.75rem 0.75rem;
      font-size: 0.95rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface);
    }
    
    /* Estilos para a se√ß√£o de variedade de produto */
    .variedade-container {
      margin-top: 1rem;
    }
    
    .variedade-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .cor-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1rem;
      position: relative;
    }
    
    .cor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .cor-nome {
      font-weight: 600;
      color: var(--text);
      font-size: 1rem;
    }
    
    .remove-cor-btn {
      background: var(--error);
      color: white;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    
    .remove-cor-btn:hover {
      background: #dc2626;
    }
    
    .tamanhos-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.6rem;
    }
    
    .tamanho-item {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      min-width: 0;
    }
    
    .tamanho-item label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    
    .tamanho-item input {
      padding: 0.4rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.8rem;
      background: var(--surface);
      width: 100%;
      min-width: 0;
    }
    
    .tamanho-item input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-100);
    }
    
    @media (max-width: 1200px) {
      .tamanhos-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.8rem;
      }
    }
    
    @media (max-width: 768px) {
      .tamanhos-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.8rem;
      }
      
      .variedade-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
      }
      
      .variedade-header > div {
        flex-direction: column;
        gap: 0.8rem;
      }
      
      #nova-cor-input {
        min-width: 100% !important;
      }
    }
    
    @media (max-width: 480px) {
      .tamanhos-grid {
        grid-template-columns: 1fr;
        gap: 0.6rem;
      }
      
      .tamanho-item input {
        padding: 0.5rem;
        font-size: 0.9rem;
      }
    }
    
    #create-section .actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1rem;
    }
    
    #create-section .actions button {
      min-width: 140px;
      padding: 0.875rem 1.75rem;
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      transition: all var(--transition);
      font-family: 'Inter', sans-serif;
    }
    
    #create-section .actions button:first-child {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow);
    }
    
    #create-section .actions button:first-child:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    #create-section .actions button.secondary {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    
    #create-section .actions button.secondary:hover {
      background: var(--border-light);
      color: var(--text);
    }
    
    @media (max-width: 700px) {
      #create-section form {
        padding: 1rem;
        max-width: 98vw;
      }
      #create-section .form-row {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      #create-section .actions {
        flex-direction: column;
        gap: 0.8rem;
        align-items: stretch;
      }
    }
    
    /* Filtros de fichas cadastradas sempre em linha atualizados */
    #list-section .filtros-wrapper {
      display: flex;
      flex-direction: row;
      gap: 2rem;
      flex-wrap: nowrap;
      align-items: center;
      overflow-x: auto;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    
    #list-section .filtros-wrapper > div {
      display: flex;
      align-items: center;
      gap: 1rem;
      min-width: 220px;
    }
    
    @media (max-width: 700px) {
      #list-section .filtros-wrapper {
        gap: 1rem;
      }
      #list-section .filtros-wrapper > div {
        min-width: 180px;
      }
    }
    
    /* Cards do dashboard atualizados */
    .dashboard-section > div > div {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
      font-family: 'Poppins', sans-serif;
    }
    
    /* Estilos para os cards do dashboard */
    .backdrop-blur-md {
      backdrop-filter: blur(8px);
    }
    
    .bg-white\/60 {
      background-color: rgba(255, 255, 255, 0.6);
    }
    
    .dark\:bg-slate-800\/60 {
      background-color: rgba(30, 41, 59, 0.6);
    }
    
    .border-white\/20 {
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .dark\:border-slate-700\/40 {
      border-color: rgba(51, 65, 85, 0.4);
    }
    
    .text-blue-600 {
      color: var(--primary);
    }
    
    .bg-blue-100 {
      background-color: var(--primary-100);
    }
    
    .text-blue-700 {
      color: var(--primary-dark);
    }
    
    .text-slate-500 {
      color: var(--text-secondary);
    }
    
    .text-slate-700 {
      color: var(--text);
    }
    
    .dark\:text-white {
      color: white;
    }
    
    .border-slate-200 {
      border-color: var(--border);
    }
    
    .bg-white\/70 {
      background-color: rgba(255, 255, 255, 0.7);
    }
    
    .dark\:bg-slate-800\/60 {
      background-color: rgba(30, 41, 59, 0.6);
    }
    
    .text-slate-700 {
      color: var(--text);
    }
    
    .dark\:text-white {
      color: white;
    }
    
    .focus\:ring-2 {
      box-shadow: 0 0 0 3px var(--primary-100);
    }
    
    .focus\:ring-blue-400 {
      box-shadow: 0 0 0 3px var(--primary-200);
    }
    
    .bg-blue-50 {
      background-color: var(--primary-50);
    }
    
    .dark\:bg-slate-800\/60 {
      background-color: rgba(30, 41, 59, 0.6);
    }
    
    .text-blue-900 {
      color: var(--primary-dark);
    }
    
    .dark\:text-white {
      color: white;
    }
    
    .divide-slate-100 {
      border-color: var(--border-light);
    }
    
    .dark\:divide-slate-800 {
      border-color: rgba(30, 41, 59, 0.8);
    }
    
    /* Estilos para gr√°ficos animados */
    .chart-container {
      position: relative;
      transition: all 0.3s ease;
    }
    
    .chart-container:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .chart-title {
      margin-bottom: 1.5rem;
      color: var(--text);
      font-size: 1.25rem;
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .chart-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border-radius: 2px;
    }
    
    .chart-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--text-muted);
      font-style: italic;
    }
    
    .chart-no-data {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--text-muted);
      text-align: center;
      padding: 2rem;
    }
    
    .chart-no-data::before {
      content: 'üìä';
      font-size: 2rem;
      margin-bottom: 1rem;
      display: block;
    }
    
    /* Responsividade para bot√µes de a√ß√£o */
    @media (max-width: 768px) {
      .action-buttons {
        gap: 0.3rem;
      }
      
      .edit-btn, .delete-btn {
        min-width: 36px;
        height: 36px;
        font-size: 1.1rem;
        padding: 0.4rem;
      }
    }
    
    /* Estilos para filtros do dashboard */
    #dashboard-cluster-filter:focus,
    #dashboard-period-filter:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-100);
      outline: none;
    }
    
    #dashboard-cluster-filter:hover,
    #dashboard-period-filter:hover {
      border-color: var(--border-dark);
    }
    
    /* Responsividade para filtros do dashboard */
    @media (max-width: 768px) {
      #dashboard-section > div:first-child > div {
        flex-direction: column;
        gap: 1rem;
      }
      
      #dashboard-section > div:first-child > div > div {
        min-width: 100%;
      }
      
      #dashboard-section > div:first-child > div > div:last-child {
        justify-content: stretch;
      }
      
      #dashboard-section > div:first-child > div > div:last-child button {
        flex: 1;
        justify-content: center;
      }
    }
    
    @media (max-width: 480px) {
      .action-buttons {
        gap: 0.2rem;
      }
      
      .edit-btn, .delete-btn {
        min-width: 32px;
        height: 32px;
        font-size: 1rem;
        padding: 0.3rem;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar moderna -->
  <div id="sidebar" class="fixed z-40 left-0 top-0 h-full w-64 bg-white/70 dark:bg-slate-900/80 backdrop-blur-md border-r border-white/20 dark:border-slate-700/40 shadow-2xl transition-transform duration-300 transform -translate-x-full md:translate-x-0 flex flex-col">
    <div class="sidebar-header flex items-center gap-2 px-6 py-6 border-b border-white/20 dark:border-slate-700/40">
      <span class="material-icons text-blue-600 text-3xl">dashboard</span>
      <h1 class="font-poppins text-xl font-bold text-slate-800 dark:text-white tracking-wide">Follow Up</h1>
    </div>
    <nav class="sidebar-nav flex-1 flex flex-col gap-1 px-2 py-4">
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition hover:bg-blue-100/70 dark:hover:bg-slate-800/60 text-slate-700 dark:text-white font-medium" data-screen="dashboard">
        <span class="material-icons">bar_chart</span>
        <span>Dashboards</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition hover:bg-blue-100/70 dark:hover:bg-slate-800/60 text-slate-700 dark:text-white font-medium" data-screen="create">
        <span class="material-icons">add_circle</span>
        <span>Cadastrar</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition hover:bg-blue-100/70 dark:hover:bg-slate-800/60 text-slate-700 dark:text-white font-medium" data-screen="list">
        <span class="material-icons">dashboard</span>
        <span>Fichas</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition hover:bg-blue-100/70 dark:hover:bg-slate-800/60 text-slate-700 dark:text-white font-medium" data-screen="categorias">
        <span class="material-icons">category</span>
        <span>Categorias</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition hover:bg-blue-100/70 dark:hover:bg-slate-800/60 text-slate-700 dark:text-white font-medium" data-screen="clusters">
        <span class="material-icons">business</span>
        <span>Clusters</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition hover:bg-blue-100/70 dark:hover:bg-slate-800/60 text-slate-700 dark:text-white font-medium" data-screen="configuracoes">
        <span class="material-icons">settings</span>
        <span>Configura√ß√µes</span>
      </div>
      
      <!-- Separador -->
      <div class="flex-1"></div>
      
      <!-- Bot√£o de Logout -->
      <div class="border-t border-white/20 dark:border-slate-700/40 pt-4 mt-4">
        <div id="logout-button" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition hover:bg-red-100/70 dark:hover:bg-red-900/60 text-red-600 dark:text-red-400 font-medium">
          <span class="material-icons">logout</span>
          <span>Sair</span>
        </div>
      </div>
    </nav>
  </div>

  <!-- Bot√£o de menu mobile -->
  <button id="mobile-menu-toggle" class="fixed top-4 left-4 z-50 md:hidden bg-blue-600 text-white rounded-full p-3 shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
    <span class="material-icons">menu</span>
  </button>

  <div class="content-wrapper md:ml-64 transition-all duration-300">
    <div class="content-header">
      <!-- Lado esquerdo: T√≠tulo da p√°gina e informa√ß√µes da empresa -->
        <div style="display: flex; align-items: center; gap: 1rem;">
        <h2 id="page-title" style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--primary); letter-spacing: -0.025em; font-family: 'Poppins', sans-serif;">Dashboard de Produ√ß√£o</h2>
          <div id="empresa-info" style="display: none; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--primary-50); border: 1px solid var(--primary-200); border-radius: var(--radius); color: var(--primary-dark); font-size: 0.9rem; font-weight: 500;">
            <span class="material-icons" style="font-size: 1rem;">business</span>
            <span id="empresa-nome-display">Nome da Empresa</span>
        </div>
      </div>
      
      <!-- Lado direito: Informa√ß√µes da empresa e usu√°rio logado -->
      <div style="display: flex; align-items: center; gap: 1rem;">
        <!-- Informa√ß√µes da empresa -->
        <div id="empresa-menu-info" style="display: none; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; background: var(--success-50); border: 1px solid var(--success-200); border-radius: var(--radius); box-shadow: var(--shadow);">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <img id="empresa-menu-photo" src="" alt="Logo da empresa" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--success);" />
            <div style="display: flex; flex-direction: column; gap: 0.125rem;">
              <span id="empresa-menu-nome" style="font-weight: 600; color: var(--success-dark); font-size: 0.9rem;">Nome da Empresa</span>
              <span style="color: var(--success-secondary); font-size: 0.8rem;">Empresa Cadastrada</span>
            </div>
          </div>
        </div>
        
        <!-- Informa√ß√µes do usu√°rio logado -->
        <div id="user-info" style="display: none; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow);">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <img id="user-photo" src="" alt="Foto do usu√°rio" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary);" />
            <div style="display: flex; flex-direction: column; gap: 0.125rem;">
              <span id="user-name" style="font-weight: 600; color: var(--text); font-size: 0.9rem;">Nome do Usu√°rio</span>
              <span id="user-email" style="color: var(--text-secondary); font-size: 0.8rem;">email@exemplo.com</span>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; background: var(--primary-50); border-radius: 4px;">
            <span class="material-icons" style="font-size: 0.875rem; color: var(--primary);">verified</span>
            <span style="font-size: 0.75rem; color: var(--primary); font-weight: 500;">Logado</span>
          </div>
        </div>
      </div>
    </div>
    <div class="content-body">
      <section id="list-section" style="display: none;">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
          <div class="flex flex-wrap gap-4 items-center">
            <div class="flex items-center gap-3 min-w-[200px]">
              <label for="cluster-filter" class="font-medium text-gray-700 text-sm">Filtrar por Cluster:</label>
              <select id="cluster-filter" class="px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-primary outline-none text-sm">
                <option value="">Todos os Clusters</option>
              </select>
            </div>
            <div class="flex items-center gap-3 min-w-[200px]">
              <label for="categoria-filter" class="font-medium text-gray-700 text-sm">Filtrar por Categoria:</label>
              <select id="categoria-filter" class="px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-primary outline-none text-sm">
                <option value="">Todas as Categorias</option>
              </select>
            </div>
            <div class="flex items-center gap-3 min-w-[200px]">
              <label for="pagamento-filter" class="font-medium text-gray-700 text-sm">Pagamentos:</label>
              <select id="pagamento-filter" class="px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-primary outline-none text-sm">
                <option value="">Todos os Pagamentos</option>
                <option value="pago">Pago</option>
                <option value="nao-pago">N√£o Pago</option>
              </select>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <table class="min-w-[800px] w-full text-sm">
          <thead>
              <tr class="bg-gray-50 border-b border-gray-200">
                <th class="px-4 py-3 font-semibold text-gray-700 text-left">Cluster</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-left">Categoria</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-left">Refer√™ncia</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-center">Qtd. Pe√ßas</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-center">Valor Unit.</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-center">Valor Total</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-center">Pilotagem</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-center">Sa√≠da</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-center">Pagamento</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-center">A√ß√µes</th>
            </tr>
          </thead>
            <tbody id="fichas-list" class="divide-y divide-gray-100">
            <!-- Linhas din√¢micas -->
          </tbody>
        </table>
        </div>
      </section>
      <section id="create-section" style="display: none;">
        <form id="ficha-form" autocomplete="off">
          <div class="form-section">
            <h2>üóÇÔ∏è Informa√ß√µes Gerais</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="cluster">Cluster</label>
                <select id="cluster" required>
                  <option value="">Selecione um cluster</option>
                </select>
              </div>
              <div class="form-group">
                <label for="categoria">Categoria</label>
                <select id="categoria" required>
                  <option value="">Selecione uma categoria</option>
                </select>
              </div>
              <div class="form-group">
                <label for="referencia">Refer√™ncia</label>
                <input type="text" id="referencia" required />
              </div>
              <div class="form-group">
                <label for="quantidade">Quantidade de pe√ßas</label>
                <input type="number" id="quantidade" min="1" required disabled />
              </div>
              <div class="form-group">
                <label for="valorUnitario">Valor unit√°rio</label>
                <input type="number" id="valorUnitario" min="0" step="0.01" required onchange="calcularValorTotal()" />
              </div>
              <div class="form-group">
                <label for="valorTotal">Valor total</label>
                <input type="number" id="valorTotal" min="0" step="0.01" required readonly disabled />
              </div>
            </div>
          </div>
          <div class="form-section">
            <h2>üß™ Processos</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="saida">Data de Remessa</label>
                <input type="date" id="saida" required />
              </div>
              <div class="form-group">
                <label for="pilotagem">Pilotagem</label>
                <select id="pilotagem" required>
                  <option value="Sim">Sim</option>
                  <option value="N√£o">N√£o</option>
                </select>
              </div>
              <div class="form-group">
                <label for="entrada">Data de Recebimento</label>
                <input type="date" id="entrada" />
              </div>
              <div class="form-group">
                <label for="pagamento">Pagamento / data</label>
                <input type="date" id="pagamento" />
              </div>
            </div>
          </div>
          <div class="form-section">
            <h2>üé® Variedade de Produto</h2>
            <div class="variedade-container">
              <div class="variedade-header">
                <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.1rem; font-weight: 600;">Cores/Estampas</h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                  <input type="text" id="nova-cor-input" placeholder="Digite o nome da cor/estampa (ex: Branca)" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem; min-width: 250px;" />
                  <button type="button" id="add-cor-btn" style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                    <span class="material-icons" style="font-size: 1rem;">add</span>
                    Adicionar
                  </button>
                </div>
              </div>
              <div id="cores-container">
                <!-- Cores ser√£o adicionadas dinamicamente aqui -->
              </div>
            </div>
          </div>
          <div class="form-section">
            <h2>üìù Observa√ß√µes</h2>
            <div class="form-row">
              <div class="form-group" style="flex: 1 1 100%;">
                <textarea id="observacoes" rows="4" placeholder="Digite observa√ß√µes adicionais sobre a ficha (opcional)" style="width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.95rem; background: var(--surface); transition: all var(--transition); outline: none; font-family: 'Inter', sans-serif; color: var(--text); resize: vertical; min-height: 100px;"></textarea>
              </div>
            </div>
          </div>
          <div class="actions">
            <button type="submit">Cadastrar</button>
            <button type="button" class="secondary" id="cancelar-btn">Cancelar</button>
          </div>
        </form>
      </section>
      <section id="dashboard-section" style="display: block;">
        <!-- Filtros do Dashboard -->
        <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 2rem;">
          <div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 0.5rem; min-width: 200px;">
              <label for="dashboard-cluster-filter" style="font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif; font-size: 0.9rem; white-space: nowrap;">Cluster:</label>
              <select id="dashboard-cluster-filter" style="flex: 1; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition); font-size: 0.9rem;">
                <option value="">Todos os Clusters</option>
              </select>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; min-width: 200px;">
              <label for="dashboard-period-filter" style="font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif; font-size: 0.9rem; white-space: nowrap;">Per√≠odo:</label>
              <select id="dashboard-period-filter" style="flex: 1; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition); font-size: 0.9rem;">
                <option value="">Todos os Per√≠odos</option>
                <option value="7">√öltimos 7 dias</option>
                <option value="30">√öltimos 30 dias</option>
                <option value="90">√öltimos 90 dias</option>
                <option value="180">√öltimos 6 meses</option>
                <option value="365">√öltimo ano</option>
              </select>
            </div>
            <div style="display: flex; gap: 0.75rem; align-items: center;">
              <button onclick="applyDashboardFilters()" style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; box-shadow: var(--shadow); display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem;">filter_alt</span>
                Aplicar
              </button>
              <button onclick="clearDashboardFilters()" style="background: var(--bg-secondary); color: var(--text); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem;">clear</span>
                Limpar
              </button>
              <button onclick="showDashboardReport()" style="background: var(--success); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; box-shadow: var(--shadow); display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem;">assessment</span>
                Relat√≥rio
              </button>
            </div>
          </div>
        </div>

        <!-- Resumo T√©cnico -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-primary-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-primary">inventory_2</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="total-pecas">0</div>
              <div class="text-gray-600 text-sm font-medium">Total de Pe√ßas Produzidas</div>
            </div>
          </div>
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-primary-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-primary">assignment</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="total-fichas">0</div>
              <div class="text-gray-600 text-sm font-medium">Total de Fichas Cadastradas</div>
            </div>
          </div>
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-green-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-green-600">attach_money</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="total-valor">R$ 0,00</div>
              <div class="text-gray-600 text-sm font-medium">Valor Total Produzido</div>
            </div>
          </div>
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-blue-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-blue-600">groups</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="total-clusters">0</div>
              <div class="text-gray-600 text-sm font-medium">Clusters Ativos</div>
            </div>
          </div>
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-purple-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-purple-600">category</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="total-categorias">0</div>
              <div class="text-gray-600 text-sm font-medium">Categorias Utilizadas</div>
            </div>
          </div>
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-orange-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-orange-600">trending_up</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="media-valor">R$ 0,00</div>
              <div class="text-gray-600 text-sm font-medium">Valor M√©dio por Ficha</div>
            </div>
          </div>
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-indigo-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-indigo-600">format_list_numbered</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="media-pecas">0</div>
              <div class="text-gray-600 text-sm font-medium">M√©dia de Pe√ßas por Ficha</div>
            </div>
          </div>

          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-teal-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-teal-600">monetization_on</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="valor-medio-peca">R$ 0,00</div>
              <div class="text-gray-600 text-sm font-medium">Valor M√©dio por Pe√ßa</div>
            </div>
          </div>
        </div>

        <!-- Gr√°ficos -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
          <!-- Gr√°fico de Pizza -->
          <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.25rem; font-weight: 600; font-family: 'Poppins', sans-serif;">Produ√ß√£o por Cluster</h3>
            <div style="display: flex; justify-content: center;">
              <canvas id="pieChart" width="300" height="300"></canvas>
            </div>
            <div id="chart-legend" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 0.75rem; margin-top: 1.5rem;"></div>
          </div>

          <!-- Gr√°fico de Linha -->
          <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.25rem; font-weight: 600; font-family: 'Poppins', sans-serif;">Produ√ß√£o por Per√≠odo</h3>
            <div style="display: flex; justify-content: center;">
              <canvas id="lineChart" width="300" height="300"></canvas>
            </div>
          </div>
        </div>
        <!-- Gr√°ficos de Categoria e Tempo de Produ√ß√£o lado a lado -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;" class="dashboard-charts-grid">
          <!-- Gr√°fico de Pizza por Categoria -->
          <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.25rem; font-weight: 600; font-family: 'Poppins', sans-serif;">Quantidade de Pe√ßas por Categoria</h3>
            <div style="display: flex; justify-content: center;">
              <canvas id="pieCategoriaChart" width="320" height="320"></canvas>
            </div>
            <div id="pie-categoria-legend" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 0.75rem; margin-top: 1.5rem;"></div>
          </div>
          
          <!-- Gr√°fico de Tempo de Produ√ß√£o -->
          <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.25rem; font-weight: 600; font-family: 'Poppins', sans-serif;">Tempo de Produ√ß√£o (dias)</h3>
            <div style="display: flex; justify-content: center;">
              <canvas id="tempoProducaoChart" width="320" height="320"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section id="configuracoes-section" style="display: none;">
        <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem; max-width: 600px;">
          <!-- Configura√ß√µes Gerais -->
          <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--primary); font-size: 1.25rem;">settings</span>
              Configura√ß√µes Gerais
            </h3>
            

            
            <!-- Visualiza√ß√£o das Informa√ß√µes da Empresa -->
            <div id="empresa-info-display" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: var(--primary-50); border: 1px solid var(--primary-200); border-radius: var(--radius);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                <h4 style="color: var(--primary-dark); font-weight: 600; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                  <span class="material-icons" style="font-size: 1.25rem;">business</span>
                  Informa√ß√µes da Empresa
                </h4>
                <div style="display: flex; gap: 0.5rem;">
                  <button type="button" onclick="editarEmpresa()" style="background: var(--primary); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
                    <span class="material-icons" style="font-size: 1rem;">edit</span>
                    Editar
                  </button>
                  <button type="button" onclick="excluirEmpresa()" style="background: var(--error); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
                    <span class="material-icons" style="font-size: 1rem;">delete</span>
                    Excluir
                  </button>
                  <button type="button" onclick="testarCarregamentoEmpresa()" style="background: var(--info); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
                    <span class="material-icons" style="font-size: 1rem;">bug_report</span>
                    Testar
                  </button>
                  <button type="button" onclick="forcarExibicaoEmpresa()" style="background: var(--warning); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
                    <span class="material-icons" style="font-size: 1rem;">visibility</span>
                    For√ßar
                  </button>
                </div>
                </div>
              
              <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; align-items: start;">
                <!-- Logo da Empresa -->
                <div style="text-align: center;">
                  <div id="empresa-logo-display" style="width: 100px; height: 100px; margin: 0 auto; border: 2px solid var(--primary-200); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; background: white; box-shadow: var(--shadow);">
                    <img id="empresa-logo-img" src="" alt="Logo da empresa" style="max-width: 100%; max-height: 100%; border-radius: var(--radius); display: none; object-fit: cover;" />
                    <span id="empresa-logo-placeholder" class="material-icons" style="color: var(--text-muted); font-size: 2.5rem;">business</span>
              </div>
                  <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">Logo da Empresa</p>
                </div>
                
                <!-- Informa√ß√µes da Empresa -->
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                  <div style="padding: 0.75rem; background: white; border-radius: var(--radius); border: 1px solid var(--border-light);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <span class="material-icons" style="color: var(--primary); font-size: 1rem;">business</span>
                      <strong style="color: var(--text); font-size: 0.9rem;">Nome da Empresa</strong>
                </div>
                    <span id="empresa-nome-display-info" style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 500;">-</span>
              </div>
                  
                  <div style="padding: 0.75rem; background: white; border-radius: var(--radius); border: 1px solid var(--border-light);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <span class="material-icons" style="color: var(--primary); font-size: 1rem;">receipt</span>
                      <strong style="color: var(--text); font-size: 0.9rem;">CNPJ</strong>
                    </div>
                    <span id="empresa-cnpj-display-info" style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 500;">-</span>
                  </div>
                  
                  <div style="padding: 0.75rem; background: white; border-radius: var(--radius); border: 1px solid var(--border-light);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <span class="material-icons" style="color: var(--primary); font-size: 1rem;">location_on</span>
                      <strong style="color: var(--text); font-size: 0.9rem;">Endere√ßo</strong>
                    </div>
                    <span id="empresa-endereco-display-info" style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 500;">-</span>
                  </div>
                  
                  <div style="padding: 0.75rem; background: white; border-radius: var(--radius); border: 1px solid var(--border-light);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <span class="material-icons" style="color: var(--primary); font-size: 1rem;">phone</span>
                      <strong style="color: var(--text); font-size: 0.9rem;">Telefone</strong>
                    </div>
                    <span id="empresa-telefone-display-info" style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 500;">-</span>
                  </div>
                </div>
              </div>
            </div>
            

            
            <style>
              #config-form input:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 3px var(--primary-100);
                outline: none;
              }
              #config-form input:hover {
                border-color: var(--border-dark);
              }
              #config-form button:hover {
                background: var(--primary-dark);
                transform: translateY(-1px);
                box-shadow: var(--shadow-lg);
              }
              
              /* Estilos para o campo de foto */
              #empresa-foto-preview {
                object-fit: cover;
                width: 100%;
                height: 100%;
              }
              
              #empresa-foto-preview:not([src=""]) {
                display: block !important;
              }
              
              #empresa-foto-preview:not([src=""]) + #empresa-foto-placeholder {
                display: none !important;
              }
              
              #foto-upload-area:hover {
                border-color: var(--primary);
                background: var(--primary-50);
                transform: scale(1.02);
              }
              
              #foto-upload-area {
                transition: all 0.3s ease;
              }
              
              #foto-progress {
                border-radius: 0 0 var(--radius) var(--radius);
                overflow: hidden;
              }
              
              #foto-progress-bar {
                transition: width 0.3s ease;
                background: linear-gradient(90deg, var(--primary), var(--primary-dark));
              }
              
              #foto-loading {
                backdrop-filter: blur(2px);
                animation: pulse 1.5s infinite;
              }
              
              @keyframes pulse {
                0%, 100% { opacity: 0.7; }
                50% { opacity: 1; }
              }
              
              #foto-status {
                animation: slideIn 0.3s ease;
              }
              
              @keyframes slideIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
              }
              
              /* Estilos para os bot√µes de imagem */
              #empresa-foto + div button:hover {
                transform: translateY(-1px);
                box-shadow: var(--shadow-md);
              }
              
              #empresa-foto + div button:active {
                transform: translateY(0);
              }
              
              /* Estilos para os bot√µes de a√ß√£o da empresa */
              #empresa-info-display button:hover {
                transform: translateY(-1px);
                box-shadow: var(--shadow-md);
              }
              
              #empresa-info-display button:active {
                transform: translateY(0);
              }
              
              /* Estilos para o formul√°rio de clusters */
              #cluster-form input:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 3px var(--primary-100);
                outline: none;
              }
              #cluster-form input:hover {
                border-color: var(--border-dark);
              }
              #cluster-form button:hover {
                background: var(--primary-dark);
                transform: translateY(-1px);
                box-shadow: var(--shadow-lg);
              }
            </style>
            </form>
          </div>
          
          <!-- Backup e Restaura√ß√£o -->
          <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--primary); font-size: 1.25rem;">backup</span>
              Backup e Restaura√ß√£o
            </h3>
            <p style="color: var(--muted); margin-bottom: 1rem; font-size: 0.85rem; line-height: 1.4;">Fa√ßa backup dos seus dados ou restaure de um arquivo anterior.</p>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
              <button onclick="exportarDados()" style="background: var(--primary); color: white; border: none; padding: 0.75rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem;">download</span>
                Exportar Dados
              </button>
              <button onclick="importarDados()" style="background: var(--bg-secondary); color: var(--text); border: 1px solid var(--border); padding: 0.75rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem;">upload</span>
                Importar Dados
              </button>
            </div>
            <input type="file" id="import-file" accept=".json" style="display: none;" />
          </div>
          
          <!-- Limpeza de Dados -->
          <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--error); font-size: 1.25rem;">delete_forever</span>
              Limpeza de Dados
            </h3>
            <p style="color: var(--muted); margin-bottom: 1rem; font-size: 0.85rem; line-height: 1.4;">A√ß√µes irrevers√≠veis. Use com cuidado.</p>
            <button onclick="limparTodosDados()" style="background: var(--error); color: white; border: none; padding: 0.75rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9rem; width: 100%;">
              <span class="material-icons" style="font-size: 1rem;">delete_sweep</span>
              Limpar Todos os Dados
            </button>
          </div>
          
          <!-- Informa√ß√µes do Sistema -->
          <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--primary); font-size: 1.25rem;">info</span>
              Informa√ß√µes do Sistema
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.85rem;">
              <div>
                <p style="color: var(--text-secondary); margin-bottom: 0.5rem; font-family: 'Inter', sans-serif;"><strong style="color: var(--text);">Vers√£o:</strong> 1.0.0</p>
                <p style="color: var(--text-secondary); margin-bottom: 0.5rem; font-family: 'Inter', sans-serif;"><strong style="color: var(--text);">Desenvolvido por:</strong> Follow Up</p>
              </div>
              <div>
                <p style="color: var(--text-secondary); margin-bottom: 0.5rem; font-family: 'Inter', sans-serif;"><strong style="color: var(--text);">Total de fichas:</strong> <span id="total-fichas-config">0</span></p>
                <p style="color: var(--text-secondary); margin-bottom: 0.5rem; font-family: 'Inter', sans-serif;"><strong style="color: var(--text);">Espa√ßo usado:</strong> <span id="espaco-usado">0 KB</span></p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal de Edi√ß√£o -->
  <div class="modal-overlay" id="edit-modal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3>Editar Ficha</h3>
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="edit-form">
          <div class="form-section">
            <h2>üóÇÔ∏è Informa√ß√µes Gerais</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="edit-cluster">Cluster</label>
                <select id="edit-cluster" required>
                  <option value="">Selecione um cluster</option>
                </select>
              </div>
              <div class="form-group">
                <label for="edit-categoria">Categoria</label>
                <select id="edit-categoria" required>
                  <option value="">Selecione uma categoria</option>
                </select>
              </div>
              <div class="form-group">
                <label for="edit-referencia">Refer√™ncia</label>
                <input type="text" id="edit-referencia" required />
              </div>
              <div class="form-group">
                <label for="edit-quantidade">Quantidade de pe√ßas</label>
                <input type="number" id="edit-quantidade" min="1" required disabled />
              </div>
              <div class="form-group">
                <label for="edit-valorUnitario">Valor unit√°rio</label>
                <input type="number" id="edit-valorUnitario" min="0" step="0.01" required onchange="calcularValorTotalEdit()" />
              </div>
              <div class="form-group">
                <label for="edit-valorTotal">Valor total</label>
                <input type="number" id="edit-valorTotal" min="0" step="0.01" required readonly disabled />
              </div>
            </div>
          </div>
          <div class="form-section">
            <h2>üß™ Processos</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="edit-saida">Data de Remessa</label>
                <input type="date" id="edit-saida" required />
              </div>
              <div class="form-group">
                <label for="edit-pilotagem">Pilotagem</label>
                <select id="edit-pilotagem" required>
                  <option value="Sim">Sim</option>
                  <option value="N√£o">N√£o</option>
                </select>
              </div>
              <div class="form-group">
                <label for="edit-entrada">Data de Recebimento</label>
                <input type="date" id="edit-entrada" />
              </div>
              <div class="form-group">
                <label for="edit-pagamento">Pagamento / data</label>
                <input type="date" id="edit-pagamento" />
              </div>
            </div>
          </div>
          <div class="form-section">
            <h2>üé® Variedade de Produto</h2>
            <div class="variedade-container">
              <div class="variedade-header">
                <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.1rem; font-weight: 600;">Cores/Estampas</h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                  <input type="text" id="edit-nova-cor-input" placeholder="Digite o nome da cor/estampa (ex: Branca)" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem; min-width: 250px;" />
                  <button type="button" id="edit-add-cor-btn" style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                    <span class="material-icons" style="font-size: 1rem;">add</span>
                    Adicionar
                  </button>
                </div>
              </div>
              <div id="edit-cores-container">
                <!-- Cores ser√£o adicionadas dinamicamente aqui -->
              </div>
            </div>
          </div>
          <div class="form-section">
            <h2>üìù Observa√ß√µes</h2>
            <div class="form-row">
              <div class="form-group" style="flex: 1 1 100%;">
                <label for="edit-observacoes">Observa√ß√µes</label>
                <textarea id="edit-observacoes" rows="4" placeholder="Digite observa√ß√µes adicionais sobre a ficha (opcional)" style="width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.95rem; background: var(--surface); transition: all var(--transition); outline: none; font-family: 'Inter', sans-serif; color: var(--text); resize: vertical; min-height: 100px;"></textarea>
              </div>
            </div>
          </div>
          <div class="actions">
            <button type="submit">Salvar Altera√ß√µes</button>
            <button type="button" class="secondary" onclick="closeEditModal()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de Detalhes -->
  <div class="modal-overlay" id="details-modal" style="display: none;">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>Detalhes da Ficha</h3>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button onclick="exportFichaToPDF()" style="background: var(--success); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
            <span class="material-icons" style="font-size: 1rem;">download</span>
            Exportar PDF
          </button>
          <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="ficha-details-content">
          <!-- Conte√∫do ser√° preenchido dinamicamente -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Relat√≥rio do Dashboard -->
  <div class="modal-overlay" id="report-modal" style="display: none;">
    <div class="modal" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>Relat√≥rio Detalhado - Dashboard de Produ√ß√£o</h3>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button onclick="exportReportToPDF()" style="background: var(--success); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
            <span class="material-icons" style="font-size: 1rem;">download</span>
            Exportar PDF
          </button>
          <button class="modal-close" onclick="closeReportModal()">&times;</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="report-content">
          <!-- Conte√∫do ser√° preenchido dinamicamente -->
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Global -->
  <div id="global-loading" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); display: flex; flex-direction: column; align-items: center; gap: 1rem; min-width: 200px;">
      <div style="width: 40px; height: 40px; border: 4px solid var(--bg-secondary); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <p style="margin: 0; color: var(--text); font-weight: 600; font-family: 'Inter', sans-serif;">Processando...</p>
    </div>
  </div>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <script>
    // Fun√ß√µes de loading global
    function showGlobalLoading() {
      const loading = document.getElementById('global-loading');
      if (loading) {
        loading.style.display = 'flex';
      }
    }

    function hideGlobalLoading() {
      const loading = document.getElementById('global-loading');
      if (loading) {
        loading.style.display = 'none';
      }
    }

    // Fun√ß√£o para converter arquivo para base64
    function convertFileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Fun√ß√£o para testar localStorage
    function testLocalStorage() {
      try {
        const testKey = 'test_' + Date.now();
        const testValue = 'test_value_' + Date.now();
        
        localStorage.setItem(testKey, testValue);
        const retrievedValue = localStorage.getItem(testKey);
        localStorage.removeItem(testKey);
        
        return retrievedValue === testValue;
      } catch (error) {
        console.error('Erro ao testar localStorage:', error);
        return false;
      }
    }

    // Verifica√ß√£o de login robusta para Firefox
    async function checkLogin() {
      try {
        console.log('Iniciando verifica√ß√£o de login...');
        
        // Primeiro, tentar verificar Firebase Auth
        if (window.FirebaseAuth) {
          try {
            console.log('üîÑ Verificando Firebase Auth...');
            const currentUser = await window.FirebaseAuth.getCurrentUser();
            
            if (currentUser) {
              console.log('‚úÖ Usu√°rio autenticado no Firebase:', currentUser.email);
              
              // Salvar dados no localStorage para compatibilidade
              try {
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUser', currentUser.email);
                localStorage.setItem('loginTimestamp', Date.now().toString());
                localStorage.setItem('userDisplayName', currentUser.displayName || currentUser.email);
                localStorage.setItem('userPhotoURL', currentUser.photoURL || '');
              } catch (localError) {
                console.log('‚ö†Ô∏è N√£o foi poss√≠vel salvar no localStorage:', localError);
              }
              
              return true;
            } else {
              console.log('‚ùå Usu√°rio n√£o autenticado no Firebase');
            }
          } catch (firebaseError) {
            console.error('‚ùå Erro ao verificar Firebase Auth:', firebaseError);
          }
        }
        
        // Fallback para verifica√ß√£o local
        console.log('üîÑ Verificando login local...');
        
        // Verificar se localStorage est√° dispon√≠vel
        if (typeof localStorage === 'undefined') {
          console.error('localStorage n√£o est√° dispon√≠vel');
          redirectToLogin();
          return false;
        }
        
        // Testar localStorage primeiro
        if (!testLocalStorage()) {
          console.error('localStorage n√£o est√° funcionando corretamente');
          redirectToLogin();
          return false;
        }
        
        // Verificar dados de login no localStorage
        let isLoggedIn = localStorage.getItem('isLoggedIn');
        let currentUser = localStorage.getItem('currentUser');
        let loginTimestamp = localStorage.getItem('loginTimestamp');
        
        console.log('Verifica√ß√£o localStorage:', { isLoggedIn, currentUser, loginTimestamp });
        
        // Se localStorage falhou, tentar sessionStorage
        if (!isLoggedIn || isLoggedIn !== 'true' || !currentUser) {
          console.log('localStorage falhou, tentando sessionStorage...');
          
          if (typeof sessionStorage !== 'undefined') {
            const sessionLogin = sessionStorage.getItem('isLoggedIn');
            const sessionUser = sessionStorage.getItem('currentUser');
            const sessionTimestamp = sessionStorage.getItem('loginTimestamp');
            
            console.log('Verifica√ß√£o sessionStorage:', { sessionLogin, sessionUser, sessionTimestamp });
            
            if (sessionLogin === 'true' && sessionUser) {
              console.log('Login encontrado no sessionStorage');
              // Migrar para localStorage se poss√≠vel
              try {
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUser', sessionUser);
                localStorage.setItem('loginTimestamp', sessionTimestamp || Date.now().toString());
                console.log('Dados migrados para localStorage');
              } catch (migrationError) {
                console.log('N√£o foi poss√≠vel migrar para localStorage, continuando com sessionStorage');
              }
              return true;
            }
          }
          
          // Se ambos falharam, tentar verificar novamente ap√≥s delay
          console.log('Ambas verifica√ß√µes falharam, tentando novamente ap√≥s delay...');
          
          setTimeout(() => {
            const retryLocalLogin = localStorage.getItem('isLoggedIn');
            const retryLocalUser = localStorage.getItem('currentUser');
            const retrySessionLogin = sessionStorage.getItem('isLoggedIn');
            const retrySessionUser = sessionStorage.getItem('currentUser');
            
            console.log('Verifica√ß√£o ap√≥s delay:', {
              localStorage: { login: retryLocalLogin, user: retryLocalUser },
              sessionStorage: { login: retrySessionLogin, user: retrySessionUser }
            });
            
            if ((retryLocalLogin === 'true' && retryLocalUser) || 
                (retrySessionLogin === 'true' && retrySessionUser)) {
              console.log('Login encontrado ap√≥s delay');
            } else {
              console.log('Login n√£o encontrado ap√≥s delay, redirecionando...');
              redirectToLogin();
            }
          }, 500);
          
          return false;
        }
        
        console.log('Usu√°rio logado via localStorage, continuando...');
        return true;
      } catch (error) {
        console.error('Erro ao verificar login:', error);
        redirectToLogin();
        return false;
      }
    }
    
    // Fun√ß√£o para redirecionar para login
    function redirectToLogin() {
      // Adicionar timestamp para evitar cache
      const timestamp = Date.now();
      const loginUrl = `index.html?t=${timestamp}&redirected=true`;
      
      console.log('Redirecionando para login:', loginUrl);
      
      // Pequeno delay para garantir que tudo foi processado
      setTimeout(() => {
        window.location.href = loginUrl;
      }, 100);
    }

    // Fun√ß√£o de logout
    async function logout() {
      try {
        console.log('üîÑ Iniciando logout...');
        
        // Logout do Firebase Auth
        if (window.FirebaseAuth) {
          console.log('üîÑ Fazendo logout do Firebase Auth...');
          await window.FirebaseAuth.signOutUser();
          console.log('‚úÖ Logout do Firebase realizado com sucesso');
        } else {
          console.log('‚ö†Ô∏è FirebaseAuth n√£o dispon√≠vel, pulando logout do Firebase');
        }
        
        // Limpar localStorage
        console.log('üîÑ Limpando localStorage...');
        const keysToRemove = [
          'isLoggedIn',
          'currentUser', 
          'loginTimestamp',
          'userDisplayName',
          'userPhotoURL'
        ];
        
        keysToRemove.forEach(key => {
          try {
            localStorage.removeItem(key);
            console.log(`‚úÖ Removido do localStorage: ${key}`);
          } catch (error) {
            console.error(`‚ùå Erro ao remover ${key} do localStorage:`, error);
          }
        });
        
        // Limpar sessionStorage tamb√©m
        if (typeof sessionStorage !== 'undefined') {
          console.log('üîÑ Limpando sessionStorage...');
          keysToRemove.forEach(key => {
            try {
              sessionStorage.removeItem(key);
              console.log(`‚úÖ Removido do sessionStorage: ${key}`);
            } catch (error) {
              console.error(`‚ùå Erro ao remover ${key} do sessionStorage:`, error);
            }
          });
        }
        
        console.log('‚úÖ Logout realizado, todos os dados limpos');
        
        // Pequeno delay para garantir que tudo foi processado
        setTimeout(() => {
          console.log('üîÑ Redirecionando para p√°gina de login...');
          const timestamp = Date.now();
          const loginUrl = `index.html?t=${timestamp}&logout=true`;
          window.location.href = loginUrl;
        }, 500);
        
      } catch (error) {
        console.error('‚ùå Erro ao fazer logout:', error);
        console.error('‚ùå Detalhes do erro:', error.message);
        
        // Mesmo com erro, limpar dados locais e redirecionar
        console.log('üîÑ Limpando dados locais mesmo com erro...');
        try {
          localStorage.removeItem('isLoggedIn');
          localStorage.removeItem('currentUser');
          localStorage.removeItem('loginTimestamp');
          localStorage.removeItem('userDisplayName');
          localStorage.removeItem('userPhotoURL');
        } catch (localError) {
          console.error('‚ùå Erro ao limpar localStorage:', localError);
        }
        
        // Redirecionar mesmo com erro
        setTimeout(() => {
          console.log('üîÑ Redirecionando para login mesmo com erro...');
          const timestamp = Date.now();
          const loginUrl = `index.html?t=${timestamp}&logout=true&error=true`;
          window.location.href = loginUrl;
        }, 1000);
      }
    }

    // Verificar login ap√≥s o DOM estar carregado
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('DOM carregado, verificando login...');
      
      // Verificar se localStorage est√° dispon√≠vel
      if (typeof localStorage === 'undefined') {
        console.error('localStorage n√£o est√° dispon√≠vel');
        redirectToLogin();
        return;
      }
      
      // Verificar se foi redirecionado do login
      const urlParams = new URLSearchParams(window.location.search);
      const redirected = urlParams.get('redirected');
      const user = urlParams.get('user');
      const firefox = urlParams.get('firefox');
      
      if (redirected === 'true' && user) {
        console.log('Usu√°rio redirecionado do login:', user);
        // Verificar se o login foi salvo corretamente
        const savedLogin = localStorage.getItem('isLoggedIn');
        const savedUser = localStorage.getItem('currentUser');
        
        if (savedLogin === 'true' && savedUser === user) {
          console.log('Login verificado ap√≥s redirecionamento');
        } else {
          console.log('Login n√£o encontrado ap√≥s redirecionamento, salvando...');
          localStorage.setItem('isLoggedIn', 'true');
          localStorage.setItem('currentUser', user);
          localStorage.setItem('loginTimestamp', Date.now().toString());
        }
      }
      
      // Verifica√ß√£o espec√≠fica para Firefox
      if (firefox === 'true' && user) {
        console.log('Detectado redirecionamento do Firefox, verificando login...');
        
        // Verificar localStorage primeiro
        let savedLogin = localStorage.getItem('isLoggedIn');
        let savedUser = localStorage.getItem('currentUser');
        
        if (savedLogin === 'true' && savedUser === user) {
          console.log('Login encontrado no localStorage');
        } else {
          // Verificar sessionStorage
          const sessionLogin = sessionStorage.getItem('isLoggedIn');
          const sessionUser = sessionStorage.getItem('currentUser');
          
          if (sessionLogin === 'true' && sessionUser === user) {
            console.log('Login encontrado no sessionStorage, migrando para localStorage...');
            try {
              localStorage.setItem('isLoggedIn', 'true');
              localStorage.setItem('currentUser', user);
              localStorage.setItem('loginTimestamp', Date.now().toString());
            } catch (error) {
              console.log('N√£o foi poss√≠vel migrar para localStorage');
            }
          } else {
            console.log('Login n√£o encontrado, salvando...');
            try {
              localStorage.setItem('isLoggedIn', 'true');
              localStorage.setItem('currentUser', user);
              localStorage.setItem('loginTimestamp', Date.now().toString());
            } catch (error) {
              console.log('Falha ao salvar no localStorage, tentando sessionStorage...');
              sessionStorage.setItem('isLoggedIn', 'true');
              sessionStorage.setItem('currentUser', user);
              sessionStorage.setItem('loginTimestamp', Date.now().toString());
            }
          }
        }
      }
      
      const isLoggedIn = await checkLogin();
      if (!isLoggedIn) {
        return; // A fun√ß√£o checkLogin j√° redireciona se necess√°rio
      }
      
      // Exibir informa√ß√µes do usu√°rio logado
      try {
        await updateUserInfo();
      } catch (error) {
        console.error('Erro ao exibir informa√ß√µes do usu√°rio:', error);
      }
      
      // Carregar dados do Firebase
      console.log('üîÑ Iniciando carregamento do Firebase...');
      waitForFirebaseAuth().then(() => {
        console.log('‚úÖ Carregamento do Firebase conclu√≠do');
      }).catch(error => {
        console.error('‚ùå Erro no carregamento do Firebase:', error);
      });
      
      // Adicionar event listener para o bot√£o de logout
      const logoutButton = document.getElementById('logout-button');
      if (logoutButton) {
        console.log('‚úÖ Bot√£o de logout encontrado, adicionando event listener...');
        logoutButton.addEventListener('click', async () => {
          try {
            console.log('üîÑ Bot√£o de logout clicado...');
            
            // Feedback visual - desabilitar bot√£o
            const originalText = logoutButton.innerHTML;
            logoutButton.innerHTML = `
              <span class="material-icons">hourglass_empty</span>
              <span>Saindo...</span>
            `;
            logoutButton.style.pointerEvents = 'none';
            logoutButton.style.opacity = '0.7';
            
            // Executar logout
            await logout();
            
          } catch (error) {
            console.error('‚ùå Erro ao fazer logout:', error);
            console.error('‚ùå Detalhes do erro:', error.message);
            
            // Restaurar bot√£o em caso de erro
            logoutButton.innerHTML = `
              <span class="material-icons">logout</span>
              <span>Sair</span>
            `;
            logoutButton.style.pointerEvents = 'auto';
            logoutButton.style.opacity = '1';
            
            // Mesmo com erro, redirecionar para login
            setTimeout(() => {
              console.log('üîÑ Redirecionando para login ap√≥s erro...');
              const timestamp = Date.now();
              const loginUrl = `index.html?t=${timestamp}&logout=true&error=true`;
              window.location.href = loginUrl;
            }, 1000);
          }
        });
        console.log('‚úÖ Event listener do logout adicionado com sucesso');
      } else {
        console.error('‚ùå Bot√£o de logout n√£o encontrado');
      }
    });

    // Navega√ß√£o entre telas
    const sidebar = document.getElementById('sidebar');
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const navItems = document.querySelectorAll('.nav-item');
    const pageTitle = document.getElementById('page-title');
    const listSection = document.getElementById('list-section');
    const createSection = document.getElementById('create-section');
    const dashboardSection = document.getElementById('dashboard-section');
    const configuracoesSection = document.getElementById('configuracoes-section');
    const fichaForm = document.getElementById('ficha-form');
    const editForm = document.getElementById('edit-form');
    const editModal = document.getElementById('edit-modal');
    const cancelarBtn = document.getElementById('cancelar-btn');
    const fichasList = document.getElementById('fichas-list');
    const fichasTable = document.getElementById('fichas-table');
    const clusterFilter = document.getElementById('cluster-filter');
    const categoriaFilter = document.getElementById('categoria-filter');
    const configForm = document.getElementById('config-form');

    let fichas = [];
    let filteredFichas = [];
    let editingIndex = -1;
    
    // Vari√°veis para gerenciar cores no modal de edi√ß√£o
    let editCoresArray = [];
    let editCorCounter = 0;
    
    // Fun√ß√£o para carregar fichas do Firebase
    async function loadFichasFromFirebase() {
      try {
        console.log('üîÑ Carregando fichas do Firebase...');
        
        if (window.FirebaseAuth) {
          console.log('‚úÖ FirebaseAuth dispon√≠vel, verificando usu√°rio...');
          
          // Verificar se h√° usu√°rio autenticado
          const currentUser = await window.FirebaseAuth.getCurrentUser();
          console.log('üë§ Usu√°rio atual:', currentUser ? currentUser.email : 'N√£o autenticado');
          
          if (!currentUser) {
            console.error('‚ùå Usu√°rio n√£o autenticado');
            // Fallback para localStorage
            fichas = JSON.parse(localStorage.getItem('fichas') || '[]');
            filteredFichas = [...fichas];
            return;
          }
          
          const firebaseFichas = await window.FirebaseAuth.getFichas();
          fichas = firebaseFichas || [];
          filteredFichas = [...fichas];
          
          console.log('‚úÖ Fichas carregadas do Firebase:', fichas.length);
          console.log('‚úÖ Fichas filtradas:', filteredFichas.length);
          console.log('üìä Dados das fichas:', fichas);
          
          // Atualizar dashboard se estiver na tela de dashboard
          if (document.getElementById('dashboard-section').style.display === 'block') {
            console.log('üîÑ Atualizando dashboard...');
            renderDashboard();
          }
          
          // Atualizar lista se estiver na tela de lista
          if (document.getElementById('list-section').style.display === 'block') {
            console.log('üîÑ Atualizando lista de fichas...');
            renderFichas();
          }
          
          // Atualizar filtros
          console.log('üîÑ Atualizando filtros...');
          await updateClusterFilter();
          await updateCategoriaFilter();
          updatePagamentoFilter();
          await updateClusterSelects();
          await updateCategoriaSelects();
        } else {
          console.error('‚ùå FirebaseAuth n√£o est√° dispon√≠vel');
          // Fallback para localStorage
          fichas = JSON.parse(localStorage.getItem('fichas') || '[]');
          filteredFichas = [...fichas];
        }
      } catch (error) {
        console.error('‚ùå Erro ao carregar fichas do Firebase:', error);
        console.error('‚ùå Detalhes do erro:', error.message);
        // Fallback para localStorage
        fichas = JSON.parse(localStorage.getItem('fichas') || '[]');
        filteredFichas = [...fichas];
      }
    }
    
    // Fun√ß√£o para carregar clusters do Firebase
    async function loadClustersFromFirebase() {
      try {
        console.log('üîÑ Carregando clusters do Firebase...');
        
        if (window.FirebaseAuth) {
          const firebaseClusters = await window.FirebaseAuth.getClusters();
          const clustersData = firebaseClusters || [];
          console.log('‚úÖ Clusters carregados do Firebase:', clustersData.length);
          return clustersData;
        } else {
          console.error('‚ùå FirebaseAuth n√£o est√° dispon√≠vel');
          // Fallback para localStorage
          return JSON.parse(localStorage.getItem('clustersCadastrados') || '[]');
        }
      } catch (error) {
        console.error('‚ùå Erro ao carregar clusters do Firebase:', error);
        // Fallback para localStorage
        return JSON.parse(localStorage.getItem('clustersCadastrados') || '[]');
      }
    }
    
    // Fun√ß√£o para carregar categorias do Firebase
    async function loadCategoriasFromFirebase() {
      try {
        console.log('üîÑ Carregando categorias do Firebase...');
        
        if (window.FirebaseAuth) {
          const firebaseCategorias = await window.FirebaseAuth.getCategorias();
          const categoriasData = firebaseCategorias || [];
          console.log('‚úÖ Categorias carregadas do Firebase:', categoriasData.length);
          return categoriasData;
        } else {
          console.error('‚ùå FirebaseAuth n√£o est√° dispon√≠vel');
          // Fallback para localStorage
          return JSON.parse(localStorage.getItem('categoriasCadastradas') || '[]');
        }
      } catch (error) {
        console.error('‚ùå Erro ao carregar categorias do Firebase:', error);
        // Fallback para localStorage
        return JSON.parse(localStorage.getItem('categoriasCadastradas') || '[]');
      }
    }
    
    // Fun√ß√£o para atualizar informa√ß√µes do usu√°rio e empresa
    async function updateUserInfo() {
      try {
        console.log('üîÑ Atualizando informa√ß√µes do usu√°rio e empresa...');
        
        const userInfoElement = document.getElementById('user-info');
        const userNameElement = document.getElementById('user-name');
        const userEmailElement = document.getElementById('user-email');
        const userPhotoElement = document.getElementById('user-photo');
        
        const empresaMenuInfoElement = document.getElementById('empresa-menu-info');
        const empresaMenuNomeElement = document.getElementById('empresa-menu-nome');
        const empresaMenuPhotoElement = document.getElementById('empresa-menu-photo');
        
        if (!userInfoElement || !userNameElement || !userEmailElement || !userPhotoElement) {
          console.error('‚ùå Elementos de usu√°rio n√£o encontrados');
          return;
        }
        
        if (!empresaMenuInfoElement || !empresaMenuNomeElement || !empresaMenuPhotoElement) {
          console.error('‚ùå Elementos de empresa n√£o encontrados');
          return;
        }
        
        let userDisplayName = '';
        let userEmail = '';
        let userPhotoURL = '';
        
        // Tentar obter informa√ß√µes do Firebase primeiro
        if (window.FirebaseAuth) {
          try {
            const currentUser = await window.FirebaseAuth.getCurrentUser();
            if (currentUser) {
              console.log('‚úÖ Usu√°rio encontrado no Firebase:', currentUser.email);
              userDisplayName = currentUser.displayName || currentUser.email;
              userEmail = currentUser.email;
              userPhotoURL = currentUser.photoURL || '';
            }
          } catch (firebaseError) {
            console.error('‚ùå Erro ao obter usu√°rio do Firebase:', firebaseError);
          }
        }
        
        // Fallback para localStorage se Firebase n√£o dispon√≠vel
        if (!userDisplayName || !userEmail) {
          console.log('üîÑ Usando dados do localStorage...');
          userDisplayName = localStorage.getItem('userDisplayName') || localStorage.getItem('currentUser') || 'Usu√°rio';
          userEmail = localStorage.getItem('currentUser') || 'email@exemplo.com';
          userPhotoURL = localStorage.getItem('userPhotoURL') || '';
        }
        
        // Atualizar elementos do usu√°rio
        userNameElement.textContent = userDisplayName;
        userEmailElement.textContent = userEmail;
        
        if (userPhotoURL) {
          userPhotoElement.src = userPhotoURL;
          userPhotoElement.style.display = 'block';
        } else {
          // Usar √≠cone padr√£o se n√£o h√° foto
          userPhotoElement.style.display = 'none';
          userPhotoElement.parentElement.innerHTML = `
            <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary);">
              <span class="material-icons" style="color: white; font-size: 1rem;">person</span>
            </div>
          `;
        }
        
        // Mostrar informa√ß√µes do usu√°rio
        userInfoElement.style.display = 'flex';
        console.log('‚úÖ Informa√ß√µes do usu√°rio atualizadas:', { userDisplayName, userEmail });
        
        // Carregar e exibir informa√ß√µes da empresa
        await updateEmpresaMenuInfo();
        
      } catch (error) {
        console.error('‚ùå Erro ao atualizar informa√ß√µes do usu√°rio:', error);
      }
    }
    
    // Fun√ß√£o para atualizar informa√ß√µes da empresa no menu
    async function updateEmpresaMenuInfo() {
      try {
        console.log('üîÑ Atualizando informa√ß√µes da empresa no menu...');
        
        const empresaMenuInfoElement = document.getElementById('empresa-menu-info');
        const empresaMenuNomeElement = document.getElementById('empresa-menu-nome');
        const empresaMenuPhotoElement = document.getElementById('empresa-menu-photo');
        
        if (!empresaMenuInfoElement || !empresaMenuNomeElement || !empresaMenuPhotoElement) {
          console.error('‚ùå Elementos de empresa no menu n√£o encontrados');
          return;
        }
        
        let empresaData = null;
        
        // Tentar obter dados da empresa do Firebase
        if (window.FirebaseAuth) {
          try {
            empresaData = await window.FirebaseAuth.getEmpresaConfig();
            console.log('üìä Dados da empresa do Firebase:', empresaData);
          } catch (firebaseError) {
            console.error('‚ùå Erro ao obter empresa do Firebase:', firebaseError);
          }
        }
        
        // Fallback para localStorage se Firebase n√£o dispon√≠vel ou sem dados
        if (!empresaData || !empresaData.nome) {
          console.log('üîÑ Usando dados da empresa do localStorage...');
          
          // Tentar diferentes chaves do localStorage
          let empresaLocalStorage = localStorage.getItem('empresaConfig');
          if (!empresaLocalStorage) {
            empresaLocalStorage = localStorage.getItem('configEmpresa');
          }
          
          if (empresaLocalStorage) {
            try {
              empresaData = JSON.parse(empresaLocalStorage);
              console.log('üìä Dados da empresa do localStorage:', empresaData);
            } catch (parseError) {
              console.error('‚ùå Erro ao parsear dados da empresa do localStorage:', parseError);
            }
          }
        }
        
        // Exibir informa√ß√µes da empresa se dispon√≠vel
        if (empresaData && empresaData.nome) {
          console.log('‚úÖ Exibindo informa√ß√µes da empresa:', empresaData.nome);
          console.log('üì∏ Foto da empresa:', empresaData.fotoUrl);
          console.log('üîç Verifica√ß√£o foto:', empresaData.fotoUrl && empresaData.fotoUrl.trim() !== '');
          
          if (empresaData.fotoUrl && empresaData.fotoUrl.trim() !== '') {
            console.log('üñºÔ∏è Empresa TEM foto - mostrando foto + nome + descri√ß√£o');
            // Se tem foto, mostrar foto + nome + descri√ß√£o
            empresaMenuInfoElement.innerHTML = `
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <img id="empresa-menu-photo" src="${empresaData.fotoUrl}" alt="Logo da empresa" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--success);" />
                <div style="display: flex; flex-direction: column; gap: 0.125rem;">
                  <span id="empresa-menu-nome" style="font-weight: 600; color: var(--success-dark); font-size: 0.9rem;">${empresaData.nome}</span>
                  <span style="color: var(--success-secondary); font-size: 0.8rem;">Empresa Cadastrada</span>
                </div>
              </div>
            `;
          } else {
            console.log('üìù Empresa N√ÉO tem foto - mostrando √≠cone padr√£o + nome + descri√ß√£o');
            // Se n√£o tem foto, mostrar √≠cone padr√£o + nome + descri√ß√£o
            empresaMenuInfoElement.innerHTML = `
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--success); display: flex; align-items: center; justify-content: center; border: 2px solid var(--success);">
                  <span class="material-icons" style="color: white; font-size: 1rem;">business</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.125rem;">
                  <span id="empresa-menu-nome" style="font-weight: 600; color: var(--success-dark); font-size: 0.9rem;">${empresaData.nome}</span>
                  <span style="color: var(--success-secondary); font-size: 0.8rem;">Empresa Cadastrada</span>
                </div>
              </div>
            `;
          }
          
          empresaMenuInfoElement.style.display = 'flex';
          console.log('‚úÖ Elemento empresa-menu-info exibido');
        } else {
          console.log('‚ÑπÔ∏è Nenhuma empresa cadastrada encontrada');
          empresaMenuInfoElement.style.display = 'none';
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao atualizar informa√ß√µes da empresa no menu:', error);
      }
    }
    
    // Fun√ß√£o para aguardar Firebase Auth carregar
    async function waitForFirebaseAuth() {
      let attempts = 0;
      const maxAttempts = 50; // 5 segundos
      
      while (!window.FirebaseAuth && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      
      if (window.FirebaseAuth) {
        console.log('‚úÖ FirebaseAuth carregado');
        await loadFichasFromFirebase();
        await updateUserInfo(); // Atualizar informa√ß√µes do usu√°rio
      } else {
        console.error('‚ùå FirebaseAuth n√£o carregou ap√≥s 5 segundos');
        // Fallback para localStorage
        fichas = JSON.parse(localStorage.getItem('fichas') || '[]');
        filteredFichas = [...fichas];
        await updateUserInfo(); // Atualizar informa√ß√µes do usu√°rio mesmo sem Firebase
      }
    }

    // Menu mobile - removido event listener duplicado
    // O event listener correto est√° definido mais abaixo

    // Navega√ß√£o lateral
    navItems.forEach(item => {
      item.onclick = function() {
        const screen = this.dataset.screen;
        switchScreen(screen);
        
        // Atualizar estado ativo
        navItems.forEach(nav => nav.classList.remove('active'));
        this.classList.add('active');
        
        // Fechar menu mobile
        sidebar.classList.remove('open');
      };
    });

    async function switchScreen(screen) {
      console.log('Mudando para tela:', screen);
      if (screen === 'list') {
        listSection.style.display = 'block';
        createSection.style.display = 'none';
        dashboardSection.style.display = 'none';
        configuracoesSection.style.display = 'none';
        // Remover se√ß√£o de categorias se existir
        const existingCategoriasSection = document.getElementById('categorias-section');
        if (existingCategoriasSection) {
          existingCategoriasSection.remove();
        }
        // Remover se√ß√£o de clusters se existir
        const existingClustersSection = document.getElementById('clusters-section');
        if (existingClustersSection) {
          existingClustersSection.remove();
        }
        pageTitle.textContent = 'Fichas Cadastradas';
        renderFichas();
        updateClusterFilter();
        updateCategoriaFilter();
      } else if (screen === 'create') {
        listSection.style.display = 'none';
        createSection.style.display = 'block';
        dashboardSection.style.display = 'none';
        configuracoesSection.style.display = 'none';
        // Remover se√ß√£o de categorias se existir
        const existingCategoriasSection = document.getElementById('categorias-section');
        if (existingCategoriasSection) {
          existingCategoriasSection.remove();
        }
        // Remover se√ß√£o de clusters se existir
        const existingClustersSection = document.getElementById('clusters-section');
        if (existingClustersSection) {
          existingClustersSection.remove();
        }
        pageTitle.textContent = 'Cadastrar Ficha';
        fichaForm.reset();
        updateClusterSelects();
        updateCategoriaSelects();
      } else if (screen === 'dashboard') {
        listSection.style.display = 'none';
        createSection.style.display = 'none';
        dashboardSection.style.display = 'block';
        configuracoesSection.style.display = 'none';
        // Remover se√ß√£o de categorias se existir
        const existingCategoriasSection = document.getElementById('categorias-section');
        if (existingCategoriasSection) {
          existingCategoriasSection.remove();
        }
        // Remover se√ß√£o de clusters se existir
        const existingClustersSection = document.getElementById('clusters-section');
        if (existingClustersSection) {
          existingClustersSection.remove();
        }
        pageTitle.textContent = 'Dashboard de Produ√ß√£o';
        renderDashboard();
      } else if (screen === 'categorias') {
        listSection.style.display = 'none';
        createSection.style.display = 'none';
        dashboardSection.style.display = 'none';
        configuracoesSection.style.display = 'none';
        // Remover se√ß√£o de clusters se existir
        const existingClustersSection = document.getElementById('clusters-section');
        if (existingClustersSection) {
          existingClustersSection.remove();
        }
        pageTitle.textContent = 'Categorias';
        // Criar se√ß√£o de categorias
        const categoriasSection = document.createElement('section');
        categoriasSection.id = 'categorias-section';
        categoriasSection.style.display = 'block';
        categoriasSection.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow);">
              <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.2rem;">Adicionar Nova Categoria</h3>
              <form id="categoria-form">
                <div style="margin-bottom: 1.5rem;">
                  <label for="nova-categoria" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text);">Nome da Categoria</label>
                  <input type="text" id="nova-categoria" placeholder="Digite o nome da categoria" required style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg);" />
                </div>
                <button type="submit" style="background: var(--primary); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: var(--radius); font-weight: 600; cursor: pointer;">Adicionar Categoria</button>
              </form>
            </div>
            <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow);">
              <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.2rem;">Categorias Cadastradas</h3>
              <div id="lista-categorias" style="max-height: 300px; overflow-y: auto;">
                <p style="color: var(--muted); text-align: center; padding: 2rem;">Nenhuma categoria cadastrada</p>
              </div>
            </div>
          </div>
        `;
        
        // Limpar conte√∫do anterior e adicionar nova se√ß√£o
        const contentBody = document.querySelector('.content-body');
        const existingCategoriasSection = document.getElementById('categorias-section');
        if (existingCategoriasSection) {
          existingCategoriasSection.remove();
        }
        contentBody.appendChild(categoriasSection);
        
        // Adicionar funcionalidade para categorias
        const categoriaForm = document.getElementById('categoria-form');
        const novaCategoriaInput = document.getElementById('nova-categoria');
        const listaCategorias = document.getElementById('lista-categorias');
        
        async function renderCategorias() {
          try {
            console.log('üîÑ Renderizando categorias...');
            
            // Carregar categorias do Firebase
            const categoriasCadastradas = await loadCategoriasFromFirebase();
            console.log('üìä Categorias carregadas:', categoriasCadastradas);
            
            if (categoriasCadastradas.length === 0) {
              listaCategorias.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">Nenhuma categoria cadastrada</p>';
              return;
            }
            
            listaCategorias.innerHTML = '';
            categoriasCadastradas.forEach((cat, idx) => {
              const div = document.createElement('div');
              div.style.display = 'flex';
              div.style.justifyContent = 'space-between';
              div.style.alignItems = 'center';
              div.style.padding = '0.8rem';
              div.style.marginBottom = '0.5rem';
              div.style.backgroundColor = 'var(--bg)';
              div.style.borderRadius = '8px';
              div.style.border = '1px solid var(--border)';
              div.innerHTML = `
                <span style="font-weight: 500; color: var(--text);">${cat}</span>
                <button onclick="removerCategoria('${cat}')" style="background: #e53935; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Remover</button>
              `;
              listaCategorias.appendChild(div);
            });
            
            console.log('‚úÖ Categorias renderizadas com sucesso');
          } catch (error) {
            console.error('‚ùå Erro ao renderizar categorias:', error);
            listaCategorias.innerHTML = '<p style="color: var(--error); text-align: center; padding: 2rem;">Erro ao carregar categorias</p>';
          }
        }
        
        window.removerCategoria = function(idx) {
          if (confirm('Deseja realmente remover esta categoria?')) {
            categoriasCadastradas.splice(idx, 1);
            localStorage.setItem('categoriasCadastradas', JSON.stringify(categoriasCadastradas));
            renderCategorias();
            updateCategoriaSelects();
          }
        };
        
        if (categoriaForm) {
          categoriaForm.onsubmit = async function(e) {
            e.preventDefault();
            const novaCategoria = novaCategoriaInput.value.trim();
            
            if (!novaCategoria) {
              alert('Por favor, digite o nome da categoria');
              return;
            }
            
            try {
              console.log('üîÑ Salvando categoria no Firebase...');
              
              if (window.FirebaseAuth) {
                // Carregar categorias existentes do Firebase
                const categoriasExistentes = await loadCategoriasFromFirebase();
                
                if (categoriasExistentes.includes(novaCategoria)) {
                  alert('Esta categoria j√° existe!');
                  return;
                }
                
                // Adicionar nova categoria
                const novasCategorias = [...categoriasExistentes, novaCategoria];
                await window.FirebaseAuth.saveCategorias(novasCategorias);
                
                console.log('‚úÖ Categoria salva no Firebase');
                novaCategoriaInput.value = '';
                
                // Recarregar e renderizar
                await loadCategoriasFromFirebase();
                renderCategorias();
                await updateCategoriaSelects();
                await updateCategoriaFilter();
              } else {
                console.error('‚ùå FirebaseAuth n√£o est√° dispon√≠vel');
                // Fallback para localStorage
                if (!categoriasCadastradas.includes(novaCategoria)) {
                  categoriasCadastradas.push(novaCategoria);
                  localStorage.setItem('categoriasCadastradas', JSON.stringify(categoriasCadastradas));
                  novaCategoriaInput.value = '';
                  renderCategorias();
                  updateCategoriaSelects();
                } else {
                  alert('Esta categoria j√° existe!');
                }
              }
            } catch (error) {
              console.error('‚ùå Erro ao salvar categoria no Firebase:', error);
              // Fallback para localStorage
              if (!categoriasCadastradas.includes(novaCategoria)) {
                categoriasCadastradas.push(novaCategoria);
                localStorage.setItem('categoriasCadastradas', JSON.stringify(categoriasCadastradas));
                novaCategoriaInput.value = '';
                renderCategorias();
                updateCategoriaSelects();
              } else {
                alert('Esta categoria j√° existe!');
              }
            }
          };
        }
        
        renderCategorias();
      } else if (screen === 'clusters') {
        listSection.style.display = 'none';
        createSection.style.display = 'none';
        dashboardSection.style.display = 'none';
        configuracoesSection.style.display = 'none';
        // Remover se√ß√£o de categorias se existir
        const existingCategoriasSection = document.getElementById('categorias-section');
        if (existingCategoriasSection) {
          existingCategoriasSection.remove();
        }
        pageTitle.textContent = 'Gest√£o de Clusters';
        // Criar se√ß√£o de clusters
        const clustersSection = document.createElement('section');
        clustersSection.id = 'clusters-section';
        clustersSection.style.display = 'block';
        clustersSection.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr; gap: 2rem;">
            <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
              <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.25rem; font-weight: 600; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.75rem;">
                <span class="material-icons" style="color: var(--primary); font-size: 1.5rem;">add_business</span>
                Cadastro de Cluster - Ficha √önica
              </h3>
              <form id="cluster-form">
                <!-- Informa√ß√µes B√°sicas -->
                <div class="form-section" style="background: var(--bg-secondary); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border);">
                  <h4 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif;">üìã Informa√ß√µes B√°sicas</h4>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                      <label for="novo-cluster-nome" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">Nome da Costureira *</label>
                      <input type="text" id="novo-cluster-nome" placeholder="Digite o nome completo" required style="width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                </div>
                    <div class="form-group">
                      <label for="novo-cluster-cpf" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">CPF (opcional)</label>
                      <input type="text" id="novo-cluster-cpf" placeholder="000.000.000-00" style="width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                    </div>
                  </div>
                  <div class="form-group" style="margin-top: 1rem;">
                    <label for="novo-cluster-endereco" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">Endere√ßo (opcional)</label>
                    <input type="text" id="novo-cluster-endereco" placeholder="Digite o endere√ßo completo" style="width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                  </div>
                </div>

                <!-- Fotos -->
                <div class="form-section" style="background: var(--bg-secondary); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border);">
                  <h4 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif;">üì∏ Fotos</h4>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                      <label for="novo-cluster-foto-costureira" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">Foto da Costureira (opcional)</label>
                      <input type="file" id="novo-cluster-foto-costureira" accept="image/*" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                    </div>
                    <div class="form-group">
                      <label for="novo-cluster-foto-espaco" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">Foto do Espa√ßo de Trabalho (opcional)</label>
                      <input type="file" id="novo-cluster-foto-espaco" accept="image/*" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                    </div>
                  </div>
                </div>

                <!-- Declara√ß√µes -->
                <div class="form-section" style="background: var(--bg-secondary); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border);">
                  <h4 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif;">üìù Declara√ß√µes</h4>
                  <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif; cursor: pointer;">
                      <input type="checkbox" id="novo-cluster-declaracao-trabalho" style="width: 1.2rem; height: 1.2rem;" />
                      Declaro que n√£o utilizo trabalho infantil ou for√ßado
                    </label>
                  </div>
                  <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif; cursor: pointer;">
                      <input type="checkbox" id="novo-cluster-declaracao-saude" style="width: 1.2rem; height: 1.2rem;" />
                      Declaro que o local de trabalho possui ilumina√ß√£o, ventila√ß√£o e condi√ß√µes adequadas
                    </label>
                  </div>
                </div>

                <!-- Contato -->
                <div class="form-section" style="background: var(--bg-secondary); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border);">
                  <h4 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif;">üìû Contato</h4>
                  <div class="form-group">
                    <label for="novo-cluster-contato" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">WhatsApp/Telefone (opcional)</label>
                    <input type="text" id="novo-cluster-contato" placeholder="(00) 00000-0000" style="width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                  </div>
                </div>

                <!-- Foto do Ambiente -->
                <div class="form-section" style="background: var(--bg-secondary); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border);">
                  <h4 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif;">üè† Registro Fotogr√°fico do Ambiente</h4>
                  <div class="form-group">
                    <label for="novo-cluster-foto-ambiente" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">Foto do Ambiente de Trabalho (opcional)</label>
                    <input type="file" id="novo-cluster-foto-ambiente" accept="image/*" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                  </div>
                </div>

                <button type="submit" style="background: var(--primary); color: white; border: none; padding: 0.875rem 1.75rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; box-shadow: var(--shadow); width: 100%;">Cadastrar Cluster</button>
              </form>
            </div>
            <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
              <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.25rem; font-weight: 600; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.75rem;">
                <span class="material-icons" style="color: var(--primary); font-size: 1.5rem;">business</span>
                Clusters Cadastrados
              </h3>
              <div id="lista-clusters" style="max-height: 500px; overflow-y: auto;">
                <p style="color: var(--muted); text-align: center; padding: 2rem;">Nenhum cluster cadastrado</p>
              </div>
            </div>
          </div>
        `;
        
        // Limpar conte√∫do anterior e adicionar nova se√ß√£o
        const contentBody = document.querySelector('.content-body');
        const existingClustersSection = document.getElementById('clusters-section');
        if (existingClustersSection) {
          existingClustersSection.remove();
        }
        contentBody.appendChild(clustersSection);
        
        // Adicionar funcionalidade para clusters
        const clusterForm = document.getElementById('cluster-form');
        const novoClusterInput = document.getElementById('novo-cluster');
        const listaClusters = document.getElementById('lista-clusters');
        
        console.log('üîç Elementos de clusters encontrados:', {
          clusterForm: !!clusterForm,
          novoClusterInput: !!novoClusterInput,
          listaClusters: !!listaClusters
        });
        
        async function renderClusters() {
          try {
            console.log('üîÑ Renderizando clusters...');
            
            // Verificar se o elemento listaClusters existe
            if (!listaClusters) {
              console.error('‚ùå Elemento listaClusters n√£o encontrado');
              return;
            }
            
            // Carregar clusters do Firebase
            const clustersCadastrados = await loadClustersFromFirebase();
            console.log('üìä Clusters carregados:', clustersCadastrados);
            
            if (clustersCadastrados.length === 0) {
              console.log('‚ÑπÔ∏è Nenhum cluster encontrado, exibindo mensagem');
              listaClusters.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">Nenhum cluster cadastrado</p>';
              return;
            }
            
            listaClusters.innerHTML = '';
            clustersCadastrados.forEach((cluster, idx) => {
              const div = document.createElement('div');
              div.style.padding = '1rem';
              div.style.marginBottom = '1rem';
              div.style.backgroundColor = 'var(--bg-secondary)';
              div.style.borderRadius = '8px';
              div.style.border = '1px solid var(--border)';
              
              // Determinar se √© um cluster antigo (apenas string) ou novo (objeto)
              const isOldFormat = typeof cluster === 'string';
              const clusterData = isOldFormat ? { nome: cluster } : cluster;
              
              div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                  <div style="flex: 1;">
                    <h4 style="font-weight: 600; color: var(--text); margin: 0 0 0.5rem 0; font-size: 1.1rem;">${clusterData.nome}</h4>
                    ${clusterData.cpf ? `<p style="color: var(--text-secondary); margin: 0 0 0.25rem 0; font-size: 0.9rem;"><strong>CPF:</strong> ${clusterData.cpf}</p>` : ''}
                    ${clusterData.endereco ? `<p style="color: var(--text-secondary); margin: 0 0 0.25rem 0; font-size: 0.9rem;"><strong>Endere√ßo:</strong> ${clusterData.endereco}</p>` : ''}
                    ${clusterData.contato ? `<p style="color: var(--text-secondary); margin: 0 0 0.25rem 0; font-size: 0.9rem;"><strong>Contato:</strong> ${clusterData.contato}</p>` : ''}
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                      ${clusterData.declaracaoTrabalho ? '<span style="background: var(--success-50); color: var(--success); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; border: 1px solid var(--success-200);">‚úì Trabalho Legal</span>' : ''}
                      ${clusterData.declaracaoSaude ? '<span style="background: var(--success-50); color: var(--success); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; border: 1px solid var(--success-200);">‚úì Condi√ß√µes Adequadas</span>' : ''}
                    </div>
                  </div>
                  <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                    <button onclick="editarCluster('${clusterData.nome}')" style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Editar</button>
                  <button onclick="removerCluster('${cluster}')" style="background: var(--error); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Remover</button>
                </div>
              `;
              listaClusters.appendChild(div);
            });
            
            console.log('‚úÖ Clusters renderizados com sucesso');
          } catch (error) {
            console.error('‚ùå Erro ao renderizar clusters:', error);
            listaClusters.innerHTML = '<p style="color: var(--error); text-align: center; padding: 2rem;">Erro ao carregar clusters</p>';
          }
        }
        
        window.removerCluster = function(idx) {
          if (confirm('Deseja realmente remover este cluster?')) {
            clustersCadastrados.splice(idx, 1);
            localStorage.setItem('clustersCadastrados', JSON.stringify(clustersCadastrados));
            renderClusters();
            updateClusterSelects();
            updateClusterFilter();
          }
        };
        
        window.editarCluster = async function(clusterAtual) {
          console.log('‚úèÔ∏è Editando cluster:', clusterAtual);
          
          // Criar modal de edi√ß√£o
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
          `;
          
          modal.innerHTML = `
            <div style="background: white; padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); min-width: 600px; max-width: 800px; max-height: 90vh; overflow-y: auto;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                <h3 style="margin: 0; color: var(--text); font-size: 1.25rem; font-weight: 600; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.5rem;">
                  <span class="material-icons" style="color: var(--primary); font-size: 1.5rem;">edit</span>
                  Editar Cluster
                </h3>
                <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem; padding: 0.25rem;">√ó</button>
              </div>
              
              <form id="edit-cluster-form">
                <!-- Informa√ß√µes B√°sicas -->
                <div class="form-section" style="background: var(--bg-secondary); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border);">
                  <h4 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif;">üìã Informa√ß√µes B√°sicas</h4>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                      <label for="edit-cluster-nome" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">Nome da Costureira *</label>
                      <input type="text" id="edit-cluster-nome" value="${clusterAtual}" placeholder="Digite o nome completo" required style="width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                    </div>
                    <div class="form-group">
                      <label for="edit-cluster-cpf" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">CPF (opcional)</label>
                      <input type="text" id="edit-cluster-cpf" placeholder="000.000.000-00" style="width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                    </div>
                  </div>
                  <div class="form-group" style="margin-top: 1rem;">
                    <label for="edit-cluster-endereco" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">Endere√ßo (opcional)</label>
                    <input type="text" id="edit-cluster-endereco" placeholder="Digite o endere√ßo completo" style="width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                  </div>
                </div>

                <!-- Fotos -->
                <div class="form-section" style="background: var(--bg-secondary); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border);">
                  <h4 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif;">üì∏ Fotos</h4>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                      <label for="edit-cluster-foto-costureira" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">Foto da Costureira (opcional)</label>
                      <input type="file" id="edit-cluster-foto-costureira" accept="image/*" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                    </div>
                    <div class="form-group">
                      <label for="edit-cluster-foto-espaco" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">Foto do Espa√ßo de Trabalho (opcional)</label>
                      <input type="file" id="edit-cluster-foto-espaco" accept="image/*" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                    </div>
                  </div>
                </div>

                <!-- Declara√ß√µes -->
                <div class="form-section" style="background: var(--bg-secondary); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border);">
                  <h4 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif;">üìù Declara√ß√µes</h4>
                  <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif; cursor: pointer;">
                      <input type="checkbox" id="edit-cluster-declaracao-trabalho" style="width: 1.2rem; height: 1.2rem;" />
                      Declaro que n√£o utilizo trabalho infantil ou for√ßado
                    </label>
                  </div>
                  <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif; cursor: pointer;">
                      <input type="checkbox" id="edit-cluster-declaracao-saude" style="width: 1.2rem; height: 1.2rem;" />
                      Declaro que o local de trabalho possui ilumina√ß√£o, ventila√ß√£o e condi√ß√µes adequadas
                    </label>
                  </div>
                </div>

                <!-- Contato -->
                <div class="form-section" style="background: var(--bg-secondary); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border);">
                  <h4 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif;">üìû Contato</h4>
                  <div class="form-group">
                    <label for="edit-cluster-contato" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">WhatsApp/Telefone (opcional)</label>
                    <input type="text" id="edit-cluster-contato" placeholder="(00) 00000-0000" style="width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                  </div>
                </div>

                <!-- Foto do Ambiente -->
                <div class="form-section" style="background: var(--bg-secondary); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border);">
                  <h4 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif;">üè† Registro Fotogr√°fico do Ambiente</h4>
                  <div class="form-group">
                    <label for="edit-cluster-foto-ambiente" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">Foto do Ambiente de Trabalho (opcional)</label>
                    <input type="file" id="edit-cluster-foto-ambiente" accept="image/*" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                  </div>
                </div>
                
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                  <button type="button" onclick="this.closest('.modal-overlay').remove()" style="background: var(--bg-secondary); color: var(--text); border: 1px solid var(--border); padding: 0.75rem 1.5rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif;">Cancelar</button>
                  <button type="submit" style="background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; box-shadow: var(--shadow);">Salvar</button>
                </div>
              </form>
            </div>
          `;
          
          modal.className = 'modal-overlay';
          document.body.appendChild(modal);
          
          // Preencher campos com dados existentes
          const clustersExistentes = await loadClustersFromFirebase();
          const clusterExistente = clustersExistentes.find(c => 
            typeof c === 'string' ? c === clusterAtual : c.nome === clusterAtual
          );
          
          if (clusterExistente && typeof clusterExistente === 'object') {
            // Preencher campos com dados existentes
            document.getElementById('edit-cluster-nome').value = clusterExistente.nome || '';
            document.getElementById('edit-cluster-cpf').value = clusterExistente.cpf || '';
            document.getElementById('edit-cluster-endereco').value = clusterExistente.endereco || '';
            document.getElementById('edit-cluster-contato').value = clusterExistente.contato || '';
            document.getElementById('edit-cluster-declaracao-trabalho').checked = clusterExistente.declaracaoTrabalho || false;
            document.getElementById('edit-cluster-declaracao-saude').checked = clusterExistente.declaracaoSaude || false;
          }
          
          // Focar no input
          const input = modal.querySelector('#edit-cluster-nome');
          input.focus();
          input.select();
          
          // Adicionar event listener ao formul√°rio
          const form = modal.querySelector('#edit-cluster-form');
          form.onsubmit = async function(e) {
            e.preventDefault();
            
            // Capturar todos os campos do formul√°rio
            const nome = document.getElementById('edit-cluster-nome').value.trim();
            const cpf = document.getElementById('edit-cluster-cpf').value.trim();
            const endereco = document.getElementById('edit-cluster-endereco').value.trim();
            const fotoCostureira = document.getElementById('edit-cluster-foto-costureira').files[0];
            const fotoEspaco = document.getElementById('edit-cluster-foto-espaco').files[0];
            const declaracaoTrabalho = document.getElementById('edit-cluster-declaracao-trabalho').checked;
            const contato = document.getElementById('edit-cluster-contato').value.trim();
            const declaracaoSaude = document.getElementById('edit-cluster-declaracao-saude').checked;
            const fotoAmbiente = document.getElementById('edit-cluster-foto-ambiente').files[0];
            
            if (!nome) {
              alert('Por favor, digite o nome da costureira');
              return;
            }
            
            try {
              console.log('üîÑ Salvando edi√ß√£o do cluster no Firebase...');
              
              // Processar fotos (convert√™-las para base64 se foram alteradas)
              let fotoCostureiraUrl = clusterExistente?.fotoCostureira || '';
              let fotoEspacoUrl = clusterExistente?.fotoEspaco || '';
              let fotoAmbienteUrl = clusterExistente?.fotoAmbiente || '';
              
              if (fotoCostureira) {
                fotoCostureiraUrl = await convertFileToBase64(fotoCostureira);
              }
              if (fotoEspaco) {
                fotoEspacoUrl = await convertFileToBase64(fotoEspaco);
              }
              if (fotoAmbiente) {
                fotoAmbienteUrl = await convertFileToBase64(fotoAmbiente);
              }
              
              const clusterAtualizado = {
                nome: nome,
                cpf: cpf,
                endereco: endereco,
                fotoCostureira: fotoCostureiraUrl,
                fotoEspaco: fotoEspacoUrl,
                declaracaoTrabalho: declaracaoTrabalho,
                contato: contato,
                declaracaoSaude: declaracaoSaude,
                fotoAmbiente: fotoAmbienteUrl
              };
              
              if (window.FirebaseAuth) {
                // Carregar clusters existentes do Firebase
                const clustersExistentes = await loadClustersFromFirebase();
                
                // Verificar se o novo nome j√° existe (se foi alterado)
                if (nome !== clusterAtual) {
                  const clusterComMesmoNome = clustersExistentes.find(c => 
                    typeof c === 'string' ? c === nome : c.nome === nome
                  );
                  
                  if (clusterComMesmoNome) {
              alert('J√° existe um cluster com este nome!');
              return;
                  }
            }
            
            // Atualizar o cluster
                const index = clustersExistentes.findIndex(c => 
                  typeof c === 'string' ? c === clusterAtual : c.nome === clusterAtual
                );
                
                if (index !== -1) {
                  clustersExistentes[index] = clusterAtualizado;
                  await window.FirebaseAuth.saveClusters(clustersExistentes);
                  
                  console.log('‚úÖ Cluster editado no Firebase');
                  modal.remove();
                  
                  // Recarregar e renderizar
                  await loadClustersFromFirebase();
                  renderClusters();
                  await updateClusterSelects();
                  await updateClusterFilter();
                } else {
                  alert('Cluster n√£o encontrado!');
                }
              } else {
                console.error('‚ùå FirebaseAuth n√£o est√° dispon√≠vel');
                // Fallback para localStorage
                const clustersLocal = JSON.parse(localStorage.getItem('clustersCadastrados') || '[]');
                
                if (nome !== clusterAtual) {
                  const clusterComMesmoNome = clustersLocal.find(c => 
                    typeof c === 'string' ? c === nome : c.nome === nome
                  );
                  
                  if (clusterComMesmoNome) {
                    alert('J√° existe um cluster com este nome!');
                    return;
                  }
                }
                
                const index = clustersLocal.findIndex(c => 
                  typeof c === 'string' ? c === clusterAtual : c.nome === clusterAtual
                );
                
                if (index !== -1) {
                  clustersLocal[index] = clusterAtualizado;
                  localStorage.setItem('clustersCadastrados', JSON.stringify(clustersLocal));
                  
                  console.log('‚úÖ Cluster editado no localStorage');
                  modal.remove();
                  
            renderClusters();
            updateClusterSelects();
            updateClusterFilter();
                } else {
                  alert('Cluster n√£o encontrado!');
                }
              }
            } catch (error) {
              console.error('‚ùå Erro ao editar cluster:', error);
              alert('Erro ao editar cluster. Tente novamente.');
            }
          };
        };
        
        if (clusterForm) {
          clusterForm.onsubmit = async function(e) {
            e.preventDefault();
            
            // Capturar todos os campos do formul√°rio
            const nome = document.getElementById('novo-cluster-nome').value.trim();
            const cpf = document.getElementById('novo-cluster-cpf').value.trim();
            const endereco = document.getElementById('novo-cluster-endereco').value.trim();
            const fotoCostureira = document.getElementById('novo-cluster-foto-costureira').files[0];
            const fotoEspaco = document.getElementById('novo-cluster-foto-espaco').files[0];
            const declaracaoTrabalho = document.getElementById('novo-cluster-declaracao-trabalho').checked;
            const contato = document.getElementById('novo-cluster-contato').value.trim();
            const declaracaoSaude = document.getElementById('novo-cluster-declaracao-saude').checked;
            const fotoAmbiente = document.getElementById('novo-cluster-foto-ambiente').files[0];
            
            if (!nome) {
              alert('Por favor, digite o nome da costureira');
              return;
            }
            
            try {
              console.log('üîÑ Salvando cluster no Firebase...');
              
              // Processar fotos (convert√™-las para base64)
              let fotoCostureiraUrl = '';
              let fotoEspacoUrl = '';
              let fotoAmbienteUrl = '';
              
              if (fotoCostureira) {
                fotoCostureiraUrl = await convertFileToBase64(fotoCostureira);
              }
              if (fotoEspaco) {
                fotoEspacoUrl = await convertFileToBase64(fotoEspaco);
              }
              if (fotoAmbiente) {
                fotoAmbienteUrl = await convertFileToBase64(fotoAmbiente);
              }
              
              const novoCluster = {
                nome: nome,
                cpf: cpf,
                endereco: endereco,
                fotoCostureira: fotoCostureiraUrl,
                fotoEspaco: fotoEspacoUrl,
                declaracaoTrabalho: declaracaoTrabalho,
                contato: contato,
                declaracaoSaude: declaracaoSaude,
                fotoAmbiente: fotoAmbienteUrl
              };
              
              if (window.FirebaseAuth) {
                // Carregar clusters existentes do Firebase
                const clustersExistentes = await loadClustersFromFirebase();
                
                // Verificar se j√° existe um cluster com este nome
                const clusterExistente = clustersExistentes.find(c => 
                  typeof c === 'string' ? c === nome : c.nome === nome
                );
                
                if (clusterExistente) {
                  alert('J√° existe um cluster com este nome!');
                  return;
                }
                
                // Adicionar novo cluster
                const novosClusters = [...clustersExistentes, novoCluster];
                await window.FirebaseAuth.saveClusters(novosClusters);
                
                console.log('‚úÖ Cluster salvo no Firebase');
                
                // Limpar formul√°rio
                document.getElementById('novo-cluster-nome').value = '';
                document.getElementById('novo-cluster-cpf').value = '';
                document.getElementById('novo-cluster-endereco').value = '';
                document.getElementById('novo-cluster-foto-costureira').value = '';
                document.getElementById('novo-cluster-foto-espaco').value = '';
                document.getElementById('novo-cluster-declaracao-trabalho').checked = false;
                document.getElementById('novo-cluster-contato').value = '';
                document.getElementById('novo-cluster-declaracao-saude').checked = false;
                document.getElementById('novo-cluster-foto-ambiente').value = '';
                
                // Recarregar e renderizar
                await loadClustersFromFirebase();
                renderClusters();
                await updateClusterSelects();
                await updateClusterFilter();
              } else {
                console.error('‚ùå FirebaseAuth n√£o est√° dispon√≠vel');
                // Fallback para localStorage
                const clustersLocal = JSON.parse(localStorage.getItem('clustersCadastrados') || '[]');
                
                if (clustersLocal.some(c => typeof c === 'string' ? c === nome : c.nome === nome)) {
                  alert('J√° existe um cluster com este nome!');
                  return;
                }
                
                clustersLocal.push(novoCluster);
                localStorage.setItem('clustersCadastrados', JSON.stringify(clustersLocal));
                
                console.log('‚úÖ Cluster salvo no localStorage');
                
                // Limpar formul√°rio
                document.getElementById('novo-cluster-nome').value = '';
                document.getElementById('novo-cluster-cpf').value = '';
                document.getElementById('novo-cluster-endereco').value = '';
                document.getElementById('novo-cluster-foto-costureira').value = '';
                document.getElementById('novo-cluster-foto-espaco').value = '';
                document.getElementById('novo-cluster-declaracao-trabalho').checked = false;
                document.getElementById('novo-cluster-contato').value = '';
                document.getElementById('novo-cluster-declaracao-saude').checked = false;
                document.getElementById('novo-cluster-foto-ambiente').value = '';
                
                  renderClusters();
                  updateClusterSelects();
                  updateClusterFilter();
              }
            } catch (error) {
              console.error('‚ùå Erro ao salvar cluster no Firebase:', error);
              alert('Erro ao salvar cluster. Tente novamente.');
            }
          };
        }
        
        console.log('üîÑ Chamando renderClusters...');
        await renderClusters();
        console.log('‚úÖ renderClusters conclu√≠do');
      } else if (screen === 'configuracoes') {
        listSection.style.display = 'none';
        createSection.style.display = 'none';
        dashboardSection.style.display = 'none';
        configuracoesSection.style.display = 'block';
        // Remover se√ß√£o de categorias se existir
        const existingCategoriasSection = document.getElementById('categorias-section');
        if (existingCategoriasSection) {
          existingCategoriasSection.remove();
        }
        // Remover se√ß√£o de clusters se existir
        const existingClustersSection = document.getElementById('clusters-section');
        if (existingClustersSection) {
          existingClustersSection.remove();
        }
        pageTitle.textContent = 'Configura√ß√µes do Sistema';
        
        // Carregar configura√ß√µes da empresa
        console.log('üîÑ Carregando configura√ß√µes da empresa ao abrir tela...');
        await carregarConfiguracoesEmpresa();
        
        // Atualizar informa√ß√µes do sistema
        atualizarInformacoesSistema();
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Fun√ß√£o de edi√ß√£o
    window.editFicha = function(idx) {
      const ficha = filteredFichas[idx];
      editingIndex = fichas.indexOf(ficha);
      
      // Limpar container de cores
      const editCoresContainer = document.getElementById('edit-cores-container');
      editCoresContainer.innerHTML = '';
      editCoresArray = [];
      editCorCounter = 0;
      
      // Preencher formul√°rio de edi√ß√£o
      document.getElementById('edit-cluster').value = ficha.cluster;
      document.getElementById('edit-categoria').value = ficha.categoria;
      document.getElementById('edit-referencia').value = ficha.referencia;
      document.getElementById('edit-quantidade').value = ficha.quantidade;
      document.getElementById('edit-valorUnitario').value = ficha.valorUnitario;
      document.getElementById('edit-valorTotal').value = ficha.valorTotal;
      document.getElementById('edit-pilotagem').value = ficha.pilotagem;
      document.getElementById('edit-saida').value = ficha.saida;
      document.getElementById('edit-pagamento').value = ficha.pagamento;
      document.getElementById('edit-entrada').value = ficha.entrada;
      document.getElementById('edit-observacoes').value = ficha.observacoes || '';
      
      // Carregar cores existentes se houver
      if (ficha.cores && Array.isArray(ficha.cores)) {
        ficha.cores.forEach(cor => {
          const corId = `edit-cor-${editCorCounter++}`;
          const corItem = document.createElement('div');
          corItem.className = 'cor-item';
          corItem.id = corId;
          corItem.style.cssText = `
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
          `;
          
          corItem.innerHTML = `
            <div class="cor-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <span class="cor-nome" style="font-weight: 600; color: var(--text); font-size: 1rem;">${cor.nome}</span>
              <button type="button" class="remove-cor-btn" onclick="removerCorEdit('${corId}')" style="background: var(--error); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
                <span class="material-icons" style="font-size: 1rem;">delete</span>
                Remover
              </button>
            </div>
            <div class="tamanhos-grid">
              <div class="tamanho-item">
                <label>PP / 36</label>
                <input type="number" min="0" value="${cor.pp || 0}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>P / 38</label>
                <input type="number" min="0" value="${cor.p || 0}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>M / 40</label>
                <input type="number" min="0" value="${cor.m || 0}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>G / 42</label>
                <input type="number" min="0" value="${cor.g || 0}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>GG / 44</label>
                <input type="number" min="0" value="${cor.gg || 0}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
            </div>
          `;
          
          editCoresContainer.appendChild(corItem);
          editCoresArray.push({ id: corId, nome: cor.nome });
        });
      } else {
        // Fallback para dados antigos (compatibilidade)
        const coresData = [
          { nome: 'Cor Principal', pp: ficha.pp || 0, p: ficha.p || 0, m: ficha.m || 0, g: ficha.g || 0, gg: ficha.gg || 0 }
        ];
        
        coresData.forEach(cor => {
          const corId = `edit-cor-${editCorCounter++}`;
          const corItem = document.createElement('div');
          corItem.className = 'cor-item';
          corItem.id = corId;
          corItem.style.cssText = `
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
          `;
          
          corItem.innerHTML = `
            <div class="cor-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <span class="cor-nome" style="font-weight: 600; color: var(--text); font-size: 1rem;">${cor.nome}</span>
              <button type="button" class="remove-cor-btn" onclick="removerCorEdit('${corId}')" style="background: var(--error); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
                <span class="material-icons" style="font-size: 1rem;">delete</span>
                Remover
              </button>
            </div>
            <div class="tamanhos-grid">
              <div class="tamanho-item">
                <label>PP / 36</label>
                <input type="number" min="0" value="${cor.pp}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>P / 38</label>
                <input type="number" min="0" value="${cor.p}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>M / 40</label>
                <input type="number" min="0" value="${cor.m}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>G / 42</label>
                <input type="number" min="0" value="${cor.g}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>GG / 44</label>
                <input type="number" min="0" value="${cor.gg}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
            </div>
          `;
          
          editCoresContainer.appendChild(corItem);
          editCoresArray.push({ id: corId, nome: cor.nome });
        });
      }
      
      editModal.style.display = 'flex';
    };

    function closeEditModal() {
      editModal.style.display = 'none';
      editingIndex = -1;
    }

    // Fun√ß√£o para mostrar detalhes da ficha
    function showFichaDetails(idx) {
      const ficha = filteredFichas[idx];
      const detailsModal = document.getElementById('details-modal');
      const detailsContent = document.getElementById('ficha-details-content');
      
      if (!ficha) {
        console.error('Ficha n√£o encontrada');
        return;
      }
      
      // Armazenar ficha atual para exporta√ß√£o
      window.currentFichaDetails = ficha;
      
      // Formatar datas
      const formatarData = (dataString) => {
        if (!dataString) return '-';
        const data = new Date(dataString);
        return data.toLocaleDateString('pt-BR');
      };
      
      // Formatar valor monet√°rio
      const formatarValor = (valor) => {
        return `R$ ${Number(valor).toFixed(2)}`;
      };
      
      // Gerar HTML dos detalhes
      const detailsHTML = `
        <div style="display: grid; gap: 1.5rem;">
          <!-- Informa√ß√µes B√°sicas -->
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--primary); font-size: 1.2rem;">info</span>
              Informa√ß√µes B√°sicas
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Cluster:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${ficha.cluster}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Categoria:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${ficha.categoria}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Refer√™ncia:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${ficha.referencia}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Quantidade:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${ficha.quantidade} pe√ßas</p>
              </div>
            </div>
          </div>

          <!-- Informa√ß√µes Financeiras -->
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--success); font-size: 1.2rem;">payments</span>
              Informa√ß√µes Financeiras
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Valor Unit√°rio:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarValor(ficha.valorUnitario)}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Valor Total:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarValor(ficha.valorTotal)}</p>
              </div>
            </div>
          </div>

          <!-- Datas e Prazos -->
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--warning); font-size: 1.2rem;">schedule</span>
              Datas e Prazos
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Data de Remessa:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarData(ficha.saida)}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Data de Recebimento:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarData(ficha.entrada)}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Data de Pagamento:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarData(ficha.pagamento)}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Pilotagem:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarData(ficha.pilotagem)}</p>
              </div>
            </div>
          </div>

          <!-- Tamanhos e Cores -->
          ${ficha.cores && ficha.cores.length > 0 ? `
            <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
              <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-icons" style="color: var(--primary); font-size: 1.2rem;">palette</span>
                Cores e Tamanhos
              </h4>
              <div style="display: grid; gap: 1rem;">
                ${ficha.cores.map(cor => `
                  <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                    <h5 style="margin: 0 0 0.5rem 0; color: var(--text); font-size: 1rem; font-weight: 600;">${cor.nome}</h5>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem;">
                      <div style="text-align: center;">
                        <strong style="color: var(--text-secondary); font-size: 0.8rem;">PP/36</strong>
                        <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${cor.pp || 0}</p>
                      </div>
                      <div style="text-align: center;">
                        <strong style="color: var(--text-secondary); font-size: 0.8rem;">P/38</strong>
                        <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${cor.p || 0}</p>
                      </div>
                      <div style="text-align: center;">
                        <strong style="color: var(--text-secondary); font-size: 0.8rem;">M/40</strong>
                        <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${cor.m || 0}</p>
                      </div>
                      <div style="text-align: center;">
                        <strong style="color: var(--text-secondary); font-size: 0.8rem;">G/42</strong>
                        <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${cor.g || 0}</p>
                      </div>
                      <div style="text-align: center;">
                        <strong style="color: var(--text-secondary); font-size: 0.8rem;">GG/44</strong>
                        <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${cor.gg || 0}</p>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <!-- Observa√ß√µes -->
          ${ficha.observacoes ? `
            <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
              <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-icons" style="color: var(--text-secondary); font-size: 1.2rem;">note</span>
                Observa√ß√µes
              </h4>
              <p style="margin: 0; color: var(--text); line-height: 1.6;">${ficha.observacoes}</p>
            </div>
          ` : ''}
        </div>
      `;
      
      detailsContent.innerHTML = detailsHTML;
      detailsModal.style.display = 'flex';
    }

    // Fun√ß√£o para fechar modal de detalhes
    function closeDetailsModal() {
      const detailsModal = document.getElementById('details-modal');
      detailsModal.style.display = 'none';
    }

    // Fun√ß√£o para mostrar relat√≥rio do dashboard
    function showDashboardReport() {
      const reportModal = document.getElementById('report-modal');
      const reportContent = document.getElementById('report-content');
      
      // Obter dados filtrados atuais
      const dataToUse = dashboardFilteredFichas.length > 0 && (currentClusterFilter || currentPeriodFilter) ? dashboardFilteredFichas : fichas;
      
      // Obter filtros ativos
      const clusterFilter = document.getElementById('dashboard-cluster-filter').value;
      const periodFilter = document.getElementById('dashboard-period-filter').value;
      
      // Formatar datas
      const formatarData = (dataString) => {
        if (!dataString) return '-';
        const data = new Date(dataString);
        return data.toLocaleDateString('pt-BR');
      };
      
      // Formatar valor monet√°rio
      const formatarValor = (valor) => {
        return `R$ ${Number(valor).toFixed(2)}`;
      };
      
      // Calcular estat√≠sticas
      const totalPecas = dataToUse.reduce((sum, f) => sum + f.quantidade, 0);
      const totalValor = dataToUse.reduce((sum, f) => sum + f.valorTotal, 0);
      const mediaValor = dataToUse.length > 0 ? totalValor / dataToUse.length : 0;
      const mediaPecas = dataToUse.length > 0 ? totalPecas / dataToUse.length : 0;
      const clustersUnicos = [...new Set(dataToUse.map(f => f.cluster))];
      const categoriasUnicas = [...new Set(dataToUse.map(f => f.categoria))];
      
      // Calcular estat√≠sticas por cluster
      const statsPorCluster = {};
      dataToUse.forEach(f => {
        if (!statsPorCluster[f.cluster]) {
          statsPorCluster[f.cluster] = { fichas: 0, pecas: 0, valor: 0 };
        }
        statsPorCluster[f.cluster].fichas++;
        statsPorCluster[f.cluster].pecas += f.quantidade;
        statsPorCluster[f.cluster].valor += f.valorTotal;
      });
      
      // Calcular estat√≠sticas por categoria
      const statsPorCategoria = {};
      dataToUse.forEach(f => {
        if (!statsPorCategoria[f.categoria]) {
          statsPorCategoria[f.categoria] = { fichas: 0, pecas: 0, valor: 0 };
        }
        statsPorCategoria[f.categoria].fichas++;
        statsPorCategoria[f.categoria].pecas += f.quantidade;
        statsPorCategoria[f.categoria].valor += f.valorTotal;
      });
      
      // Gerar HTML do relat√≥rio
      const reportHTML = `
        <div style="display: grid; gap: 2rem;">
          <!-- Cabe√ßalho do Relat√≥rio -->
          <div style="background: var(--primary-50); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--primary-200);">
            <h4 style="margin: 0 0 1rem 0; color: var(--primary-dark); font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--primary); font-size: 1.3rem;">assessment</span>
              Filtros Aplicados
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Cluster:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${clusterFilter || 'Todos'}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Per√≠odo:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${periodFilter ? `${periodFilter} dias` : 'Todos'}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Fichas Analisadas:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${dataToUse.length}</p>
              </div>
            </div>
          </div>

          <!-- Resumo Executivo -->
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--success); font-size: 1.3rem;">trending_up</span>
              Resumo Executivo
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
              <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Total de Pe√ßas:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 600; font-size: 1.1rem;">${totalPecas.toLocaleString('pt-BR')}</p>
              </div>
              <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Valor Total:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 600; font-size: 1.1rem;">${formatarValor(totalValor)}</p>
              </div>
              <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Valor M√©dio por Ficha:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 600; font-size: 1.1rem;">${formatarValor(mediaValor)}</p>
              </div>
              <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">M√©dia de Pe√ßas por Ficha:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 600; font-size: 1.1rem;">${Math.round(mediaPecas)}</p>
              </div>
            </div>
          </div>

          <!-- An√°lise por Cluster -->
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--primary); font-size: 1.3rem;">groups</span>
              An√°lise por Cluster
            </h4>
            <div style="display: grid; gap: 1rem;">
              ${Object.entries(statsPorCluster).map(([cluster, stats]) => `
                <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                  <h5 style="margin: 0 0 0.5rem 0; color: var(--text); font-size: 1rem; font-weight: 600;">${cluster}</h5>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div>
                      <strong style="color: var(--text-secondary); font-size: 0.8rem;">Fichas:</strong>
                      <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${stats.fichas}</p>
                    </div>
                    <div>
                      <strong style="color: var(--text-secondary); font-size: 0.8rem;">Pe√ßas:</strong>
                      <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${stats.pecas.toLocaleString('pt-BR')}</p>
                    </div>
                    <div>
                      <strong style="color: var(--text-secondary); font-size: 0.8rem;">Valor Total:</strong>
                      <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarValor(stats.valor)}</p>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- An√°lise por Categoria -->
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--warning); font-size: 1.3rem;">category</span>
              An√°lise por Categoria
            </h4>
            <div style="display: grid; gap: 1rem;">
              ${Object.entries(statsPorCategoria).map(([categoria, stats]) => `
                <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                  <h5 style="margin: 0 0 0.5rem 0; color: var(--text); font-size: 1rem; font-weight: 600;">${categoria}</h5>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div>
                      <strong style="color: var(--text-secondary); font-size: 0.8rem;">Fichas:</strong>
                      <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${stats.fichas}</p>
                    </div>
                    <div>
                      <strong style="color: var(--text-secondary); font-size: 0.8rem;">Pe√ßas:</strong>
                      <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${stats.pecas.toLocaleString('pt-BR')}</p>
                    </div>
                    <div>
                      <strong style="color: var(--text-secondary); font-size: 0.8rem;">Valor Total:</strong>
                      <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarValor(stats.valor)}</p>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Lista Detalhada de Fichas -->
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--text-secondary); font-size: 1.3rem;">list</span>
              Lista Detalhada de Fichas
            </h4>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
                  <tr style="background: var(--surface); border-bottom: 2px solid var(--border);">
                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text);">Cluster</th>
                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text);">Categoria</th>
                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text);">Refer√™ncia</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: var(--text);">Quantidade</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: var(--text);">Valor Unit.</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: var(--text);">Valor Total</th>
                    <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: var(--text);">Sa√≠da</th>
                  </tr>
                </thead>
                <tbody>
                  ${dataToUse.map(ficha => `
                    <tr style="border-bottom: 1px solid var(--border);">
                      <td style="padding: 0.75rem; color: var(--text);">${ficha.cluster}</td>
                      <td style="padding: 0.75rem; color: var(--text);">${ficha.categoria}</td>
                      <td style="padding: 0.75rem; color: var(--text);">${ficha.referencia}</td>
                      <td style="padding: 0.75rem; text-align: right; color: var(--text);">${ficha.quantidade.toLocaleString('pt-BR')}</td>
                      <td style="padding: 0.75rem; text-align: right; color: var(--text);">${formatarValor(ficha.valorUnitario)}</td>
                      <td style="padding: 0.75rem; text-align: right; color: var(--text); font-weight: 600;">${formatarValor(ficha.valorTotal)}</td>
                      <td style="padding: 0.75rem; text-align: center; color: var(--text);">${formatarData(ficha.saida)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      reportContent.innerHTML = reportHTML;
      reportModal.style.display = 'flex';
    }

    // Fun√ß√£o para fechar modal de relat√≥rio
    function closeReportModal() {
      const reportModal = document.getElementById('report-modal');
      reportModal.style.display = 'none';
    }

    // Fun√ß√£o para exportar relat√≥rio para PDF
    function exportReportToPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Obter dados filtrados atuais
        const dataToUse = dashboardFilteredFichas.length > 0 && (currentClusterFilter || currentPeriodFilter) ? dashboardFilteredFichas : fichas;
        const clusterFilter = document.getElementById('dashboard-cluster-filter').value;
        const periodFilter = document.getElementById('dashboard-period-filter').value;
        
        // Calcular estat√≠sticas
        const totalPecas = dataToUse.reduce((sum, f) => sum + f.quantidade, 0);
        const totalValor = dataToUse.reduce((sum, f) => sum + f.valorTotal, 0);
        const mediaValor = dataToUse.length > 0 ? totalValor / dataToUse.length : 0;
        const mediaPecas = dataToUse.length > 0 ? totalPecas / dataToUse.length : 0;
        
        // Configurar fonte
        doc.setFont('helvetica');
        doc.setFontSize(16);
        
        // T√≠tulo
        doc.text('Relat√≥rio Detalhado - Dashboard de Produ√ß√£o', 20, 20);
        
        // Informa√ß√µes dos filtros
        doc.setFontSize(12);
        doc.text(`Filtros Aplicados:`, 20, 40);
        doc.setFontSize(10);
        doc.text(`Cluster: ${clusterFilter || 'Todos'}`, 30, 50);
        doc.text(`Per√≠odo: ${periodFilter ? `${periodFilter} dias` : 'Todos'}`, 30, 60);
        doc.text(`Fichas Analisadas: ${dataToUse.length}`, 30, 70);
        
        // Resumo executivo
        doc.setFontSize(12);
        doc.text('Resumo Executivo:', 20, 90);
        doc.setFontSize(10);
        doc.text(`Total de Pe√ßas: ${totalPecas.toLocaleString('pt-BR')}`, 30, 100);
        doc.text(`Valor Total: R$ ${totalValor.toFixed(2)}`, 30, 110);
        doc.text(`Valor M√©dio por Ficha: R$ ${mediaValor.toFixed(2)}`, 30, 120);
        doc.text(`M√©dia de Pe√ßas por Ficha: ${Math.round(mediaPecas)}`, 30, 130);
        
        // Tabela de fichas
        doc.setFontSize(12);
        doc.text('Lista Detalhada de Fichas:', 20, 160);
        
        const tableData = dataToUse.map(ficha => [
          ficha.cluster,
          ficha.categoria,
          ficha.referencia,
          ficha.quantidade.toString(),
          `R$ ${ficha.valorUnitario.toFixed(2)}`,
          `R$ ${ficha.valorTotal.toFixed(2)}`,
          ficha.saida ? new Date(ficha.saida).toLocaleDateString('pt-BR') : '-'
        ]);
        
        doc.autoTable({
          startY: 170,
          head: [['Cluster', 'Categoria', 'Refer√™ncia', 'Quantidade', 'Valor Unit.', 'Valor Total', 'Sa√≠da']],
          body: tableData,
          theme: 'grid',
          headStyles: { fillColor: [37, 99, 235] },
          styles: { fontSize: 8 }
        });
        
        // Gerar nome do arquivo
        const timestamp = new Date().toISOString().slice(0, 10);
        const fileName = `relatorio_dashboard_${timestamp}.pdf`;
        
        // Salvar PDF
        doc.save(fileName);
        
        console.log('‚úÖ Relat√≥rio exportado com sucesso');
      } catch (error) {
        console.error('‚ùå Erro ao exportar relat√≥rio:', error);
        alert('Erro ao exportar relat√≥rio. Verifique o console para mais detalhes.');
      }
    }

    // Fun√ß√£o para exportar ficha para PDF
    function exportFichaToPDF() {
      try {
        // Obter dados da ficha atual (precisamos armazenar a ficha atual)
        const currentFicha = window.currentFichaDetails;
        
        if (!currentFicha) {
          alert('Nenhuma ficha selecionada para exportar.');
          return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Formatar datas
        const formatarData = (dataString) => {
          if (!dataString) return '-';
          const data = new Date(dataString);
          return data.toLocaleDateString('pt-BR');
        };
        
        // Formatar valor monet√°rio
        const formatarValor = (valor) => {
          return `R$ ${Number(valor).toFixed(2)}`;
        };
        
        // Configurar fonte
        doc.setFont('helvetica');
        doc.setFontSize(16);
        
        // T√≠tulo
        doc.text('Detalhes da Ficha', 20, 20);
        
        // Informa√ß√µes b√°sicas
        doc.setFontSize(12);
        doc.text('Informa√ß√µes B√°sicas:', 20, 40);
        doc.setFontSize(10);
        doc.text(`Cluster: ${currentFicha.cluster}`, 30, 50);
        doc.text(`Categoria: ${currentFicha.categoria}`, 30, 60);
        doc.text(`Refer√™ncia: ${currentFicha.referencia}`, 30, 70);
        doc.text(`Quantidade: ${currentFicha.quantidade} pe√ßas`, 30, 80);
        
        // Informa√ß√µes financeiras
        doc.setFontSize(12);
        doc.text('Informa√ß√µes Financeiras:', 20, 100);
        doc.setFontSize(10);
        doc.text(`Valor Unit√°rio: ${formatarValor(currentFicha.valorUnitario)}`, 30, 110);
        doc.text(`Valor Total: ${formatarValor(currentFicha.valorTotal)}`, 30, 120);
        
        // Datas e prazos
        doc.setFontSize(12);
        doc.text('Datas e Prazos:', 20, 140);
        doc.setFontSize(10);
              doc.text(`Data de Remessa: ${formatarData(currentFicha.saida)}`, 30, 150);
      doc.text(`Data de Recebimento: ${formatarData(currentFicha.entrada)}`, 30, 160);
        doc.text(`Data de Pagamento: ${formatarData(currentFicha.pagamento)}`, 30, 170);
        doc.text(`Pilotagem: ${formatarData(currentFicha.pilotagem)}`, 30, 180);
        
        // Cores e tamanhos (se houver)
        if (currentFicha.cores && currentFicha.cores.length > 0) {
          doc.setFontSize(12);
          doc.text('Cores e Tamanhos:', 20, 200);
          doc.setFontSize(10);
          
          let yPosition = 210;
          currentFicha.cores.forEach((cor, index) => {
            if (yPosition > 250) {
              doc.addPage();
              yPosition = 20;
            }
            
            doc.text(`${cor.nome}:`, 30, yPosition);
            yPosition += 10;
            doc.text(`PP/36: ${cor.pp || 0}`, 40, yPosition);
            yPosition += 5;
            doc.text(`P/38: ${cor.p || 0}`, 40, yPosition);
            yPosition += 5;
            doc.text(`M/40: ${cor.m || 0}`, 40, yPosition);
            yPosition += 5;
            doc.text(`G/42: ${cor.g || 0}`, 40, yPosition);
            yPosition += 5;
            doc.text(`GG/44: ${cor.gg || 0}`, 40, yPosition);
            yPosition += 10;
          });
        }
        
        // Observa√ß√µes (se houver)
        if (currentFicha.observacoes) {
          doc.setFontSize(12);
          doc.text('Observa√ß√µes:', 20, doc.lastAutoTable.finalY + 20);
          doc.setFontSize(10);
          doc.text(currentFicha.observacoes, 30, doc.lastAutoTable.finalY + 30);
        }
        
        // Gerar nome do arquivo
        const timestamp = new Date().toISOString().slice(0, 10);
        const fileName = `ficha_${currentFicha.referencia}_${timestamp}.pdf`;
        
        // Salvar PDF
        doc.save(fileName);
        
        console.log('‚úÖ Ficha exportada com sucesso');
      } catch (error) {
        console.error('‚ùå Erro ao exportar ficha:', error);
        alert('Erro ao exportar ficha. Verifique o console para mais detalhes.');
      }
    }

    function calcularValorTotalEdit() {
      const quantidade = Number(document.getElementById('edit-quantidade').value) || 0;
      const valorUnitario = Number(document.getElementById('edit-valorUnitario').value) || 0;
      const valorTotal = quantidade * valorUnitario;
      document.getElementById('edit-valorTotal').value = valorTotal.toFixed(2);
    }

    editForm.onsubmit = function(e) {
      e.preventDefault();
      
      // Coletar dados das cores dinamicamente
      const coresData = [];
      const coresItems = document.querySelectorAll('#edit-cores-container .cor-item');
      
      coresItems.forEach(corItem => {
        const nomeCor = corItem.querySelector('.cor-nome').textContent;
        const inputs = corItem.querySelectorAll('input[type="number"]');
        const pp = parseInt(inputs[0].value) || 0;
        const p = parseInt(inputs[1].value) || 0;
        const m = parseInt(inputs[2].value) || 0;
        const g = parseInt(inputs[3].value) || 0;
        const gg = parseInt(inputs[4].value) || 0;
        
        coresData.push({
          id: Date.now() + Math.random(),
          nome: nomeCor,
          pp: pp,
          p: p,
          m: m,
          g: g,
          gg: gg
        });
      });
      
      // Calcular totais das cores
      const totalPp = coresData.reduce((sum, cor) => sum + cor.pp, 0);
      const totalP = coresData.reduce((sum, cor) => sum + cor.p, 0);
      const totalM = coresData.reduce((sum, cor) => sum + cor.m, 0);
      const totalG = coresData.reduce((sum, cor) => sum + cor.g, 0);
      const totalGg = coresData.reduce((sum, cor) => sum + cor.gg, 0);
      const totalQuantidade = totalPp + totalP + totalM + totalG + totalGg;
      
      const fichaEditada = {
        cluster: document.getElementById('edit-cluster').value.trim(),
        categoria: document.getElementById('edit-categoria').value.trim(),
        referencia: document.getElementById('edit-referencia').value.trim(),
        quantidade: totalQuantidade,
        valorUnitario: Number(document.getElementById('edit-valorUnitario').value),
        valorTotal: Number(document.getElementById('edit-valorUnitario').value) * totalQuantidade,
        pilotagem: document.getElementById('edit-pilotagem').value,
        saida: document.getElementById('edit-saida').value,
        pagamento: document.getElementById('edit-pagamento').value || '',
        entrada: document.getElementById('edit-entrada').value || '',
        observacoes: document.getElementById('edit-observacoes').value.trim(),
        // Dados das cores
        cores: coresData,
        // Totais para compatibilidade
        pp: totalPp,
        p: totalP,
        m: totalM,
        g: totalG,
        gg: totalGg
      };
      
      fichas[editingIndex] = fichaEditada;
      localStorage.setItem('fichas', JSON.stringify(fichas));
      filteredFichas = [...fichas];
      
      closeEditModal();
      renderFichas();
      updateClusterFilter();
      updateCategoriaFilter();
      updatePagamentoFilter();
      updateClusterSelects();
      updateCategoriaSelects();
    };

    // Sistema de cores din√¢micas
    let coresArray = [];
    let corCounter = 0;
    
    function adicionarCor() {
      const coresContainer = document.getElementById('cores-container');
      const novaCorInput = document.getElementById('nova-cor-input');
      const nomeCor = novaCorInput.value.trim();
      
      if (!nomeCor) {
        alert('Por favor, digite o nome da cor/estampa');
        novaCorInput.focus();
        return;
      }
      
      const corId = `cor-${corCounter}`;
      
      const corItem = document.createElement('div');
      corItem.className = 'cor-item';
      corItem.innerHTML = `
        <div class="cor-header">
          <div class="cor-nome">${nomeCor}</div>
          <button type="button" class="remove-cor-btn" onclick="removerCor('${corId}')">
            <span class="material-icons" style="font-size: 0.8rem;">delete</span>
            Remover
          </button>
        </div>
        <div class="tamanhos-grid">
          <div class="tamanho-item">
            <label>PP / 36</label>
            <input type="number" id="${corId}-pp" min="0" value="0" onchange="atualizarQuantidadeTotal()" />
          </div>
          <div class="tamanho-item">
            <label>P / 38</label>
            <input type="number" id="${corId}-p" min="0" value="0" onchange="atualizarQuantidadeTotal()" />
          </div>
          <div class="tamanho-item">
            <label>M / 40</label>
            <input type="number" id="${corId}-m" min="0" value="0" onchange="atualizarQuantidadeTotal()" />
          </div>
          <div class="tamanho-item">
            <label>G / 42</label>
            <input type="number" id="${corId}-g" min="0" value="0" onchange="atualizarQuantidadeTotal()" />
          </div>
          <div class="tamanho-item">
            <label>GG / 44</label>
            <input type="number" id="${corId}-gg" min="0" value="0" onchange="atualizarQuantidadeTotal()" />
          </div>
        </div>
      `;
      
      coresContainer.appendChild(corItem);
      coresArray.push(corId);
      corCounter++;
      
      // Limpar o campo de input
      novaCorInput.value = '';
      novaCorInput.focus();
    }
    
    function removerCor(corId) {
      const corItem = document.querySelector(`[id="${corId}-pp"]`).closest('.cor-item');
      corItem.remove();
      coresArray = coresArray.filter(id => id !== corId);
      atualizarQuantidadeTotal();
    }
    
    function atualizarQuantidadeTotal() {
      let total = 0;
      
      coresArray.forEach(corId => {
        const pp = Number(document.getElementById(`${corId}-pp`).value) || 0;
        const p = Number(document.getElementById(`${corId}-p`).value) || 0;
        const m = Number(document.getElementById(`${corId}-m`).value) || 0;
        const g = Number(document.getElementById(`${corId}-g`).value) || 0;
        const gg = Number(document.getElementById(`${corId}-gg`).value) || 0;
        total += pp + p + m + g + gg;
      });
      
      document.getElementById('quantidade').value = total;
      calcularValorTotal();
    }
    
    // Adicionar primeira cor automaticamente
    document.addEventListener('DOMContentLoaded', function() {
      const addCorBtn = document.getElementById('add-cor-btn');
      const novaCorInput = document.getElementById('nova-cor-input');
      
      if (addCorBtn) {
        addCorBtn.addEventListener('click', adicionarCor);
      }
      
      if (novaCorInput) {
        novaCorInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            adicionarCor();
          }
        });
      }
    });

    // Fechar modal ao clicar fora
    editModal.onclick = function(e) {
      if (e.target === editModal) {
        closeEditModal();
      }
    };

    // Fechar modal de detalhes ao clicar fora
    const detailsModal = document.getElementById('details-modal');
    if (detailsModal) {
      detailsModal.onclick = function(e) {
        if (e.target === detailsModal) {
          closeDetailsModal();
        }
      };
    }

    // Fechar modal de relat√≥rio ao clicar fora
    const reportModal = document.getElementById('report-modal');
    if (reportModal) {
      reportModal.onclick = function(e) {
        if (e.target === reportModal) {
          closeReportModal();
        }
      };
    }

    async function updateClusterFilter() {
      try {
        // Tentar carregar clusters do Firebase primeiro
        const clustersCadastrados = await loadClustersFromFirebase();
        clusterFilter.innerHTML = '<option value="">Todos os Clusters</option>';
        clustersCadastrados.forEach(cluster => {
          const option = document.createElement('option');
          const clusterNome = typeof cluster === 'string' ? cluster : cluster.nome;
          option.value = clusterNome;
          option.textContent = clusterNome;
          clusterFilter.appendChild(option);
        });
      } catch (error) {
        // Fallback para clusters das fichas
        const clusters = [...new Set(fichas.map(f => f.cluster))];
        clusterFilter.innerHTML = '<option value="">Todos os Clusters</option>';
        clusters.forEach(cluster => {
          const option = document.createElement('option');
          option.value = cluster;
          option.textContent = cluster;
          clusterFilter.appendChild(option);
        });
      }
    }

    async function updateCategoriaFilter() {
      try {
        // Tentar carregar categorias do Firebase primeiro
        const categoriasCadastradas = await loadCategoriasFromFirebase();
        categoriaFilter.innerHTML = '<option value="">Todas as Categorias</option>';
        categoriasCadastradas.forEach(categoria => {
          const option = document.createElement('option');
          option.value = categoria;
          option.textContent = categoria;
          categoriaFilter.appendChild(option);
        });
      } catch (error) {
        // Fallback para categorias das fichas
        const categorias = [...new Set(fichas.map(f => f.categoria))];
        categoriaFilter.innerHTML = '<option value="">Todas as Categorias</option>';
        categorias.forEach(categoria => {
          const option = document.createElement('option');
          option.value = categoria;
          option.textContent = categoria;
          categoriaFilter.appendChild(option);
        });
      }
    }

    async function updateCategoriaSelects() {
      const categoriasCadastradas = await loadCategoriasFromFirebase();
      const categoriaSelect = document.getElementById('categoria');
      const editCategoriaSelect = document.getElementById('edit-categoria');
      
      // Atualizar select de cadastro
      if (categoriaSelect) {
        categoriaSelect.innerHTML = '<option value="">Selecione uma categoria</option>';
        categoriasCadastradas.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          categoriaSelect.appendChild(option);
        });
      }
      
      // Atualizar select de edi√ß√£o
      if (editCategoriaSelect) {
        editCategoriaSelect.innerHTML = '<option value="">Selecione uma categoria</option>';
        categoriasCadastradas.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          editCategoriaSelect.appendChild(option);
        });
      }
    }
    
    async function updateClusterSelects() {
      const clustersCadastrados = await loadClustersFromFirebase();
      const clusterSelect = document.getElementById('cluster');
      const editClusterSelect = document.getElementById('edit-cluster');
      
      // Atualizar select de cadastro
      if (clusterSelect) {
        clusterSelect.innerHTML = '<option value="">Selecione um cluster</option>';
        clustersCadastrados.forEach(cluster => {
          const option = document.createElement('option');
          const clusterNome = typeof cluster === 'string' ? cluster : cluster.nome;
          option.value = clusterNome;
          option.textContent = clusterNome;
          clusterSelect.appendChild(option);
        });
      }
      
      // Atualizar select de edi√ß√£o
      if (editClusterSelect) {
        editClusterSelect.innerHTML = '<option value="">Selecione um cluster</option>';
        clustersCadastrados.forEach(cluster => {
          const option = document.createElement('option');
          const clusterNome = typeof cluster === 'string' ? cluster : cluster.nome;
          option.value = clusterNome;
          option.textContent = clusterNome;
          editClusterSelect.appendChild(option);
        });
      }
    }

    clusterFilter.onchange = function() {
      aplicarFiltros();
    };

    categoriaFilter.onchange = function() {
      aplicarFiltros();
    };

    // Event listener para filtro de pagamentos
    document.getElementById('pagamento-filter').onchange = function() {
      aplicarFiltros();
    };

    function updatePagamentoFilter() {
      const pagamentoFilter = document.getElementById('pagamento-filter');
      if (pagamentoFilter) {
        // O filtro de pagamentos n√£o precisa ser atualizado dinamicamente
        // pois as op√ß√µes s√£o fixas: Todos, Pago, N√£o Pago
        pagamentoFilter.value = '';
      }
    }

    function aplicarFiltros() {
      const selectedCluster = clusterFilter.value;
      const selectedCategoria = categoriaFilter.value;
      const selectedPagamento = document.getElementById('pagamento-filter').value;
      
      filteredFichas = fichas.filter(f => {
        const matchCluster = selectedCluster === '' || f.cluster === selectedCluster;
        const matchCategoria = selectedCategoria === '' || f.categoria === selectedCategoria;
        
        // Filtro de pagamento
        let matchPagamento = true;
        if (selectedPagamento === 'pago') {
          matchPagamento = f.pagamento && f.pagamento.trim() !== '';
        } else if (selectedPagamento === 'nao-pago') {
          matchPagamento = !f.pagamento || f.pagamento.trim() === '';
        }
        
        return matchCluster && matchCategoria && matchPagamento;
      });
      
      renderFichas();
    }

    function renderFichas() {
      console.log('Renderizando fichas...', filteredFichas.length);
      
      // Verificar se o elemento existe
      if (!fichasList) {
        console.error('Elemento fichasList n√£o encontrado');
        return;
      }
      
      fichasList.innerHTML = '';
      if (filteredFichas.length === 0) {
        fichasList.innerHTML = `<tr><td colspan="10" style="color:var(--muted);padding:2rem;">Nenhuma ficha encontrada.</td></tr>`;
        return;
      }
      filteredFichas.forEach((ficha, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align: center;">${ficha.cluster}</td>
          <td style="text-align: center;">${ficha.categoria}</td>
          <td style="text-align: center;">${ficha.referencia}</td>
          <td style="text-align: center;">${ficha.quantidade}</td>
          <td style="text-align: center;">R$ ${Number(ficha.valorUnitario).toFixed(2)}</td>
          <td style="text-align: center;">R$ ${Number(ficha.valorTotal).toFixed(2)}</td>
          <td style="text-align: center;">${ficha.pilotagem}</td>
          <td style="text-align: center;">${ficha.saida || '-'}</td>
          <td style="text-align: center;">${ficha.pagamento || '-'}</td>
          <td>
            <div class="action-buttons" style="display: flex; gap: 0.3rem; justify-content: center;">
              <button class="details-btn" title="Ver Detalhes" onclick="showFichaDetails(${idx})" style="background: var(--primary); color: white; border: none; padding: 0.5rem; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; min-width: 36px; height: 36px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                <span class="material-icons" style="font-size: 1rem;">visibility</span>
              </button>
              <button class="edit-btn" title="Editar" onclick="editFicha(${idx})" style="background: transparent; color: var(--warning); border: 1px solid var(--warning); padding: 0.4rem; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; min-width: 32px; height: 32px; transition: all 0.2s ease;" onmouseover="this.style.background='var(--warning)'; this.style.color='white'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='transparent'; this.style.color='var(--warning)'; this.style.transform='scale(1)'">
                <span class="material-icons" style="font-size: 0.875rem;">edit</span>
              </button>
              <button class="delete-btn" title="Excluir" onclick="deleteFicha(${idx})" style="background: transparent; color: var(--error); border: 1px solid var(--error); padding: 0.4rem; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; min-width: 32px; height: 32px; transition: all 0.2s ease;" onmouseover="this.style.background='var(--error)'; this.style.color='white'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='transparent'; this.style.color='var(--error)'; this.style.transform='scale(1)'">
                <span class="material-icons" style="font-size: 0.875rem;">delete</span>
              </button>
            </div>
          </td>
        `;
        fichasList.appendChild(tr);
      });
    }

    // Vari√°veis para filtros do dashboard
    let dashboardFilteredFichas = [...fichas];
    let currentClusterFilter = '';
    let currentPeriodFilter = '';

    // Fun√ß√£o para aplicar filtros do dashboard
    function applyDashboardFilters() {
      const clusterFilter = document.getElementById('dashboard-cluster-filter').value;
      const periodFilter = document.getElementById('dashboard-period-filter').value;

      // Salvar filtros atuais
      currentClusterFilter = clusterFilter;
      currentPeriodFilter = periodFilter;

      // Filtrar fichas
      dashboardFilteredFichas = fichas.filter(ficha => {
        // Filtro por cluster
        const matchCluster = !clusterFilter || ficha.cluster === clusterFilter;

        // Filtro por per√≠odo
        let matchPeriod = true;
        if (periodFilter) {
          const fichaDate = new Date(ficha.saida);
          const daysDiff = (Date.now() - fichaDate.getTime()) / (1000 * 60 * 60 * 24);
          matchPeriod = daysDiff <= parseInt(periodFilter);
        }

        return matchCluster && matchPeriod;
      });

      console.log('Filtros aplicados:', {
        cluster: clusterFilter,
        period: periodFilter,
        fichasFiltradas: dashboardFilteredFichas.length,
        totalFichas: fichas.length
      });

      // Atualizar dashboard com dados filtrados
      updateResumoTecnico();
      renderPieChart();
      renderLineChart();
      renderPieCategoriaChart();
      renderTempoProducaoChart();
    }

    // Fun√ß√£o para limpar filtros do dashboard
    function clearDashboardFilters() {
      document.getElementById('dashboard-cluster-filter').value = '';
      document.getElementById('dashboard-period-filter').value = '';

      // Resetar filtros
      currentClusterFilter = '';
      currentPeriodFilter = '';
      dashboardFilteredFichas = [...fichas];

      console.log('Filtros limpos, mostrando todos os dados');

      // Atualizar dashboard com todos os dados
      updateResumoTecnico();
      renderPieChart();
      renderLineChart();
      renderPieCategoriaChart();
      renderTempoProducaoChart();
    }

    // Fun√ß√£o para atualizar filtro de cluster
    function updateDashboardClusterFilter() {
      const clusterFilter = document.getElementById('dashboard-cluster-filter');
      const clusters = [...new Set(fichas.map(f => f.cluster))];
      
      clusterFilter.innerHTML = '<option value="">Todos os Clusters</option>';
      clusters.forEach(cluster => {
        const option = document.createElement('option');
        option.value = cluster;
        option.textContent = cluster;
        clusterFilter.appendChild(option);
      });
    }



    function renderDashboard() {
      // Atualizar filtros
      updateDashboardClusterFilter();
      
      // Adicionar event listeners para filtros
      document.getElementById('dashboard-cluster-filter').addEventListener('change', applyDashboardFilters);
      document.getElementById('dashboard-period-filter').addEventListener('change', applyDashboardFilters);

      updateResumoTecnico();
      
      // Animar entrada dos gr√°ficos
      const chartElements = document.querySelectorAll('#pieChart, #lineChart, #pieCategoriaChart, #tempoProducaoChart');
      chartElements.forEach((element, index) => {
        setTimeout(() => {
          animateChartEntry(element);
        }, index * 200);
      });
      
      renderPieChart();
      renderLineChart();
      renderPieCategoriaChart();
      renderTempoProducaoChart();
      
      // Adicionar efeitos de hover
      setTimeout(() => {
        addChartHoverEffects();
      }, 1000);
    }

    function updateResumoTecnico() {
      // Usar dados filtrados se houver filtros ativos
      const dataToUse = dashboardFilteredFichas.length > 0 && (currentClusterFilter || currentPeriodFilter) ? dashboardFilteredFichas : fichas;
      
      const totalPecas = dataToUse.reduce((sum, f) => sum + f.quantidade, 0);
      const totalFichas = dataToUse.length;
      const totalValor = dataToUse.reduce((sum, f) => sum + f.valorTotal, 0);
      const totalClusters = new Set(dataToUse.map(f => f.cluster)).size;
      const totalCategorias = new Set(dataToUse.map(f => f.categoria)).size;
      const mediaValor = totalFichas > 0 ? totalValor / totalFichas : 0;
      const mediaPecas = totalFichas > 0 ? totalPecas / totalFichas : 0;
      const pilotagemSim = dataToUse.filter(f => f.pilotagem === 'Sim').length;
      // Calcular valor m√©dio por pe√ßa
      const valorMedioPeca = totalPecas > 0 ? totalValor / totalPecas : 0;

      document.getElementById('total-pecas').textContent = totalPecas.toLocaleString();
      document.getElementById('total-fichas').textContent = totalFichas;
      document.getElementById('total-valor').textContent = `R$ ${totalValor.toFixed(2).replace('.', ',')}`;
      document.getElementById('total-clusters').textContent = totalClusters;
      document.getElementById('total-categorias').textContent = totalCategorias;
      document.getElementById('media-valor').textContent = `R$ ${mediaValor.toFixed(2).replace('.', ',')}`;
      document.getElementById('media-pecas').textContent = Math.round(mediaPecas);

      document.getElementById('valor-medio-peca').textContent = `R$ ${valorMedioPeca.toFixed(2).replace('.', ',')}`;
    }

    // Vari√°veis globais para os gr√°ficos Chart.js
    let pieChart, lineChart, pieCategoriaChart, tempoProducaoChart;

    function renderPieChart() {
      const ctx = document.getElementById('pieChart').getContext('2d');
      
      // Destruir gr√°fico existente se houver
      if (pieChart) {
        pieChart.destroy();
      }
      
      // Usar dados filtrados se houver filtros ativos
      const dataToUse = dashboardFilteredFichas.length > 0 && (currentClusterFilter || currentPeriodFilter) ? dashboardFilteredFichas : fichas;
      
      if (dataToUse.length === 0) {
        document.getElementById('pieChart').style.display = 'none';
        document.getElementById('chart-legend').innerHTML = '<p style="text-align: center; color: var(--text-muted);">Nenhum dado dispon√≠vel</p>';
        return;
      }
      
      document.getElementById('pieChart').style.display = 'block';

      // Calcular dados por cluster
      const clusterData = {};
      let totalPecas = 0;
      
      dataToUse.forEach(ficha => {
        if (!clusterData[ficha.cluster]) {
          clusterData[ficha.cluster] = 0;
        }
        clusterData[ficha.cluster] += ficha.quantidade;
        totalPecas += ficha.quantidade;
      });

      const labels = Object.keys(clusterData);
      const data = Object.values(clusterData);
      const colors = [
        '#3b82f6', '#1d4ed8', '#2563eb', '#1e40af', 
        '#60a5fa', '#3b82f6', '#1d4ed8', '#1e3a8a'
      ];

      pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderColor: '#ffffff',
            borderWidth: 2,
            hoverBorderWidth: 3,
            hoverBorderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: 'rgba(255, 255, 255, 0.2)',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  const percentage = ((value / totalPecas) * 100).toFixed(1);
                  return `${label}: ${value} pe√ßas (${percentage}%)`;
                }
              }
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 1000,
            easing: 'easeOutQuart'
          },
          cutout: '60%',
          radius: '90%'
        }
      });

      // Criar legenda customizada
      const legend = document.getElementById('chart-legend');
      legend.innerHTML = '';
      
      labels.forEach((label, index) => {
        const percentage = ((data[index] / totalPecas) * 100).toFixed(1);
        const legendItem = document.createElement('div');
        legendItem.style.cssText = `
          display: flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.5rem 0.75rem;
          background: var(--surface);
          border-radius: 8px;
          font-size: 0.85rem;
          border: 1px solid var(--border);
          transition: all 0.2s ease;
          cursor: pointer;
        `;
        
        legendItem.innerHTML = `
          <div style="width: 12px; height: 12px; background-color: ${colors[index]}; border-radius: 50%; border: 2px solid #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div>
          <span style="font-weight: 600; color: var(--text);">${label}</span>
          <span style="color: var(--text-secondary); font-size: 0.8rem;">${data[index]} pe√ßas (${percentage}%)</span>
        `;
        
        // Hover effect
        legendItem.addEventListener('mouseenter', () => {
          legendItem.style.background = 'var(--primary-50)';
          legendItem.style.borderColor = 'var(--primary)';
        });
        
        legendItem.addEventListener('mouseleave', () => {
          legendItem.style.background = 'var(--surface)';
          legendItem.style.borderColor = 'var(--border)';
        });
        
        legend.appendChild(legendItem);
      });
    }

    function renderLineChart() {
      const ctx = document.getElementById('lineChart').getContext('2d');
      
      // Destruir gr√°fico existente se houver
      if (lineChart) {
        lineChart.destroy();
      }
      
      // Usar dados filtrados se houver filtros ativos
      const dataToUse = dashboardFilteredFichas.length > 0 && (currentClusterFilter || currentPeriodFilter) ? dashboardFilteredFichas : fichas;
      
      if (dataToUse.length === 0) {
        document.getElementById('lineChart').style.display = 'none';
        return;
      }
      
      document.getElementById('lineChart').style.display = 'block';

      // Agrupar dados por m√™s
      const monthlyData = {};
      dataToUse.forEach(ficha => {
        const date = new Date(ficha.saida);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = 0;
        }
        monthlyData[monthKey] += ficha.quantidade;
      });

      const months = Object.keys(monthlyData).sort();
      const values = months.map(month => monthlyData[month]);
      
      // Formatar labels dos meses
      const monthLabels = months.map(month => {
        const [year, monthNum] = month.split('-');
        const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 
                           'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        return `${monthNames[parseInt(monthNum) - 1]}/${year.slice(2)}`;
      });

      lineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [{
            label: 'Produ√ß√£o Mensal',
            data: values,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8,
            pointHoverBackgroundColor: '#1d4ed8',
            pointHoverBorderColor: '#ffffff',
            pointHoverBorderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: 'rgba(255, 255, 255, 0.2)',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                title: function(context) {
                  return `Per√≠odo: ${context[0].label}`;
                },
                label: function(context) {
                  return `Produ√ß√£o: ${context.parsed.y} pe√ßas`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(226, 232, 240, 0.5)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b',
                font: {
                  size: 12,
                  family: 'Inter'
                }
              }
            },
            y: {
              grid: {
                color: 'rgba(226, 232, 240, 0.5)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b',
                font: {
                  size: 12,
                  family: 'Inter'
                },
                callback: function(value) {
                  return value.toLocaleString('pt-BR');
                }
              }
            }
          },
          animation: {
            duration: 1500,
            easing: 'easeOutQuart'
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          elements: {
            point: {
              hoverRadius: 8
            }
          }
        }
      });
    }

    function calcularValorTotal() {
      const quantidade = Number(document.getElementById('quantidade').value) || 0;
      const valorUnitario = Number(document.getElementById('valorUnitario').value) || 0;
      const valorTotal = quantidade * valorUnitario;
      document.getElementById('valorTotal').value = valorTotal.toFixed(2);
    }

    window.deleteFicha = function(idx) {
      if (confirm('Deseja realmente excluir esta ficha?')) {
        const originalIdx = fichas.indexOf(filteredFichas[idx]);
        fichas.splice(originalIdx, 1);
        localStorage.setItem('fichas', JSON.stringify(fichas));
        filteredFichas = [...fichas];
        renderFichas();
        updateClusterFilter();
        updateCategoriaFilter();
        updatePagamentoFilter();
        updateClusterSelects();
        updateCategoriaSelects();
      }
    }

    fichaForm.onsubmit = async function(e) {
      e.preventDefault();
      
      // Mostrar loading
      showGlobalLoading();
      
      try {
      // Valida√ß√£o dos campos obrigat√≥rios
      const cluster = document.getElementById('cluster').value.trim();
      const categoria = document.getElementById('categoria').value.trim();
      const referencia = document.getElementById('referencia').value.trim();
      const entrada = document.getElementById('entrada').value;
      const saida = document.getElementById('saida').value;
      const pagamento = document.getElementById('pagamento').value;
      const pilotagem = document.getElementById('pilotagem').value;
      const valorUnitario = Number(document.getElementById('valorUnitario').value);
      const quantidade = Number(document.getElementById('quantidade').value);
      const observacoes = document.getElementById('observacoes').value.trim();
      
      // Verificar campos obrigat√≥rios
      if (!cluster) {
        alert('Por favor, preencha o campo Cluster');
        document.getElementById('cluster').focus();
        return;
      }
      if (!categoria) {
        alert('Por favor, selecione uma categoria');
        document.getElementById('categoria').focus();
        return;
      }
      if (!referencia) {
        alert('Por favor, preencha o campo Refer√™ncia');
        document.getElementById('referencia').focus();
        return;
      }
      if (!saida) {
        alert('Por favor, preencha a data de remessa');
        document.getElementById('saida').focus();
        return;
      }
      if (!pilotagem) {
        alert('Por favor, selecione se h√° pilotagem');
        document.getElementById('pilotagem').focus();
        return;
      }
      if (!valorUnitario || valorUnitario <= 0) {
        alert('Por favor, preencha um valor unit√°rio v√°lido');
        document.getElementById('valorUnitario').focus();
        return;
      }
      if (!quantidade || quantidade <= 0) {
        alert('Por favor, preencha a quantidade de pe√ßas');
        document.getElementById('quantidade').focus();
        return;
      }
      
      // Valida√ß√£o de datas
      if (entrada && saida) {
        const dataRemessa = new Date(saida);
        const dataRecebimento = new Date(entrada);
        
        if (dataRecebimento < dataRemessa) {
          alert('‚ùå Data de Recebimento n√£o pode ser inferior √† Data de Remessa!\n\nData de Remessa: ' + dataRemessa.toLocaleDateString('pt-BR') + '\nData de Recebimento: ' + dataRecebimento.toLocaleDateString('pt-BR'));
          document.getElementById('entrada').focus();
          return;
        }
      }
      
      // Coletar dados das cores
      const coresData = [];
      coresArray.forEach(corId => {
        const corElement = document.querySelector(`[id="${corId}-pp"]`).closest('.cor-item');
        const nomeCor = corElement.querySelector('.cor-nome').textContent;
        
        const corData = {
          id: corId,
          nome: nomeCor,
          pp: Number(document.getElementById(`${corId}-pp`).value) || 0,
          p: Number(document.getElementById(`${corId}-p`).value) || 0,
          m: Number(document.getElementById(`${corId}-m`).value) || 0,
          g: Number(document.getElementById(`${corId}-g`).value) || 0,
          gg: Number(document.getElementById(`${corId}-gg`).value) || 0
        };
        coresData.push(corData);
      });
      
      const ficha = {
        cluster: cluster,
        categoria: categoria,
        referencia: referencia,
        quantidade: quantidade,
        valorUnitario: valorUnitario,
        valorTotal: Number(document.getElementById('valorTotal').value),
        pilotagem: pilotagem,
        saida: saida,
        pagamento: pagamento || '',
        entrada: entrada || '',
        observacoes: observacoes,
        cores: coresData,
        // Manter compatibilidade com dados antigos
        pp: coresData.reduce((sum, cor) => sum + cor.pp, 0),
        p: coresData.reduce((sum, cor) => sum + cor.p, 0),
        m: coresData.reduce((sum, cor) => sum + cor.m, 0),
        g: coresData.reduce((sum, cor) => sum + cor.g, 0),
        gg: coresData.reduce((sum, cor) => sum + cor.gg, 0)
      };
      
      // Adicionar ficha ao Firebase
      try {
        console.log('üîÑ Salvando ficha no Firebase...');
        
        if (window.FirebaseAuth) {
          const fichaId = await window.FirebaseAuth.addFicha(ficha);
          console.log('‚úÖ Ficha salva no Firebase com ID:', fichaId);
          
          // Recarregar fichas do Firebase
          await loadFichasFromFirebase();
        } else {
          console.error('‚ùå FirebaseAuth n√£o est√° dispon√≠vel, salvando no localStorage');
          // Fallback para localStorage
          fichas.push(ficha);
          localStorage.setItem('fichas', JSON.stringify(fichas));
          filteredFichas = [...fichas];
        }
        
        console.log('Ficha adicionada:', ficha);
        console.log('Total de fichas:', fichas.length);
      } catch (error) {
        console.error('‚ùå Erro ao salvar ficha no Firebase:', error);
        // Fallback para localStorage
        fichas.push(ficha);
        localStorage.setItem('fichas', JSON.stringify(fichas));
        filteredFichas = [...fichas];
      }
      
      // Limpar formul√°rio
      fichaForm.reset();
      
      // Resetar cores
      const coresContainer = document.getElementById('cores-container');
      const novaCorInput = document.getElementById('nova-cor-input');
      
      if (coresContainer) {
        coresContainer.innerHTML = '';
        coresArray = [];
        corCounter = 0;
      }
      
      if (novaCorInput) {
        novaCorInput.value = '';
      }
      
      // Resetar quantidade e valor total
      document.getElementById('quantidade').value = '0';
      document.getElementById('valorTotal').value = '0.00';
      
      // Limpar campo de observa√ß√µes
      document.getElementById('observacoes').value = '';
      
      // Mostrar mensagem de sucesso
      alert('Ficha cadastrada com sucesso!');
      
      // Atualizar filtros e selects
      updateClusterFilter();
      updateCategoriaFilter();
      updatePagamentoFilter();
      
      // Redirecionar para a lista
      switchScreen('list');
    } catch (error) {
      console.error('‚ùå Erro ao cadastrar ficha:', error);
      alert('Erro ao cadastrar ficha. Tente novamente.');
    } finally {
      hideGlobalLoading();
    }
    };

    // Atualizar quantidade automaticamente ao alterar tamanhos na edi√ß√£o
    function atualizarQuantidadeEdit() {
      const pp = Number(document.getElementById('edit-pp').value) || 0;
      const p = Number(document.getElementById('edit-p').value) || 0;
      const m = Number(document.getElementById('edit-m').value) || 0;
      const g = Number(document.getElementById('edit-g').value) || 0;
      const gg = Number(document.getElementById('edit-gg').value) || 0;
      const total = pp + p + m + g + gg;
      document.getElementById('edit-quantidade').value = total;
      calcularValorTotalEdit();
    }
    document.getElementById('edit-pp').addEventListener('input', atualizarQuantidadeEdit);
    document.getElementById('edit-p').addEventListener('input', atualizarQuantidadeEdit);
    document.getElementById('edit-m').addEventListener('input', atualizarQuantidadeEdit);
    document.getElementById('edit-g').addEventListener('input', atualizarQuantidadeEdit);
    document.getElementById('edit-gg').addEventListener('input', atualizarQuantidadeEdit);

    // Fun√ß√µes de configura√ß√µes
    configForm.onsubmit = function(e) {
      e.preventDefault();
      const config = {
        empresaNome: document.getElementById('empresa-nome').value.trim(),
        empresaCnpj: document.getElementById('empresa-cnpj').value.trim(),
        empresaEndereco: document.getElementById('empresa-endereco').value.trim(),
        empresaTelefone: document.getElementById('empresa-telefone').value.trim()
      };
      localStorage.setItem('config', JSON.stringify(config));
      alert('Configura√ß√µes salvas com sucesso!');
      // Atualizar a √∫ltima atualiza√ß√£o
      document.getElementById('ultima-atualizacao').textContent = new Date().toLocaleDateString();
    };

    function exportarDados() {
      const data = JSON.stringify(fichas, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'fichas_followup.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert('Dados exportados com sucesso!');
    }

    function importarDados() {
      const input = document.getElementById('import-file');
      input.click();
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const importedData = JSON.parse(e.target.result);
              if (Array.isArray(importedData)) {
                fichas = importedData;
                localStorage.setItem('fichas', JSON.stringify(fichas));
                filteredFichas = [...fichas];
    renderFichas();
    updateClusterFilter();
    updateCategoriaFilter();
    updatePagamentoFilter();
                alert('Dados importados com sucesso!');
              } else {
                alert('O arquivo selecionado n√£o cont√©m um array de fichas v√°lido.');
              }
            } catch (error) {
              alert('Erro ao importar dados: ' + error.message);
            }
          };
          reader.readAsText(file);
        }
      };
    }

    function limparTodosDados() {
      if (confirm('Tem certeza de que deseja limpar todos os dados? Esta a√ß√£o √© irrevers√≠vel.')) {
        localStorage.removeItem('fichas');
        localStorage.removeItem('config');
        fichas = [];
        filteredFichas = [];
        renderFichas();
        updateClusterFilter();
        updateCategoriaFilter();
        updatePagamentoFilter();
        alert('Todos os dados foram removidos com sucesso!');
        // Atualizar a √∫ltima atualiza√ß√£o
        document.getElementById('ultima-atualizacao').textContent = new Date().toLocaleDateString();
        document.getElementById('total-fichas-config').textContent = 0;
        document.getElementById('espaco-usado').textContent = '0 KB';
      }
    }

    function atualizarInformacoesSistema() {
      // Atualizar total de fichas
      document.getElementById('total-fichas-config').textContent = fichas.length;
      
      // Calcular espa√ßo usado
      const dados = {
        fichas: fichas,
        config: JSON.parse(localStorage.getItem('config') || '{}'),
        categorias: JSON.parse(localStorage.getItem('categoriasCadastradas') || '[]')
      };
      const tamanhoBytes = new Blob([JSON.stringify(dados)]).size;
      const tamanhoKB = (tamanhoBytes / 1024).toFixed(2);
      document.getElementById('espaco-usado').textContent = `${tamanhoKB} KB`;
      
      // Atualizar √∫ltima atualiza√ß√£o
      const ultimaAtualizacao = localStorage.getItem('ultimaAtualizacao') || new Date().toLocaleDateString();
      document.getElementById('ultima-atualizacao').textContent = ultimaAtualizacao;
    }

    // Inicializa√ß√£o
    switchScreen('dashboard');
    updateClusterFilter();
    updateCategoriaFilter();
    updatePagamentoFilter();
    updateCategoriaSelects();
    updateClusterSelects();
    
    // Adicionar categorias padr√£o se n√£o existirem
    const categoriasExistentes = JSON.parse(localStorage.getItem('categoriasCadastradas') || '[]');
    if (categoriasExistentes.length === 0) {
      const categoriasPadrao = ['Camisetas', 'Cal√ßas', 'Vestidos', 'Blusas', 'Jaquetas', 'Shorts', 'Saias', 'Outros'];
      localStorage.setItem('categoriasCadastradas', JSON.stringify(categoriasPadrao));
      updateCategoriaSelects();
    }
    
    // Adicionar clusters padr√£o se n√£o existirem
    const clustersExistentes = JSON.parse(localStorage.getItem('clustersCadastrados') || '[]');
    if (clustersExistentes.length === 0) {
      const clustersPadrao = ['Cluster A', 'Cluster B', 'Cluster C', 'Cluster D', 'Cluster E'];
      localStorage.setItem('clustersCadastrados', JSON.stringify(clustersPadrao));
    }
    
    // Salvar data da √∫ltima atualiza√ß√£o
    localStorage.setItem('ultimaAtualizacao', new Date().toLocaleDateString());

    function renderTempoProducaoChart() {
      const ctx = document.getElementById('tempoProducaoChart').getContext('2d');
      
      // Destruir gr√°fico existente se houver
      if (tempoProducaoChart) {
        tempoProducaoChart.destroy();
      }
      
      // Usar dados filtrados se houver filtros ativos
      const dataToUse = dashboardFilteredFichas.length > 0 && (currentClusterFilter || currentPeriodFilter) ? dashboardFilteredFichas : fichas;
      
      if (dataToUse.length === 0) {
        document.getElementById('tempoProducaoChart').style.display = 'none';
        return;
      }
      
      document.getElementById('tempoProducaoChart').style.display = 'block';

      // Calcular tempo m√©dio de produ√ß√£o por categoria
      const categoriaTempos = {};
      const categoriaCounts = {};
      
      dataToUse.forEach(f => {
        const entrada = new Date(f.entrada);
        const saida = new Date(f.saida);
        const diff = (saida - entrada) / (1000 * 60 * 60 * 24);
        const tempo = isNaN(diff) ? 0 : Math.max(0, Math.round(diff));
        
        if (!categoriaTempos[f.categoria]) {
          categoriaTempos[f.categoria] = 0;
          categoriaCounts[f.categoria] = 0;
        }
        categoriaTempos[f.categoria] += tempo;
        categoriaCounts[f.categoria]++;
      });

      // Calcular tempo m√©dio por categoria
      const labels = Object.keys(categoriaTempos);
      const data = labels.map(categoria => {
        const totalTempo = categoriaTempos[categoria];
        const count = categoriaCounts[categoria];
        return Math.round(totalTempo / count);
      });

      tempoProducaoChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Tempo de Produ√ß√£o (dias)',
            data: data,
            backgroundColor: 'rgba(245, 158, 11, 0.8)',
            borderColor: '#f59e0b',
            borderWidth: 2,
            borderRadius: 6,
            borderSkipped: false,
            hoverBackgroundColor: 'rgba(245, 158, 11, 1)',
            hoverBorderColor: '#d97706',
            hoverBorderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: 'rgba(255, 255, 255, 0.2)',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  const dias = context.parsed.x;
                  const categoria = context[0].label;
                  const count = categoriaCounts[categoria];
                  return `${dias} dia${dias === 1 ? '' : 's'} (m√©dia de ${count} ficha${count === 1 ? '' : 's'})`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(226, 232, 240, 0.5)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b',
                font: {
                  size: 12,
                  family: 'Inter'
                },
                callback: function(value) {
                  return `${value} dia${value === 1 ? '' : 's'}`;
                }
              }
            },
            y: {
              grid: {
                display: false
              },
              ticks: {
                color: '#64748b',
                font: {
                  size: 11,
                  family: 'Inter'
                },
                maxRotation: 0
              }
            }
          },
          animation: {
            duration: 1500,
            easing: 'easeOutQuart'
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
    }

    function renderPieCategoriaChart() {
      const ctx = document.getElementById('pieCategoriaChart').getContext('2d');
      
      // Destruir gr√°fico existente se houver
      if (pieCategoriaChart) {
        pieCategoriaChart.destroy();
      }
      
      // Usar dados filtrados se houver filtros ativos
      const dataToUse = dashboardFilteredFichas.length > 0 && (currentClusterFilter || currentPeriodFilter) ? dashboardFilteredFichas : fichas;
      
      if (dataToUse.length === 0) {
        document.getElementById('pieCategoriaChart').style.display = 'none';
        document.getElementById('pie-categoria-legend').innerHTML = '<p style="text-align: center; color: var(--text-muted);">Nenhum dado dispon√≠vel</p>';
        return;
      }
      
      document.getElementById('pieCategoriaChart').style.display = 'block';

      // Calcular dados por categoria
      const categoriaData = {};
      let totalPecas = 0;
      
      dataToUse.forEach(ficha => {
        if (!categoriaData[ficha.categoria]) {
          categoriaData[ficha.categoria] = 0;
        }
        categoriaData[ficha.categoria] += ficha.quantidade;
        totalPecas += ficha.quantidade;
      });

      const labels = Object.keys(categoriaData);
      const data = Object.values(categoriaData);
      const colors = [
        '#10b981', '#059669', '#047857', '#065f46',
        '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'
      ];

      pieCategoriaChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderColor: '#ffffff',
            borderWidth: 2,
            hoverBorderWidth: 3,
            hoverBorderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: 'rgba(255, 255, 255, 0.2)',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  const percentage = ((value / totalPecas) * 100).toFixed(1);
                  return `${label}: ${value} pe√ßas (${percentage}%)`;
                }
              }
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 1000,
            easing: 'easeOutQuart'
          },
          cutout: '60%',
          radius: '90%'
        }
      });

      // Criar legenda customizada
      const legend = document.getElementById('pie-categoria-legend');
      if (legend) {
        legend.innerHTML = '';
        
        labels.forEach((label, index) => {
          const percentage = ((data[index] / totalPecas) * 100).toFixed(1);
          const legendItem = document.createElement('div');
          legendItem.style.cssText = `
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--surface);
            border-radius: 8px;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            cursor: pointer;
          `;
          
          legendItem.innerHTML = `
            <div style="width: 12px; height: 12px; background-color: ${colors[index]}; border-radius: 50%; border: 2px solid #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div>
            <span style="font-weight: 600; color: var(--text);">${label}</span>
            <span style="color: var(--text-secondary); font-size: 0.8rem;">${data[index]} pe√ßas (${percentage}%)</span>
          `;
          
          // Hover effect
          legendItem.addEventListener('mouseenter', () => {
            legendItem.style.background = 'var(--success-light)';
            legendItem.style.borderColor = 'var(--success)';
          });
          
          legendItem.addEventListener('mouseleave', () => {
            legendItem.style.background = 'var(--surface)';
            legendItem.style.borderColor = 'var(--border)';
          });
          
          legend.appendChild(legendItem);
        });
      }
    }

    // Sidebar retr√°til responsiva (usar vari√°veis j√° declaradas no in√≠cio do script)
    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      sidebar.classList.remove('translate-x-0');
    }
    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      sidebar.classList.add('translate-x-0');
    }
    
    // Verificar se estamos em mobile
    function isMobile() {
      return window.innerWidth < 768;
    }
    
    // Inicializar estado da sidebar baseado no tamanho da tela
    function initializeSidebar() {
      if (isMobile()) {
        closeSidebar();
      } else {
        openSidebar();
      }
    }
    
    // Inicializar sidebar
    initializeSidebar();
    
    mobileMenuToggle.addEventListener('click', function() {
      console.log('üîÑ Bot√£o de menu mobile clicado');
      console.log('üì± Estado atual da sidebar:', sidebar.classList.contains('-translate-x-full') ? 'fechada' : 'aberta');
      
      if (sidebar.classList.contains('-translate-x-full')) {
        console.log('üì± Abrindo sidebar...');
        openSidebar();
      } else {
        console.log('üì± Fechando sidebar...');
        closeSidebar();
      }
    });
    
    // Atualizar sidebar quando a tela √© redimensionada
    window.addEventListener('resize', function() {
      if (!isMobile()) {
        openSidebar();
      } else {
        closeSidebar();
      }
    });
    // Fecha sidebar ao clicar fora no mobile
    document.addEventListener('click', function(e) {
      if (window.innerWidth < 768 && !sidebar.contains(e.target) && !mobileMenuToggle.contains(e.target)) {
        closeSidebar();
      }
    });
    // Fecha sidebar ao navegar
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        if (window.innerWidth < 768) closeSidebar();
      });
    });
    
    // Event listener para o bot√£o de logout
    document.getElementById('logout-button').addEventListener('click', async () => {
      try {
        console.log('üîÑ Bot√£o de logout clicado...');
        
        // Feedback visual - desabilitar bot√£o
        const logoutButton = document.getElementById('logout-button');
        const originalText = logoutButton.innerHTML;
        logoutButton.innerHTML = `
          <span class="material-icons">hourglass_empty</span>
          <span>Saindo...</span>
        `;
        logoutButton.style.pointerEvents = 'none';
        logoutButton.style.opacity = '0.7';
        
        // Executar logout
        await logout();
        
      } catch (error) {
        console.error('‚ùå Erro ao fazer logout:', error);
        console.error('‚ùå Detalhes do erro:', error.message);
        
        // Restaurar bot√£o em caso de erro
        const logoutButton = document.getElementById('logout-button');
        logoutButton.innerHTML = `
          <span class="material-icons">logout</span>
          <span>Sair</span>
        `;
        logoutButton.style.pointerEvents = 'auto';
        logoutButton.style.opacity = '1';
        
        // Mesmo com erro, redirecionar para login
        setTimeout(() => {
          console.log('üîÑ Redirecionando para login ap√≥s erro...');
          const timestamp = Date.now();
          const loginUrl = `index.html?t=${timestamp}&logout=true&error=true`;
          window.location.href = loginUrl;
        }, 1000);
      }
    });

    // Fun√ß√£o para animar entrada dos gr√°ficos
    function animateChartEntry(chartElement) {
      chartElement.style.opacity = '0';
      chartElement.style.transform = 'scale(0.9)';
      
      setTimeout(() => {
        chartElement.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
        chartElement.style.opacity = '1';
        chartElement.style.transform = 'scale(1)';
      }, 100);
    }
    
    // Fun√ß√£o para adicionar efeitos de hover nos containers dos gr√°ficos
    function addChartHoverEffects() {
      const chartContainers = document.querySelectorAll('[id*="Chart"]').forEach(container => {
        if (container.parentElement) {
          const parent = container.parentElement;
          parent.style.transition = 'all 0.3s ease';
          
          parent.addEventListener('mouseenter', () => {
            parent.style.transform = 'translateY(-4px)';
            parent.style.boxShadow = 'var(--shadow-xl)';
          });
          
          parent.addEventListener('mouseleave', () => {
            parent.style.transform = 'translateY(0)';
            parent.style.boxShadow = 'var(--shadow)';
          });
        }
      });
    }

    // Fun√ß√£o para adicionar cor no modal de edi√ß√£o
    function adicionarCorEdit() {
      const novaCorInput = document.getElementById('edit-nova-cor-input');
      const nomeCor = novaCorInput.value.trim();
      
      if (!nomeCor) {
        alert('Por favor, digite o nome da cor/estampa');
        return;
      }
      
      const corId = `edit-cor-${editCorCounter++}`;
      const coresContainer = document.getElementById('edit-cores-container');
      
      const corItem = document.createElement('div');
      corItem.className = 'cor-item';
      corItem.id = corId;
      corItem.style.cssText = `
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow);
      `;
      
      corItem.innerHTML = `
        <div class="cor-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <span class="cor-nome" style="font-weight: 600; color: var(--text); font-size: 1rem;">${nomeCor}</span>
          <button type="button" class="remove-cor-btn" onclick="removerCorEdit('${corId}')" style="background: var(--error); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
            <span class="material-icons" style="font-size: 1rem;">delete</span>
            Remover
          </button>
        </div>
        <div class="tamanhos-grid">
          <div class="tamanho-item">
            <label>PP / 36</label>
            <input type="number" min="0" value="0" onchange="atualizarQuantidadeTotalEdit()" />
          </div>
          <div class="tamanho-item">
            <label>P / 38</label>
            <input type="number" min="0" value="0" onchange="atualizarQuantidadeTotalEdit()" />
          </div>
          <div class="tamanho-item">
            <label>M / 40</label>
            <input type="number" min="0" value="0" onchange="atualizarQuantidadeTotalEdit()" />
          </div>
          <div class="tamanho-item">
            <label>G / 42</label>
            <input type="number" min="0" value="0" onchange="atualizarQuantidadeTotalEdit()" />
          </div>
          <div class="tamanho-item">
            <label>GG / 44</label>
            <input type="number" min="0" value="0" onchange="atualizarQuantidadeTotalEdit()" />
          </div>
        </div>
      `;
      
      coresContainer.appendChild(corItem);
      editCoresArray.push({ id: corId, nome: nomeCor });
      
      novaCorInput.value = '';
      novaCorInput.focus();
      atualizarQuantidadeTotalEdit();
    }
    
    // Fun√ß√£o para remover cor no modal de edi√ß√£o
    function removerCorEdit(corId) {
      const corItem = document.getElementById(corId);
      if (corItem) {
        corItem.remove();
        editCoresArray = editCoresArray.filter(cor => cor.id !== corId);
        atualizarQuantidadeTotalEdit();
      }
    }
    
    // Fun√ß√£o para atualizar quantidade total no modal de edi√ß√£o
    function atualizarQuantidadeTotalEdit() {
      const coresItems = document.querySelectorAll('#edit-cores-container .cor-item');
      let totalQuantidade = 0;
      
      coresItems.forEach(corItem => {
        const inputs = corItem.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
          totalQuantidade += parseInt(input.value) || 0;
        });
      });
      
      document.getElementById('edit-quantidade').value = totalQuantidade;
      calcularValorTotalEdit();
    }

    // Event listeners para o modal de edi√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
      const editAddCorBtn = document.getElementById('edit-add-cor-btn');
      const editNovaCorInput = document.getElementById('edit-nova-cor-input');
      
      if (editAddCorBtn) {
        editAddCorBtn.addEventListener('click', adicionarCorEdit);
      }
      
      if (editNovaCorInput) {
        editNovaCorInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            adicionarCorEdit();
          }
        });
      }
    });

    // Fun√ß√£o para carregar configura√ß√µes da empresa
    async function carregarConfiguracoesEmpresa() {
      console.log('üìã Iniciando carregamento das configura√ß√µes da empresa...');
      console.log('üïê Timestamp:', new Date().toLocaleTimeString());
      
      // Aguardar um pouco para garantir que o DOM est√° carregado
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Verificar se os elementos existem
      const elementos = {
        empresaInfoDisplay: document.getElementById('empresa-info-display'),
        empresaAddButton: document.getElementById('empresa-add-button'),
        configForm: document.getElementById('config-form'),
        empresaNome: document.getElementById('empresa-nome'),
        empresaCnpj: document.getElementById('empresa-cnpj'),
        empresaEndereco: document.getElementById('empresa-endereco'),
        empresaTelefone: document.getElementById('empresa-telefone'),
        empresaFotoPreview: document.getElementById('empresa-foto-preview'),
        empresaFotoPlaceholder: document.getElementById('empresa-foto-placeholder')
      };
      
      console.log('üîç Verificando elementos da interface:', elementos);
      
      // Verificar se todos os elementos existem
      for (const [key, element] of Object.entries(elementos)) {
        if (!element) {
          console.error(`‚ùå Elemento n√£o encontrado: ${key}`);
        }
      }
      
      let empresaData = null;
      
      try {
        // Tentar carregar do Firebase primeiro
        if (window.FirebaseAuth && typeof window.FirebaseAuth.getEmpresaConfig === 'function') {
          console.log('üî• Tentando carregar do Firebase...');
          try {
            empresaData = await window.FirebaseAuth.getEmpresaConfig();
            console.log('üìä Dados do Firebase:', empresaData);
          } catch (firebaseError) {
            console.log('‚ùå Erro ao carregar do Firebase:', firebaseError.message);
            empresaData = null;
          }
        } else {
          console.log('‚ö†Ô∏è Firebase Auth n√£o dispon√≠vel');
        }
      } catch (error) {
        console.log('‚ùå Erro geral ao carregar do Firebase:', error);
      }
      
      // Se n√£o conseguiu do Firebase, tentar localStorage
      if (!empresaData || !empresaData.nome) {
        console.log('üíæ Tentando carregar do localStorage...');
        try {
      const configEmpresa = JSON.parse(localStorage.getItem('configEmpresa') || '{}');
          const empresaConfigLocal = JSON.parse(localStorage.getItem('empresaConfig') || '{}');
          
          console.log('üìä Dados do localStorage configEmpresa:', configEmpresa);
          console.log('üìä Dados do localStorage empresaConfig:', empresaConfigLocal);
          
          // Usar dados do localStorage se Firebase n√£o retornou dados v√°lidos
          empresaData = configEmpresa.nome ? configEmpresa : (empresaConfigLocal.nome ? empresaConfigLocal : null);
        } catch (parseError) {
          console.error('‚ùå Erro ao fazer parse do localStorage:', parseError);
          empresaData = null;
        }
      }
      
      console.log('üîç Dados finais encontrados:', empresaData);
      
      if (empresaData && empresaData.nome && empresaData.nome.trim() !== '') {
        console.log('‚úÖ Empresa encontrada:', empresaData.nome);
        
        // For√ßar exibi√ß√£o das informa√ß√µes da empresa
        console.log('üè¢ For√ßando exibi√ß√£o das informa√ß√µes da empresa...');
        
        // Ocultar formul√°rio se existir
        if (elementos.configForm) {
          elementos.configForm.style.display = 'none';
          console.log('‚úÖ Formul√°rio ocultado');
        }
        
        // Ocultar bot√£o de adicionar se existir
        if (elementos.empresaAddButton) {
          elementos.empresaAddButton.style.display = 'none';
          console.log('‚úÖ Bot√£o de adicionar ocultado');
        }
        
        // Mostrar se√ß√£o de informa√ß√µes
        if (elementos.empresaInfoDisplay) {
          elementos.empresaInfoDisplay.style.display = 'block';
          console.log('‚úÖ Se√ß√£o de informa√ß√µes exibida');
          
          // Preencher informa√ß√µes
          const nomeDisplay = document.getElementById('empresa-nome-display-info');
          const cnpjDisplay = document.getElementById('empresa-cnpj-display-info');
          const enderecoDisplay = document.getElementById('empresa-endereco-display-info');
          const telefoneDisplay = document.getElementById('empresa-telefone-display-info');
          
          if (nomeDisplay) nomeDisplay.textContent = empresaData.nome || '-';
          if (cnpjDisplay) cnpjDisplay.textContent = empresaData.cnpj || '-';
          if (enderecoDisplay) enderecoDisplay.textContent = empresaData.endereco || '-';
          if (telefoneDisplay) telefoneDisplay.textContent = empresaData.telefone || '-';
          
          console.log('‚úÖ Informa√ß√µes preenchidas na interface');
          
          // Mostrar logo se existir
          const logoImg = document.getElementById('empresa-logo-img');
          const logoPlaceholder = document.getElementById('empresa-logo-placeholder');
          
          if (empresaData.fotoUrl && logoImg && logoPlaceholder) {
            logoImg.src = empresaData.fotoUrl;
            logoImg.style.display = 'block';
            logoPlaceholder.style.display = 'none';
            console.log('‚úÖ Logo da empresa exibida');
          } else if (logoImg && logoPlaceholder) {
            logoImg.style.display = 'none';
            logoPlaceholder.style.display = 'block';
            console.log('‚úÖ Placeholder do logo exibido');
          }
        } else {
          console.error('‚ùå Elemento empresa-info-display n√£o encontrado');
        }
        
        // Atualizar top menu
        if (typeof updateEmpresaMenuInfo === 'function') {
          try {
            await updateEmpresaMenuInfo();
            console.log('‚úÖ Top menu atualizado');
          } catch (menuError) {
            console.error('‚ùå Erro ao atualizar top menu:', menuError);
          }
        }
        
      } else {
        console.log('‚ÑπÔ∏è Nenhuma empresa cadastrada encontrada');
        // N√£o mostrar nada - a se√ß√£o ficar√° vazia
      }
      
      console.log('‚úÖ Fun√ß√£o carregarConfiguracoesEmpresa conclu√≠da');
      
      // For√ßar exibi√ß√£o ap√≥s um pequeno delay
      setTimeout(() => {
        console.log('üîÑ Chamando forcarExibicaoEmpresa...');
        forcarExibicaoEmpresa();
      }, 500);
    }
    

    
    // Fun√ß√£o para atualizar nome da empresa no header
    function atualizarNomeEmpresaHeader(nomeEmpresa) {
      const empresaInfo = document.getElementById('empresa-info');
      const empresaNomeDisplay = document.getElementById('empresa-nome-display');
      
      if (nomeEmpresa && nomeEmpresa.trim() !== '') {
        empresaNomeDisplay.textContent = nomeEmpresa;
        empresaInfo.style.display = 'flex';
      } else {
        empresaInfo.style.display = 'none';
      }
    }
    
    // Fun√ß√£o para adicionar event listener ao formul√°rio
    function adicionarEventListenerFormulario() {
      console.log('üîó Adicionando event listener ao formul√°rio...');
      
      const configForm = document.getElementById('config-form');
      if (!configForm) {
        console.error('‚ùå Formul√°rio n√£o encontrado para adicionar event listener');
        return;
      }
      
      console.log('‚úÖ Formul√°rio encontrado, adicionando event listener...');
      
      // Remover event listeners existentes
      const newForm = configForm.cloneNode(true);
      configForm.parentNode.replaceChild(newForm, configForm);
      
      // Adicionar novo event listener
      newForm.addEventListener('submit', async function(e) {
      e.preventDefault();
        console.log('üéØ Event listener do formul√°rio disparado!');
        
        try {
          // Obter valores dos campos
          const nome = document.getElementById('empresa-nome').value.trim();
          const cnpj = document.getElementById('empresa-cnpj').value.trim();
          const endereco = document.getElementById('empresa-endereco').value.trim();
          const telefone = document.getElementById('empresa-telefone').value.trim();
          const fotoPreview = document.getElementById('empresa-foto-preview');
          const fotoUrl = fotoPreview ? fotoPreview.src || '' : '';
          
          console.log('üìù Valores dos campos:', { nome, cnpj, endereco, telefone });
          console.log('üì∏ Verifica√ß√£o da foto:');
          console.log('- Elemento foto-preview encontrado:', !!fotoPreview);
          console.log('- URL da foto:', fotoUrl);
          console.log('- Tamanho da URL:', fotoUrl.length, 'caracteres');
          console.log('- √â uma URL v√°lida:', fotoUrl.startsWith('data:image/'));
          
          // Validar campo obrigat√≥rio
          if (!nome) {
            alert('O campo "Nome da Empresa" √© obrigat√≥rio!');
            document.getElementById('empresa-nome').focus();
            return;
          }
      
      const configEmpresa = {
            nome: nome,
            cnpj: cnpj || '',
            endereco: endereco || '',
            telefone: telefone || '',
            fotoUrl: fotoUrl
          };
          
          console.log('üìù Dados da empresa para salvar:', configEmpresa);
          
          // Salvar no Firebase se dispon√≠vel
          if (window.FirebaseAuth) {
            console.log('üî• Salvando no Firebase...');
            console.log('üìã Fun√ß√£o saveEmpresaConfig:', typeof window.FirebaseAuth.saveEmpresaConfig);
            
            try {
              await window.FirebaseAuth.saveEmpresaConfig(configEmpresa);
              console.log('‚úÖ Configura√ß√µes da empresa salvas no Firebase');
            } catch (firebaseError) {
              console.error('‚ùå Erro espec√≠fico do Firebase:', firebaseError);
              console.error('‚ùå Stack trace:', firebaseError.stack);
              throw firebaseError;
            }
          } else {
            console.log('‚ö†Ô∏è Firebase n√£o dispon√≠vel, salvando apenas no localStorage');
          }
          
          // Salvar no localStorage como backup
      localStorage.setItem('configEmpresa', JSON.stringify(configEmpresa));
          console.log('üíæ Dados salvos no localStorage');
      
      // Atualizar exibi√ß√£o na barra superior
      atualizarNomeEmpresaHeader(configEmpresa.nome);
          
          // Mostrar informa√ß√µes da empresa
          mostrarInformacoesEmpresa(configEmpresa);
          
          // Ocultar bot√£o de emerg√™ncia
          const emergencyButton = document.getElementById('emergency-button');
          if (emergencyButton) {
            emergencyButton.style.display = 'none';
          }
          
          // Atualizar texto do bot√£o para indicar que √© uma edi√ß√£o
          const submitButton = document.querySelector('#config-form button[type="submit"]');
          if (submitButton) {
            submitButton.textContent = 'Salvar Configura√ß√µes';
          }
      
      // Feedback visual
          alert('Configura√ß√µes da empresa salvas com sucesso!');
          
        } catch (error) {
          console.error('‚ùå Erro ao salvar configura√ß√µes:', error);
          alert('Erro ao salvar configura√ß√µes: ' + error.message);
        }
      });
      
      console.log('‚úÖ Event listener adicionado com sucesso!');
    }
    
    // Fun√ß√£o para lidar com upload de imagem
    async function handleImageUpload(file) {
      if (!file) return;
      
      console.log('üì∏ Iniciando upload de imagem:', file.name, file.size, 'bytes');
      
      // Validar tipo de arquivo
      if (!file.type.startsWith('image/')) {
        mostrarStatusFoto('‚ùå Por favor, selecione apenas arquivos de imagem.', 'error');
        return;
      }
      
      // Validar tamanho (m√°ximo 2MB)
      if (file.size > 2 * 1024 * 1024) {
        mostrarStatusFoto('‚ùå A imagem deve ter no m√°ximo 2MB.', 'error');
        return;
      }
      
      // Mostrar loading
      mostrarLoadingFoto(true);
      mostrarStatusFoto('üì∏ Processando imagem...', 'info');
      
      try {
        // Simular progresso
        await simularProgressoUpload();
        
        // Criar URL para preview
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const preview = document.getElementById('empresa-foto-preview');
          const placeholder = document.getElementById('empresa-foto-placeholder');
          const uploadArea = document.getElementById('foto-upload-area');
          
          console.log('üñºÔ∏è Processando preview da imagem...');
          console.log('üìã Elementos encontrados:', {
            preview: !!preview,
            placeholder: !!placeholder,
            uploadArea: !!uploadArea
          });
          
          if (preview && placeholder && uploadArea) {
            // Definir a URL da imagem
            preview.src = e.target.result;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
            
            // For√ßar reflow para garantir que a imagem seja exibida
            preview.offsetHeight;
            
            // Adicionar efeito de sucesso
            uploadArea.style.borderColor = 'var(--success)';
            uploadArea.style.background = 'var(--success-50)';
            
            // Ocultar loading
            mostrarLoadingFoto(false);
            mostrarStatusFoto('‚úÖ Imagem carregada com sucesso!', 'success');
            
            // Log da URL da imagem
            console.log('üì∏ URL da imagem carregada:', e.target.result.substring(0, 50) + '...');
            console.log('üì∏ Tamanho da URL:', e.target.result.length, 'caracteres');
            console.log('üì∏ Display da preview:', preview.style.display);
            console.log('üì∏ Src da preview:', preview.src.substring(0, 50) + '...');
            
            // Verificar se a imagem foi carregada
            preview.onload = function() {
              console.log('‚úÖ Imagem carregada no preview com sucesso');
            };
            
            preview.onerror = function() {
              console.error('‚ùå Erro ao carregar imagem no preview');
            };
            
            // Resetar borda ap√≥s 2 segundos
            setTimeout(() => {
              uploadArea.style.borderColor = 'var(--border)';
              uploadArea.style.background = 'var(--bg-secondary)';
            }, 2000);
            
            console.log('‚úÖ Imagem processada com sucesso');
          } else {
            console.error('‚ùå Elementos de preview n√£o encontrados');
            mostrarLoadingFoto(false);
            mostrarStatusFoto('‚ùå Erro ao processar imagem.', 'error');
          }
        };
        
        reader.onerror = function() {
          mostrarLoadingFoto(false);
          mostrarStatusFoto('‚ùå Erro ao processar imagem.', 'error');
          console.error('‚ùå Erro ao ler arquivo de imagem');
        };
        
        reader.readAsDataURL(file);
        
      } catch (error) {
        mostrarLoadingFoto(false);
        mostrarStatusFoto('‚ùå Erro ao processar imagem.', 'error');
        console.error('‚ùå Erro no upload de imagem:', error);
      }
    }
    
    // Fun√ß√£o para simular progresso de upload
    function simularProgressoUpload() {
      return new Promise((resolve) => {
        const progressBar = document.getElementById('foto-progress-bar');
        const progress = document.getElementById('foto-progress');
        
        if (progress && progressBar) {
          progress.style.display = 'block';
          progressBar.style.width = '0%';
          
          let width = 0;
          const interval = setInterval(() => {
            // Progresso mais realista
            if (width < 30) {
              width += Math.random() * 8; // In√≠cio mais lento
            } else if (width < 80) {
              width += Math.random() * 12; // Meio mais r√°pido
            } else {
              width += Math.random() * 5; // Final mais lento
            }
            
            if (width >= 100) {
              width = 100;
              clearInterval(interval);
              setTimeout(() => {
                progress.style.display = 'none';
                resolve();
              }, 500);
            }
            
            progressBar.style.width = width + '%';
            console.log(`üìä Progresso do upload: ${Math.round(width)}%`);
          }, 150);
        } else {
          console.error('‚ùå Elementos de progresso n√£o encontrados');
          resolve();
        }
      });
    }
    
    // Fun√ß√£o para mostrar/ocultar loading
    function mostrarLoadingFoto(mostrar) {
      const loading = document.getElementById('foto-loading');
      if (loading) {
        loading.style.display = mostrar ? 'flex' : 'none';
      }
    }
    
    // Fun√ß√£o para mostrar status da foto
    function mostrarStatusFoto(mensagem, tipo) {
      const status = document.getElementById('foto-status');
      const statusText = document.getElementById('foto-status-text');
      
      if (status && statusText) {
        statusText.textContent = mensagem;
        status.style.display = 'block';
        
        // Definir cor baseada no tipo
        switch (tipo) {
          case 'success':
            status.style.background = 'var(--success-light)';
            status.style.color = 'var(--success)';
            status.style.border = '1px solid var(--success)';
            break;
          case 'error':
            status.style.background = 'var(--error-light)';
            status.style.color = 'var(--error)';
            status.style.border = '1px solid var(--error)';
            break;
          case 'info':
            status.style.background = 'var(--primary-light)';
            status.style.color = 'var(--primary)';
            status.style.border = '1px solid var(--primary)';
            break;
          default:
            status.style.background = 'var(--bg-secondary)';
            status.style.color = 'var(--text-secondary)';
            status.style.border = '1px solid var(--border)';
        }
        
        // Ocultar status ap√≥s 3 segundos para sucesso
        if (tipo === 'success') {
          setTimeout(() => {
            status.style.display = 'none';
          }, 3000);
        }
      }
    }
    
    // Fun√ß√£o para limpar imagem selecionada
    function limparImagemEmpresa() {
      const preview = document.getElementById('empresa-foto-preview');
      const placeholder = document.getElementById('empresa-foto-placeholder');
      const fileInput = document.getElementById('empresa-foto');
      const uploadArea = document.getElementById('foto-upload-area');
      const status = document.getElementById('foto-status');
      
      // Limpar elementos
      preview.src = '';
      preview.style.display = 'none';
      placeholder.style.display = 'block';
      fileInput.value = '';
      
      // Resetar √°rea de upload
      uploadArea.style.borderColor = 'var(--border)';
      uploadArea.style.background = 'var(--bg-secondary)';
      
      // Ocultar status
      if (status) {
        status.style.display = 'none';
      }
      
      // Ocultar progresso
      const progress = document.getElementById('foto-progress');
      if (progress) {
        progress.style.display = 'none';
      }
      
      // Ocultar loading
      mostrarLoadingFoto(false);
      
      console.log('üóëÔ∏è Imagem limpa com sucesso');
    }
    
    // Fun√ß√£o para mostrar informa√ß√µes da empresa
    function mostrarInformacoesEmpresa(empresaConfig) {
      console.log('üè¢ Mostrando informa√ß√µes da empresa:', empresaConfig);
      
      // Verificar se os elementos existem
      const empresaAddButton = document.getElementById('empresa-add-button');
      const configForm = document.getElementById('config-form');
      const empresaInfoDisplay = document.getElementById('empresa-info-display');
      
      console.log('üîç Elementos encontrados:', {
        empresaAddButton: !!empresaAddButton,
        configForm: !!configForm,
        empresaInfoDisplay: !!empresaInfoDisplay
      });
      
      // Ocultar bot√£o de adicionar e formul√°rio
      if (empresaAddButton) empresaAddButton.style.display = 'none';
      if (configForm) configForm.style.display = 'none';
      
      // Mostrar se√ß√£o de informa√ß√µes
      if (empresaInfoDisplay) {
        empresaInfoDisplay.style.display = 'block';
        console.log('‚úÖ Se√ß√£o de informa√ß√µes da empresa exibida');
      } else {
        console.error('‚ùå Elemento empresa-info-display n√£o encontrado');
      }
      
      // Preencher informa√ß√µes
      document.getElementById('empresa-nome-display-info').textContent = empresaConfig.nome || '-';
      document.getElementById('empresa-cnpj-display-info').textContent = empresaConfig.cnpj || '-';
      document.getElementById('empresa-endereco-display-info').textContent = empresaConfig.endereco || '-';
      document.getElementById('empresa-telefone-display-info').textContent = empresaConfig.telefone || '-';
      
      // Mostrar logo se existir
      if (empresaConfig.fotoUrl) {
        document.getElementById('empresa-logo-img').src = empresaConfig.fotoUrl;
        document.getElementById('empresa-logo-img').style.display = 'block';
        document.getElementById('empresa-logo-placeholder').style.display = 'none';
      } else {
        document.getElementById('empresa-logo-img').style.display = 'none';
        document.getElementById('empresa-logo-placeholder').style.display = 'block';
      }
    }
    
    // Fun√ß√£o para mostrar bot√£o de adicionar
    function mostrarBotaoAdicionar() {
      document.getElementById('empresa-info-display').style.display = 'none';
      document.getElementById('config-form').style.display = 'none';
      document.getElementById('empresa-add-button').style.display = 'block';
    }
    
    // Fun√ß√£o para mostrar formul√°rio edit√°vel (quando n√£o h√° empresa cadastrada)
    function mostrarFormularioEditavel() {
      document.getElementById('empresa-info-display').style.display = 'none';
      document.getElementById('empresa-add-button').style.display = 'none';
      document.getElementById('config-form').style.display = 'block';
      
      // Mostrar instru√ß√µes de cadastro
      const formInstructions = document.getElementById('form-instructions');
      if (formInstructions) {
        formInstructions.style.display = 'block';
      }
      
      // Limpar formul√°rio para cadastro
      document.getElementById('empresa-nome').value = '';
      document.getElementById('empresa-cnpj').value = '';
      document.getElementById('empresa-endereco').value = '';
      document.getElementById('empresa-telefone').value = '';
      limparImagemEmpresa();
      
      // Atualizar texto do bot√£o para indicar que √© um cadastro
      const submitButton = document.querySelector('#config-form button[type="submit"]');
      if (submitButton) {
        submitButton.textContent = 'Cadastrar Empresa';
      }
      
      // Adicionar event listener ao formul√°rio
      adicionarEventListenerFormulario();
    }
    
    // Fun√ß√£o para adicionar empresa
    function adicionarEmpresa() {
      mostrarFormularioEditavel();
    }
    
    // Fun√ß√£o para editar empresa
    async function editarEmpresa() {
      console.log('‚úèÔ∏è Iniciando edi√ß√£o da empresa...');
      
      document.getElementById('empresa-info-display').style.display = 'none';
      document.getElementById('config-form').style.display = 'block';
      
      // Ocultar instru√ß√µes de cadastro quando estiver editando
      const formInstructions = document.getElementById('form-instructions');
      if (formInstructions) {
        formInstructions.style.display = 'none';
      }
      
      // Carregar dados existentes para preencher o formul√°rio
      try {
        let dadosEmpresa = null;
        
        // Tentar carregar do Firebase primeiro
        if (window.FirebaseAuth) {
          console.log('üî• Carregando dados do Firebase para edi√ß√£o...');
          dadosEmpresa = await window.FirebaseAuth.getEmpresaConfig();
          if (dadosEmpresa) {
            console.log('‚úÖ Dados carregados do Firebase:', dadosEmpresa);
          }
        }
        
        // Fallback para localStorage se Firebase n√£o retornar dados
        if (!dadosEmpresa) {
          console.log('üíæ Carregando dados do localStorage para edi√ß√£o...');
          const localStorageData = localStorage.getItem('configEmpresa');
          if (localStorageData) {
            dadosEmpresa = JSON.parse(localStorageData);
            console.log('‚úÖ Dados carregados do localStorage:', dadosEmpresa);
          }
        }
        
        // Preencher formul√°rio com dados existentes
        if (dadosEmpresa) {
          console.log('üìù Preenchendo formul√°rio com dados existentes...');
          
          // Preencher campos de texto
          const empresaNome = document.getElementById('empresa-nome');
          const empresaCnpj = document.getElementById('empresa-cnpj');
          const empresaEndereco = document.getElementById('empresa-endereco');
          const empresaTelefone = document.getElementById('empresa-telefone');
          
          if (empresaNome) empresaNome.value = dadosEmpresa.nome || '';
          if (empresaCnpj) empresaCnpj.value = dadosEmpresa.cnpj || '';
          if (empresaEndereco) empresaEndereco.value = dadosEmpresa.endereco || '';
          if (empresaTelefone) empresaTelefone.value = dadosEmpresa.telefone || '';
          
          // Preencher imagem se existir
          if (dadosEmpresa.fotoUrl && dadosEmpresa.fotoUrl.trim() !== '') {
            console.log('üñºÔ∏è Carregando imagem existente...');
            const preview = document.getElementById('empresa-foto-preview');
            const placeholder = document.getElementById('empresa-foto-placeholder');
            const uploadArea = document.getElementById('foto-upload-area');
            
            if (preview && placeholder && uploadArea) {
              preview.src = dadosEmpresa.fotoUrl;
              preview.style.display = 'block';
              placeholder.style.display = 'none';
              
              // Adicionar efeito visual para indicar que imagem foi carregada
              uploadArea.style.borderColor = 'var(--success)';
              uploadArea.style.background = 'var(--success-50)';
              
              // Mostrar status
              mostrarStatusFoto('‚úÖ Imagem carregada da empresa', 'success');
              
              console.log('‚úÖ Imagem carregada com sucesso');
            }
          } else {
            // Limpar imagem se n√£o existir
            limparImagemEmpresa();
          }
          
          console.log('‚úÖ Formul√°rio preenchido com dados existentes');
        } else {
          console.log('‚ÑπÔ∏è Nenhum dado encontrado para preencher');
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar dados para edi√ß√£o:', error);
        // Continuar mesmo com erro, formul√°rio ficar√° vazio
      }
      
      // Atualizar texto do bot√£o para indicar que √© uma edi√ß√£o
      const submitButton = document.querySelector('#config-form button[type="submit"]');
      if (submitButton) {
        submitButton.textContent = 'Salvar Configura√ß√µes';
      }
      
      // Adicionar event listener ao formul√°rio
      adicionarEventListenerFormulario();
      
      console.log('‚úÖ Modo de edi√ß√£o ativado');
    }
    
    // Fun√ß√£o para cancelar edi√ß√£o
    function cancelarEdicao() {
      // Recarregar dados originais
      carregarConfiguracoesEmpresa();
    }
    
    // Fun√ß√£o de diagn√≥stico para verificar estado atual
    function diagnosticarEmpresa() {
      console.log('üîç === DIAGN√ìSTICO COMPLETO DA EMPRESA ===');
      
      // Verificar elementos da interface
      const elementos = {
        'empresa-info-display': document.getElementById('empresa-info-display'),
        'empresa-add-button': document.getElementById('empresa-add-button'),
        'config-form': document.getElementById('config-form'),
        'empresa-nome': document.getElementById('empresa-nome'),
        'empresa-cnpj': document.getElementById('empresa-cnpj'),
        'empresa-endereco': document.getElementById('empresa-endereco'),
        'empresa-telefone': document.getElementById('empresa-telefone'),
        'empresa-foto': document.getElementById('empresa-foto'),
        'empresa-foto-preview': document.getElementById('empresa-foto-preview'),
        'emergency-button': document.getElementById('emergency-button')
      };
      
      console.log('üìã Elementos da interface:');
      for (const [id, element] of Object.entries(elementos)) {
        if (element) {
          console.log(`‚úÖ ${id}: encontrado (display: ${element.style.display})`);
        } else {
          console.log(`‚ùå ${id}: N√ÉO ENCONTRADO`);
        }
      }
      
      // Verificar formul√°rio especificamente
      const configForm = document.getElementById('config-form');
      if (configForm) {
        console.log('üìù Formul√°rio encontrado:');
        console.log('- ID:', configForm.id);
        console.log('- Display:', configForm.style.display);
        console.log('- Event listeners:', configForm.onclick, configForm.onsubmit);
        
        // Verificar se o event listener est√° funcionando
        const submitButton = configForm.querySelector('button[type="submit"]');
        if (submitButton) {
          console.log('‚úÖ Bot√£o submit encontrado:', submitButton.textContent);
        } else {
          console.log('‚ùå Bot√£o submit N√ÉO encontrado');
        }
      }
      
      // Verificar Firebase
      console.log('üî• Status do Firebase:');
      if (window.FirebaseAuth) {
        console.log('‚úÖ Firebase Auth dispon√≠vel');
        console.log('üìã Fun√ß√µes dispon√≠veis:', Object.keys(window.FirebaseAuth));
        
        // Verificar se as fun√ß√µes espec√≠ficas existem
        if (window.FirebaseAuth.saveEmpresaConfig) {
          console.log('‚úÖ saveEmpresaConfig dispon√≠vel');
        } else {
          console.log('‚ùå saveEmpresaConfig N√ÉO dispon√≠vel');
        }
        
        if (window.FirebaseAuth.getEmpresaConfig) {
          console.log('‚úÖ getEmpresaConfig dispon√≠vel');
        } else {
          console.log('‚ùå getEmpresaConfig N√ÉO dispon√≠vel');
        }
      } else {
        console.log('‚ùå Firebase Auth N√ÉO dispon√≠vel');
      }
      
      // Verificar localStorage
      console.log('üíæ Dados do localStorage:');
      const localStorageData = localStorage.getItem('configEmpresa');
      if (localStorageData) {
        try {
          const parsed = JSON.parse(localStorageData);
          console.log('‚úÖ localStorage:', parsed);
        } catch (e) {
          console.log('‚ùå Erro ao parsear localStorage:', e);
        }
      } else {
        console.log('‚ÑπÔ∏è localStorage vazio');
      }
      
      // Verificar valores dos campos
      console.log('üìù Valores dos campos:');
      if (elementos['empresa-nome']) {
        console.log('Nome:', elementos['empresa-nome'].value);
      }
      if (elementos['empresa-cnpj']) {
        console.log('CNPJ:', elementos['empresa-cnpj'].value);
      }
      if (elementos['empresa-endereco']) {
        console.log('Endere√ßo:', elementos['empresa-endereco'].value);
      }
      if (elementos['empresa-telefone']) {
        console.log('Telefone:', elementos['empresa-telefone'].value);
      }
      
      // Verificar se o event listener est√° funcionando
      console.log('üîó Verificando event listeners:');
      const form = document.getElementById('config-form');
      if (form) {
        // Tentar disparar um evento de teste
        console.log('üß™ Testando event listener do formul√°rio...');
        try {
          const testEvent = new Event('submit', { bubbles: true, cancelable: true });
          form.dispatchEvent(testEvent);
          console.log('‚úÖ Event listener funcionando');
        } catch (e) {
          console.log('‚ùå Erro no event listener:', e);
        }
      }
      
      console.log('üîç === FIM DO DIAGN√ìSTICO ===');
    }
    
    // Fun√ß√£o para for√ßar recarga das configura√ß√µes
    function forcarRecargaEmpresa() {
      console.log('üîÑ For√ßando recarga das configura√ß√µes da empresa...');
      
      // Limpar localStorage para teste
      localStorage.removeItem('configEmpresa');
      console.log('üóëÔ∏è localStorage limpo');
      
      // Recarregar configura√ß√µes
      carregarConfiguracoesEmpresa();
    }
    
    // Fun√ß√£o para for√ßar adi√ß√£o do event listener
    function forcarEventListener() {
      console.log('üîó For√ßando adi√ß√£o do event listener...');
      
      const configForm = document.getElementById('config-form');
      if (!configForm) {
        console.error('‚ùå Formul√°rio n√£o encontrado');
        return;
      }
      
      // Remover event listeners existentes
      const newForm = configForm.cloneNode(true);
      configForm.parentNode.replaceChild(newForm, configForm);
      
      // Adicionar novo event listener
      newForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('üéØ Event listener funcionando!');
        
        try {
          // Obter valores dos campos
          const nome = document.getElementById('empresa-nome').value.trim();
          const cnpj = document.getElementById('empresa-cnpj').value.trim();
          const endereco = document.getElementById('empresa-endereco').value.trim();
          const telefone = document.getElementById('empresa-telefone').value.trim();
          const fotoUrl = document.getElementById('empresa-foto-preview').src || '';
          
          // Validar campo obrigat√≥rio
          if (!nome) {
            alert('O campo "Nome da Empresa" √© obrigat√≥rio!');
            document.getElementById('empresa-nome').focus();
            return;
          }
          
          const configEmpresa = {
            nome: nome,
            cnpj: cnpj || '',
            endereco: endereco || '',
            telefone: telefone || '',
            fotoUrl: fotoUrl
          };
          
          console.log('üìù Dados da empresa para salvar:', configEmpresa);
          
          // Salvar no Firebase se dispon√≠vel
          if (window.FirebaseAuth) {
            console.log('üî• Salvando no Firebase...');
            await window.FirebaseAuth.saveEmpresaConfig(configEmpresa);
            console.log('‚úÖ Configura√ß√µes da empresa salvas no Firebase');
          } else {
            console.log('‚ö†Ô∏è Firebase n√£o dispon√≠vel, salvando apenas no localStorage');
          }
          
          // Salvar no localStorage como backup
          localStorage.setItem('configEmpresa', JSON.stringify(configEmpresa));
          console.log('üíæ Dados salvos no localStorage');
          
          // Atualizar exibi√ß√£o na barra superior
          atualizarNomeEmpresaHeader(configEmpresa.nome);
          
          // Mostrar informa√ß√µes da empresa
          mostrarInformacoesEmpresa(configEmpresa);
          
          // Ocultar bot√£o de emerg√™ncia
          const emergencyButton = document.getElementById('emergency-button');
          if (emergencyButton) {
            emergencyButton.style.display = 'none';
          }
          
          // Atualizar texto do bot√£o para indicar que √© uma edi√ß√£o
          const submitButton = document.querySelector('#config-form button[type="submit"]');
          if (submitButton) {
            submitButton.textContent = 'Salvar Configura√ß√µes';
          }
          
          // Feedback visual
          alert('Configura√ß√µes da empresa salvas com sucesso!');
          
          // Atualizar informa√ß√µes da empresa no menu
          await updateEmpresaMenuInfo();
          
        } catch (error) {
          console.error('‚ùå Erro ao salvar configura√ß√µes:', error);
          alert('Erro ao salvar configura√ß√µes: ' + error.message);
        }
      });
      
      console.log('‚úÖ Event listener for√ßado adicionado');
    }
    
    // Fun√ß√£o para testar Firebase
    async function testarFirebase() {
      console.log('üß™ Testando Firebase...');
      
      try {
        if (!window.FirebaseAuth) {
          console.log('‚ùå Firebase Auth n√£o dispon√≠vel');
          alert('Firebase Auth n√£o est√° dispon√≠vel. Verifique se o arquivo firebase-auth.js foi carregado.');
          return;
        }
        
        console.log('‚úÖ Firebase Auth dispon√≠vel');
        console.log('üìã Fun√ß√µes dispon√≠veis:', Object.keys(window.FirebaseAuth));
        
        // Testar fun√ß√£o getCurrentUser
        const user = await window.FirebaseAuth.getCurrentUser();
        if (user) {
          console.log('‚úÖ Usu√°rio autenticado:', user.email);
          
          // Testar salvamento
          const testData = {
            nome: 'Empresa Teste',
            cnpj: '00.000.000/0001-00',
            endereco: 'Endere√ßo Teste',
            telefone: '(00) 00000-0000',
            fotoUrl: ''
          };
          
          console.log('üìù Salvando dados de teste:', testData);
          await window.FirebaseAuth.saveEmpresaConfig(testData);
          console.log('‚úÖ Dados salvos com sucesso!');
          
          // Testar carregamento
          const loadedData = await window.FirebaseAuth.getEmpresaConfig();
          console.log('üìä Dados carregados:', loadedData);
          
          alert('‚úÖ Firebase funcionando corretamente!\n\nDados salvos e carregados com sucesso.');
        } else {
          console.log('‚ùå Usu√°rio n√£o autenticado');
          alert('‚ùå Usu√°rio n√£o autenticado. Fa√ßa login primeiro.');
        }
      } catch (error) {
        console.error('‚ùå Erro no teste do Firebase:', error);
        alert('‚ùå Erro no teste do Firebase: ' + error.message);
      }
    }
    
    // Fun√ß√£o para testar salvamento com dados do formul√°rio
    async function testarSalvamentoFormulario() {
      console.log('üß™ Testando salvamento com dados do formul√°rio...');
      
      try {
        // Obter valores dos campos do formul√°rio
        const nome = document.getElementById('empresa-nome').value.trim();
        const cnpj = document.getElementById('empresa-cnpj').value.trim();
        const endereco = document.getElementById('empresa-endereco').value.trim();
        const telefone = document.getElementById('empresa-telefone').value.trim();
        const fotoUrl = document.getElementById('empresa-foto-preview').src || '';
        
        console.log('üìù Dados do formul√°rio:', { nome, cnpj, endereco, telefone, fotoUrl });
        
        // Validar campo obrigat√≥rio
        if (!nome) {
          alert('Preencha o nome da empresa primeiro!');
          return;
        }
        
        const configEmpresa = {
          nome: nome,
          cnpj: cnpj || '',
          endereco: endereco || '',
          telefone: telefone || '',
          fotoUrl: fotoUrl
        };
        
        console.log('üìù Dados para salvar:', configEmpresa);
        
        // Salvar no Firebase
        if (window.FirebaseAuth) {
          console.log('üî• Salvando no Firebase...');
          console.log('üìã Fun√ß√£o saveEmpresaConfig:', typeof window.FirebaseAuth.saveEmpresaConfig);
          
          try {
            await window.FirebaseAuth.saveEmpresaConfig(configEmpresa);
            console.log('‚úÖ Dados salvos no Firebase!');
            
            // Testar carregamento
            const loadedData = await window.FirebaseAuth.getEmpresaConfig();
            console.log('üìä Dados carregados:', loadedData);
            
            alert('‚úÖ Salvamento com dados do formul√°rio funcionou!\n\nDados salvos e carregados com sucesso.');
          } catch (firebaseError) {
            console.error('‚ùå Erro espec√≠fico do Firebase:', firebaseError);
            console.error('‚ùå Stack trace:', firebaseError.stack);
            throw firebaseError;
          }
        } else {
          console.log('‚ùå Firebase n√£o dispon√≠vel');
          alert('‚ùå Firebase n√£o dispon√≠vel');
        }
      } catch (error) {
        console.error('‚ùå Erro no teste de salvamento:', error);
        alert('‚ùå Erro no teste de salvamento: ' + error.message);
      }
    }
    
    // Fun√ß√£o para for√ßar exibi√ß√£o do formul√°rio (emerg√™ncia)
    function forcarExibicaoFormulario() {
      console.log('üö® FOR√áANDO EXIBI√á√ÉO DO FORMUL√ÅRIO (EMERG√äNCIA)');
      
      // Ocultar todos os elementos
      const empresaInfoDisplay = document.getElementById('empresa-info-display');
      const empresaAddButton = document.getElementById('empresa-add-button');
      const emergencyButton = document.getElementById('emergency-button');
      const configForm = document.getElementById('config-form');
      
      if (empresaInfoDisplay) empresaInfoDisplay.style.display = 'none';
      if (empresaAddButton) empresaAddButton.style.display = 'none';
      if (emergencyButton) emergencyButton.style.display = 'none';
      
      // Mostrar formul√°rio
      if (configForm) {
        configForm.style.display = 'block';
        console.log('‚úÖ Formul√°rio for√ßado para exibi√ß√£o');
        
        // Mostrar instru√ß√µes
        const formInstructions = document.getElementById('form-instructions');
        if (formInstructions) {
          formInstructions.style.display = 'block';
        }
        
        // Atualizar texto do bot√£o
        const submitButton = document.querySelector('#config-form button[type="submit"]');
        if (submitButton) {
          submitButton.textContent = 'Cadastrar Empresa';
        }
        
        // Limpar campos
        const empresaNome = document.getElementById('empresa-nome');
        const empresaCnpj = document.getElementById('empresa-cnpj');
        const empresaEndereco = document.getElementById('empresa-endereco');
        const empresaTelefone = document.getElementById('empresa-telefone');
        
        if (empresaNome) empresaNome.value = '';
        if (empresaCnpj) empresaCnpj.value = '';
        if (empresaEndereco) empresaEndereco.value = '';
        if (empresaTelefone) empresaTelefone.value = '';
        
        // Limpar imagem
        limparImagemEmpresa();
        
        // Adicionar event listener ao formul√°rio
        adicionarEventListenerFormulario();
        
        console.log('‚úÖ Formul√°rio de cadastro da empresa exibido com sucesso!');
      } else {
        console.error('‚ùå Formul√°rio n√£o encontrado!');
        alert('Erro: Formul√°rio n√£o encontrado. Verifique o console para mais detalhes.');
      }
    }
    
    // Fun√ß√£o para excluir empresa
    async function excluirEmpresa() {
      if (!confirm('Tem certeza que deseja excluir as configura√ß√µes da empresa? Esta a√ß√£o n√£o pode ser desfeita.')) {
        return;
      }
      
      try {
        console.log('üóëÔ∏è Excluindo configura√ß√µes da empresa...');
        
        // Excluir do Firebase se dispon√≠vel
        if (window.FirebaseAuth) {
          await window.FirebaseAuth.deleteEmpresaConfig();
          console.log('‚úÖ Configura√ß√µes da empresa exclu√≠das do Firebase');
        }
        
        // Limpar localStorage
        localStorage.removeItem('configEmpresa');
        
        // Limpar formul√°rio
        document.getElementById('empresa-nome').value = '';
        document.getElementById('empresa-cnpj').value = '';
        document.getElementById('empresa-endereco').value = '';
        document.getElementById('empresa-telefone').value = '';
        limparImagemEmpresa();
        
        // Atualizar interface
        atualizarNomeEmpresaHeader('');
        mostrarFormularioEditavel();
        

        
        // Feedback visual
        alert('Configura√ß√µes da empresa exclu√≠das com sucesso!');
        
      } catch (error) {
        console.error('‚ùå Erro ao excluir configura√ß√µes da empresa:', error);
        alert('Erro ao excluir configura√ß√µes da empresa. Tente novamente.');
      }
    }
    
    // Carregar configura√ß√µes ao iniciar
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Iniciando carregamento das configura√ß√µes da empresa...');
      
      // Fun√ß√£o para for√ßar exibi√ß√£o inicial
      function forcarExibicaoInicial() {
        console.log('üîß Verificando interface inicial...');
        
        // Verificar se algum elemento est√° vis√≠vel
        const empresaInfoDisplay = document.getElementById('empresa-info-display');
        const empresaAddButton = document.getElementById('empresa-add-button');
        const configForm = document.getElementById('config-form');
        const emergencyButton = document.getElementById('emergency-button');
        
        console.log('üìã Status dos elementos:');
        console.log('- empresa-info-display:', empresaInfoDisplay ? empresaInfoDisplay.style.display : 'N√ÉO ENCONTRADO');
        console.log('- empresa-add-button:', empresaAddButton ? empresaAddButton.style.display : 'N√ÉO ENCONTRADO');
        console.log('- config-form:', configForm ? configForm.style.display : 'N√ÉO ENCONTRADO');
        console.log('- emergency-button:', emergencyButton ? emergencyButton.style.display : 'N√ÉO ENCONTRADO');
        
        // Se nenhum elemento estiver vis√≠vel, mostrar o bot√£o de emerg√™ncia
        const algoVisivel = (empresaInfoDisplay && empresaInfoDisplay.style.display !== 'none') ||
                           (empresaAddButton && empresaAddButton.style.display !== 'none') ||
                           (configForm && configForm.style.display !== 'none') ||
                           (emergencyButton && emergencyButton.style.display !== 'none');
        
        if (!algoVisivel) {
          console.log('‚ö†Ô∏è Nenhuma interface vis√≠vel - mostrando bot√£o de emerg√™ncia');
          if (emergencyButton) {
            emergencyButton.style.display = 'block';
          }
        } else {
          console.log('‚úÖ Interface vis√≠vel detectada');
        }
      }
      
      // Executar verifica√ß√£o inicial imediatamente
      forcarExibicaoInicial();
      
      // Aguardar Firebase carregar
      const checkFirebase = setInterval(() => {
        if (window.FirebaseAuth) {
          clearInterval(checkFirebase);
          console.log('‚úÖ Firebase carregado, carregando configura√ß√µes...');
      carregarConfiguracoesEmpresa();
        }
      }, 100);
      
      // Timeout ap√≥s 5 segundos
      setTimeout(() => {
        clearInterval(checkFirebase);
        if (!window.FirebaseAuth) {
          console.log('‚ö†Ô∏è Firebase n√£o carregou, usando localStorage...');
          carregarConfiguracoesEmpresa();
        }
      }, 5000);
      
      // Verifica√ß√£o adicional ap√≥s 2 segundos
      setTimeout(() => {
        console.log('üîç Verifica√ß√£o adicional...');
        forcarExibicaoInicial();
        
        // Adicionar event listener ao formul√°rio
        console.log('üîó Adicionando event listener ao formul√°rio...');
        adicionarEventListenerFormulario();
      }, 2000);
      
      // Adicionar m√°scaras aos campos CNPJ e Telefone
      const cnpjInput = document.getElementById('empresa-cnpj');
      const telefoneInput = document.getElementById('empresa-telefone');
      
      if (cnpjInput) {
        cnpjInput.addEventListener('input', function() {
          formatarCNPJ(this);
        });
        cnpjInput.addEventListener('keypress', function(e) {
          // Permite apenas n√∫meros
          if (!/\d/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete') {
            e.preventDefault();
          }
        });
      }
      
      if (telefoneInput) {
        telefoneInput.addEventListener('input', function() {
          formatarTelefone(this);
        });
        telefoneInput.addEventListener('keypress', function(e) {
          // Permite apenas n√∫meros
          if (!/\d/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete') {
            e.preventDefault();
          }
        });
      }
      
      // Event listener para upload de imagem
      const fotoInput = document.getElementById('empresa-foto');
      if (fotoInput) {
        console.log('‚úÖ Event listener para upload de imagem adicionado');
        fotoInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          console.log('üì∏ Arquivo selecionado:', file ? file.name : 'Nenhum arquivo');
          if (file) {
            handleImageUpload(file);
          }
        });
      } else {
        console.error('‚ùå Elemento empresa-foto n√£o encontrado');
      }
    });

    // Fun√ß√µes de formata√ß√£o para CNPJ e Telefone
    function formatarCNPJ(input) {
      // Obter apenas n√∫meros
      let value = input.value.replace(/\D/g, '');
      
      // Limitar a 14 d√≠gitos
      if (value.length > 14) {
        value = value.substring(0, 14);
      }
      
      // Aplicar m√°scara: XX.XXX.XXX/XXXX-XX
      if (value.length > 0) {
        value = value.replace(/^(\d{2})(\d)/, '$1.$2');
      }
      if (value.length > 3) {
        value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
      }
      if (value.length > 7) {
        value = value.replace(/^(\d{2})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3/$4');
      }
      if (value.length > 12) {
        value = value.replace(/^(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d)/, '$1.$2.$3/$4-$5');
      }
      
      // Atualizar valor do input
      input.value = value;
      
      // Adicionar classe de valida√ß√£o visual
      if (value.length === 18) { // CNPJ completo
        input.style.borderColor = 'var(--success)';
        input.style.boxShadow = '0 0 0 2px var(--success-light)';
      } else if (value.length > 0) {
        input.style.borderColor = 'var(--warning)';
        input.style.boxShadow = '0 0 0 2px var(--warning-light)';
      } else {
        input.style.borderColor = 'var(--border)';
        input.style.boxShadow = 'none';
      }
    }
    
    function formatarTelefone(input) {
      // Obter apenas n√∫meros
      let value = input.value.replace(/\D/g, '');
      
      // Limitar a 11 d√≠gitos
      if (value.length > 11) {
        value = value.substring(0, 11);
      }
      
      // Aplicar m√°scara baseada no n√∫mero de d√≠gitos
      if (value.length > 0) {
        value = value.replace(/^(\d{2})(\d)/, '($1) $2');
      }
      
      if (value.length > 4) {
        if (value.length <= 10) {
          // Telefone fixo: (XX) XXXX-XXXX
          value = value.replace(/^\((\d{2})\) (\d{4})(\d)/, '($1) $2-$3');
        } else {
          // Celular: (XX) XXXXX-XXXX
          value = value.replace(/^\((\d{2})\) (\d{5})(\d)/, '($1) $2-$3');
        }
      }
      
      // Atualizar valor do input
      input.value = value;
      
      // Adicionar classe de valida√ß√£o visual
      if (value.length === 15) { // Telefone completo (fixo ou celular)
        input.style.borderColor = 'var(--success)';
        input.style.boxShadow = '0 0 0 2px var(--success-light)';
      } else if (value.length > 0) {
        input.style.borderColor = 'var(--warning)';
        input.style.boxShadow = '0 0 0 2px var(--warning-light)';
      } else {
        input.style.borderColor = 'var(--border)';
        input.style.boxShadow = 'none';
      }
    }
    
    // Fun√ß√£o para validar CNPJ
    function validarCNPJ(cnpj) {
      // Remove caracteres n√£o num√©ricos
      cnpj = cnpj.replace(/\D/g, '');
      
      // Verifica se tem 14 d√≠gitos
      if (cnpj.length !== 14) {
        return false;
      }
      
      // Verifica se todos os d√≠gitos s√£o iguais
      if (/^(\d)\1+$/.test(cnpj)) {
        return false;
      }
      
      // Valida√ß√£o do primeiro d√≠gito verificador
      let soma = 0;
      let peso = 2;
      for (let i = 11; i >= 0; i--) {
        soma += parseInt(cnpj.charAt(i)) * peso;
        peso = peso === 9 ? 2 : peso + 1;
      }
      let digito = 11 - (soma % 11);
      if (digito > 9) digito = 0;
      if (parseInt(cnpj.charAt(12)) !== digito) {
        return false;
      }
      
      // Valida√ß√£o do segundo d√≠gito verificador
      soma = 0;
      peso = 2;
      for (let i = 12; i >= 0; i--) {
        soma += parseInt(cnpj.charAt(i)) * peso;
        peso = peso === 9 ? 2 : peso + 1;
      }
      digito = 11 - (soma % 11);
      if (digito > 9) digito = 0;
      if (parseInt(cnpj.charAt(13)) !== digito) {
        return false;
      }
      
      return true;
    }
    
    // Fun√ß√£o para validar telefone
    function validarTelefone(telefone) {
      // Remove caracteres n√£o num√©ricos
      telefone = telefone.replace(/\D/g, '');
      
      // Verifica se tem 10 ou 11 d√≠gitos
      return telefone.length === 10 || telefone.length === 11;
    }
    
    // Fun√ß√£o para carregar configura√ß√µes da empresa
    
    // Fun√ß√£o de teste para verificar carregamento da empresa
    function testarCarregamentoEmpresa() {
      console.log('üß™ Iniciando teste de carregamento da empresa...');
      
      // Verificar localStorage
      const configEmpresa = localStorage.getItem('configEmpresa');
      const empresaConfig = localStorage.getItem('empresaConfig');
      
      console.log('üìä localStorage configEmpresa:', configEmpresa);
      console.log('üìä localStorage empresaConfig:', empresaConfig);
      
      // Verificar Firebase
      if (window.FirebaseAuth) {
        console.log('üî• Firebase Auth dispon√≠vel');
        window.FirebaseAuth.getEmpresaConfig().then(data => {
          console.log('üìä Firebase empresa data:', data);
        }).catch(error => {
          console.log('‚ùå Firebase error:', error);
        });
      } else {
        console.log('‚ö†Ô∏è Firebase Auth n√£o dispon√≠vel');
      }
      
      // Verificar elementos da interface
      const empresaInfoDisplay = document.getElementById('empresa-info-display');
      const empresaNomeDisplay = document.getElementById('empresa-nome-display-info');
      
      console.log('üîç Elementos da interface:');
      console.log('- empresa-info-display:', empresaInfoDisplay);
      console.log('- empresa-nome-display-info:', empresaNomeDisplay);
      console.log('- empresa-info-display display:', empresaInfoDisplay ? empresaInfoDisplay.style.display : 'N√ÉO ENCONTRADO');
      
      // For√ßar exibi√ß√£o se houver dados
      if (configEmpresa) {
        try {
          const data = JSON.parse(configEmpresa);
          if (data.nome) {
            console.log('‚úÖ Dados encontrados, for√ßando exibi√ß√£o...');
            mostrarInformacoesEmpresa(data);
          }
        } catch (e) {
          console.error('‚ùå Erro ao fazer parse:', e);
        }
      }
    }
    
    // Fun√ß√£o de teste mais direta - FOR√áAR EXIBI√á√ÉO
    function forcarExibicaoEmpresa() {
      console.log('üöÄ FOR√áANDO EXIBI√á√ÉO DA EMPRESA...');
      
      // 1. Verificar se h√° dados
      let dadosEmpresa = null;
      
      // Tentar localStorage
      try {
        const configEmpresa = localStorage.getItem('configEmpresa');
        if (configEmpresa) {
          dadosEmpresa = JSON.parse(configEmpresa);
          console.log('‚úÖ Dados encontrados no localStorage:', dadosEmpresa);
        }
      } catch (e) {
        console.error('‚ùå Erro ao ler localStorage:', e);
      }
      
      // Se n√£o encontrou, tentar outra chave
      if (!dadosEmpresa) {
        try {
          const empresaConfig = localStorage.getItem('empresaConfig');
          if (empresaConfig) {
            dadosEmpresa = JSON.parse(empresaConfig);
            console.log('‚úÖ Dados encontrados em empresaConfig:', dadosEmpresa);
          }
        } catch (e) {
          console.error('‚ùå Erro ao ler empresaConfig:', e);
        }
      }
      
      // 2. Se encontrou dados, for√ßar exibi√ß√£o
      if (dadosEmpresa && dadosEmpresa.nome) {
        console.log('üéØ For√ßando exibi√ß√£o com dados:', dadosEmpresa.nome);
        
        // Ocultar formul√°rio se existir
        const configForm = document.getElementById('config-form');
        if (configForm) {
          configForm.style.display = 'none';
          console.log('‚úÖ Formul√°rio ocultado');
        }
        
        // Ocultar bot√£o de adicionar se existir
        const empresaAddButton = document.getElementById('empresa-add-button');
        if (empresaAddButton) {
          empresaAddButton.style.display = 'none';
          console.log('‚úÖ Bot√£o de adicionar ocultado');
        }
        
        // Mostrar se√ß√£o de informa√ß√µes
        const empresaInfoDisplay = document.getElementById('empresa-info-display');
        if (empresaInfoDisplay) {
          empresaInfoDisplay.style.display = 'block';
          console.log('‚úÖ Se√ß√£o de informa√ß√µes exibida');
          
          // Preencher informa√ß√µes
          const nomeDisplay = document.getElementById('empresa-nome-display-info');
          const cnpjDisplay = document.getElementById('empresa-cnpj-display-info');
          const enderecoDisplay = document.getElementById('empresa-endereco-display-info');
          const telefoneDisplay = document.getElementById('empresa-telefone-display-info');
          
          if (nomeDisplay) {
            nomeDisplay.textContent = dadosEmpresa.nome || '-';
            console.log('‚úÖ Nome preenchido:', dadosEmpresa.nome);
          }
          if (cnpjDisplay) cnpjDisplay.textContent = dadosEmpresa.cnpj || '-';
          if (enderecoDisplay) enderecoDisplay.textContent = dadosEmpresa.endereco || '-';
          if (telefoneDisplay) telefoneDisplay.textContent = dadosEmpresa.telefone || '-';
          
          // Mostrar logo se existir
          const logoImg = document.getElementById('empresa-logo-img');
          const logoPlaceholder = document.getElementById('empresa-logo-placeholder');
          
          if (dadosEmpresa.fotoUrl && logoImg && logoPlaceholder) {
            logoImg.src = dadosEmpresa.fotoUrl;
            logoImg.style.display = 'block';
            logoPlaceholder.style.display = 'none';
            console.log('‚úÖ Logo exibida');
          } else if (logoImg && logoPlaceholder) {
            logoImg.style.display = 'none';
            logoPlaceholder.style.display = 'block';
            console.log('‚úÖ Placeholder do logo exibido');
          }
          
          console.log('üéâ EXIBI√á√ÉO FOR√áADA CONCLU√çDA!');
          
        } else {
          console.error('‚ùå Elemento empresa-info-display n√£o encontrado!');
        }
      } else {
        console.log('‚ÑπÔ∏è Nenhum dado de empresa encontrado');
        
        // Mostrar mensagem de que n√£o h√° empresa cadastrada
        const empresaInfoDisplay = document.getElementById('empresa-info-display');
        if (empresaInfoDisplay) {
          empresaInfoDisplay.style.display = 'block';
          empresaInfoDisplay.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <div style="color: var(--text-muted); margin-bottom: 1rem;">
                <span class="material-icons" style="font-size: 3rem; margin-bottom: 1rem;">business_off</span>
                <h3 style="margin: 0; color: var(--text-secondary);">Nenhuma empresa cadastrada</h3>
                <p style="margin: 0.5rem 0 0 0; color: var(--text-muted);">N√£o foi encontrada nenhuma empresa cadastrada no sistema.</p>
              </div>
              <button type="button" onclick="adicionarEmpresa()" style="background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; box-shadow: var(--shadow); font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; margin: 0 auto;">
                <span class="material-icons" style="font-size: 1rem;">add_business</span>
                Cadastrar Empresa
              </button>
            </div>
          `;
          console.log('‚úÖ Mensagem de "nenhuma empresa" exibida');
        }
      }
    }
  </script>
</body>
</html> 