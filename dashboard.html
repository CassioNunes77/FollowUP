<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Fichas de Terceirizados</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@400;600&family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <!-- Firebase Configuration -->
  <script type="module" src="firebase-auth.js"></script>
  <style>
    :root {
      /* Nova paleta de cores moderna e legível */
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --primary-50: #eff6ff;
      --primary-100: #dbeafe;
      --primary-200: #bfdbfe;
      
      --accent: #f1f5f9;
      --accent-light: #f8fafc;
      --accent-dark: #e2e8f0;
      
      --bg: #ffffff;
      --bg-secondary: #f8fafc;
      --surface: #ffffff;
      --surface-hover: #f8fafc;
      
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --border-dark: #cbd5e1;
      
      --text: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --text-light: #94a3b8;
      
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --error: #ef4444;
      --error-light: #fee2e2;
      
      --radius: 12px;
      --radius-lg: 16px;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --sidebar-width: 280px;
    }
    
    * { 
      box-sizing: border-box; 
    }
    
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg-secondary);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      line-height: 1.6;
    }
    
    /* Sidebar moderna com cores atualizadas */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--surface);
      color: var(--text);
      box-shadow: var(--shadow-xl);
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 100;
      display: flex;
      flex-direction: column;
      transition: transform var(--transition);
      border-right: 1px solid var(--border);
    }
    
    .sidebar-header {
      padding: 2rem 1.5rem 1.5rem 1.5rem;
      border-bottom: 1px solid var(--border);
      background: var(--primary-50);
    }
    
    .sidebar-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      color: var(--primary);
      letter-spacing: -0.025em;
      font-family: 'Poppins', sans-serif;
    }
    
    .sidebar-nav {
      padding: 1.5rem 0;
      flex: 1;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      padding: 0.875rem 1.5rem;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all var(--transition);
      cursor: pointer;
      border-left: 3px solid transparent;
      border-radius: 0 8px 8px 0;
      margin: 0.25rem 0;
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
      font-weight: 500;
    }
    
    .nav-item:hover {
      background: var(--primary-50);
      color: var(--primary);
      border-left: 3px solid var(--primary);
    }
    
    .nav-item.active {
      background: var(--primary-50);
      color: var(--primary);
      border-left: 3px solid var(--primary);
      font-weight: 600;
    }
    
    .nav-item i, .nav-item .material-icons {
      margin-right: 0.875rem;
      font-size: 1.25rem;
      width: 24px;
      text-align: center;
      vertical-align: middle;
    }
    
    .nav-item span {
      font-weight: 500;
    }
    
    /* Botão mobile atualizado */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 200;
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1.25rem;
      box-shadow: var(--shadow-lg);
      transition: all var(--transition);
    }
    
    .mobile-menu-toggle:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }
    
    /* Content wrapper atualizado */
    .content-wrapper {
      flex: 1;
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg-secondary);
    }
    
    .content-header {
      background: var(--surface);
      padding: 1.5rem 2rem;
      box-shadow: var(--shadow);
      border-bottom: 1px solid var(--border);
      font-family: 'Inter', sans-serif;
    }
    
    .content-header h2 {
      margin: 0;
      font-size: 1.75rem;
      color: var(--text);
      font-weight: 700;
      font-family: 'Poppins', sans-serif;
    }
    
    .content-body {
      flex: 1;
      padding: 2rem;
    }
    
    /* Main content atualizado */
    main {
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 2rem 2.5rem;
      animation: fadeIn 0.7s;
      border: 1px solid var(--border);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Form sections atualizadas */
    .form-section {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-light);
      background: var(--bg-secondary);
      padding: 1.5rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    
    .form-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 1.5rem;
    }
    
    .form-section h2 {
      font-size: 1.125rem;
      color: var(--text);
      margin-bottom: 1.25rem;
      font-weight: 600;
      letter-spacing: -0.025em;
      font-family: 'Poppins', sans-serif;
    }
    
    /* Form elements atualizados */
    form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .form-row {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    
    .form-group {
      flex: 1 1 200px;
      display: flex;
      flex-direction: column;
    }
    
    label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }
    
    input, select {
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      background: var(--surface);
      transition: all var(--transition);
      outline: none;
      font-family: 'Inter', sans-serif;
      color: var(--text);
    }
    
    input:focus, select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-100);
    }
    
    input:disabled {
      background: var(--accent);
      color: var(--text-muted);
      cursor: not-allowed;
    }
    
    /* Tabelas atualizadas */
    .sizes-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.75rem;
      background: var(--surface);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    
    .sizes-table th, .sizes-table td {
      border: 1px solid var(--border);
      padding: 0.75rem 1rem;
      text-align: center;
      font-size: 0.875rem;
    }
    
    .sizes-table th {
      background: var(--primary-50);
      color: var(--primary);
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }
    
    /* Actions atualizadas */
    .actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    
    .actions button {
      padding: 0.875rem 2rem;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      background: var(--primary);
      color: white;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: all var(--transition);
      font-family: 'Inter', sans-serif;
    }
    
    .actions button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .actions button:active {
      transform: scale(0.98);
    }
    
    .actions button.secondary {
      background: var(--text-muted);
      color: white;
    }
    
    .actions button.secondary:hover {
      background: var(--text-secondary);
    }
    
    /* Tabela de listagem atualizada */
    .list-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      animation: fadeIn 0.7s;
      background: var(--surface);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }
    
    .list-table th, .list-table td {
      border: 1px solid var(--border);
      padding: 1rem 1.25rem;
      text-align: center;
      font-size: 0.875rem;
    }
    
    .list-table th {
      background: var(--primary-50);
      color: var(--primary);
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .list-table tr:nth-child(even) {
      background: var(--accent-light);
    }
    
    .list-table tr:hover {
      background: var(--primary-50);
    }
    
    /* Botões de ação atualizados */
    .delete-btn {
      background: none;
      border: none;
      color: var(--error);
      font-size: 1.125rem;
      cursor: pointer;
      transition: all var(--transition);
      padding: 0.5rem;
      border-radius: var(--radius);
    }
    
    .delete-btn:hover {
      color: #dc2626;
      background: var(--error-light);
    }
    
    .edit-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 1.125rem;
      cursor: pointer;
      transition: all var(--transition);
      margin-right: 0.5rem;
      padding: 0.5rem;
      border-radius: var(--radius);
    }
    
    .edit-btn:hover {
      color: var(--primary-dark);
      background: var(--primary-50);
    }
    
    /* Modal atualizado */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
      backdrop-filter: blur(4px);
    }
    
    .modal {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideIn 0.3s;
      border: 1px solid var(--border);
    }
    
    .modal-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--primary-50);
    }
    
    .modal-header h3 {
      margin: 0;
      color: var(--primary);
      font-size: 1.25rem;
      font-weight: 700;
      font-family: 'Poppins', sans-serif;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all var(--transition);
    }
    
    .modal-close:hover {
      background: var(--error-light);
      color: var(--error);
    }
    
    .modal-body {
      padding: 2rem;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Dashboard cards atualizados */
    .dashboard-section > div {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      transition: all var(--transition);
      margin-bottom: 0.5rem;
    }
    
    .dashboard-section > div:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .dashboard-section > div > div {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
      font-family: 'Poppins', sans-serif;
    }
    
    /* Responsividade atualizada */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .mobile-menu-toggle {
        display: block;
      }
      .content-wrapper {
        margin-left: 0;
      }
      .content-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }
      #user-info {
        width: 100%;
        justify-content: space-between;
      }
      .content-body {
        padding: 1rem;
      }
      main {
        padding: 1rem;
        margin: 1rem 0.5rem;
        max-width: calc(100vw - 1rem);
      }
      .form-row { 
        flex-direction: column; 
        gap: 1rem; 
      }
      .form-group {
        flex: none;
        max-width: 100%;
        min-width: auto;
      }
      .actions { 
        flex-direction: column; 
        gap: 0.8rem; 
      }
      .actions button {
        width: 100%;
        padding: 1rem 2rem;
      }
      .table-wrapper, .list-table { 
        max-width: 100vw; 
        overflow-x: auto;
      }
      .list-table { 
        min-width: 600px; 
        font-size: 0.8rem;
      }
      .list-table th, .list-table td {
        padding: 0.5rem 0.3rem;
      }
      form { 
        max-width: 100vw; 
        padding: 0;
      }
      .form-section {
        padding: 1rem;
        margin-bottom: 1.5rem;
      }
      .sizes-table {
        min-width: 300px;
        font-size: 0.8rem;
      }
      .sizes-table th, .sizes-table td {
        padding: 0.3rem 0.2rem;
      }
      .sizes-table input {
        padding: 0.3rem;
        font-size: 0.8rem;
      }
      input, select {
        padding: 0.8rem 0.8rem;
        font-size: 1rem;
      }
      .dashboard-section {
        padding: 0;
      }
      .dashboard-section > div:first-child {
        grid-template-columns: 1fr;
        gap: 0.8rem;
      }
      .dashboard-section > div:last-child {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      #pieChart, #lineChart {
        width: 250px !important;
        height: 250px !important;
      }
      header {
        padding: 1rem 1rem;
        flex-direction: column;
        gap: 1rem;
      }
      nav {
        display: flex;
        gap: 0.5rem;
        width: 100%;
        justify-content: center;
      }
      nav button {
        margin-left: 0;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        flex: 1;
        max-width: 120px;
      }
    }
    
    @media (max-width: 480px) {
      main {
        margin: 0.5rem 0.25rem;
        padding: 0.8rem 0.8rem;
      }
      .list-table {
        min-width: 500px;
        font-size: 0.75rem;
      }
      .sizes-table {
        min-width: 250px;
        font-size: 0.75rem;
      }
      input, select {
        padding: 0.7rem 0.6rem;
        font-size: 0.95rem;
      }
      .form-section h2 {
        font-size: 1rem;
        margin-bottom: 0.8rem;
      }
      h2 {
        font-size: 1.2rem;
        margin-bottom: 1rem;
      }
    }
    
    /* Responsividade para os gráficos do dashboard */
    @media (max-width: 1024px) {
      .dashboard-charts-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
    }
    
    @media (max-width: 768px) {
      .dashboard-charts-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .dashboard-charts-grid canvas {
        max-width: 100%;
        height: auto;
      }
    }
    
    /* Ajustes para ícones Material */
    .edit-btn, .delete-btn {
      font-family: 'Material Icons';
      font-size: 1.25rem;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      transition: all var(--transition);
      border-radius: var(--radius);
      margin: 0;
      min-width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .action-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
      flex-wrap: nowrap;
    }
    
    .edit-btn { 
      color: var(--primary); 
      background: var(--primary-50);
    }
    
    .edit-btn:hover { 
      color: var(--primary-dark);
      background: var(--primary-100);
      transform: scale(1.05);
    }
    
    .delete-btn { 
      color: var(--error); 
      background: var(--error-light);
    }
    
    .delete-btn:hover { 
      color: #dc2626;
      background: #fecaca;
      transform: scale(1.05);
    }
    
    /* Tabela estilo Material atualizada */
    .list-table th {
      background: var(--primary-50);
      color: var(--primary);
      font-weight: 700;
      font-family: 'Inter', sans-serif;
    }
    
    .list-table tr:nth-child(even) {
      background: var(--accent-light);
    }
    
    .list-table tr:hover {
      background: var(--primary-50);
    }
    
    /* Responsividade e detalhes atualizados */
    @media (max-width: 768px) {
      .sidebar {
        box-shadow: var(--shadow-xl);
      }
    }
    
    @media (max-width: 1200px) {
      .dashboard-section > div {
        min-width: 220px;
      }
    }
    
    @media (max-width: 900px) {
      .dashboard-section > div {
        min-width: 180px;
      }
      .dashboard-section {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (max-width: 600px) {
      .dashboard-section {
        grid-template-columns: 1fr;
      }
      .dashboard-section > div {
        min-width: 100%;
        flex-direction: column;
        align-items: flex-start;
      }
    }
    
    .sidebar {
      border-top-right-radius: var(--radius-lg);
      border-bottom-right-radius: var(--radius-lg);
    }
    
    .main-content, .content-wrapper {
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
    }
    
    /* Cadastro responsivo e agradável atualizado */
    #create-section form {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 2rem 2.5rem;
      max-width: 600px;
      margin: 2rem auto;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      border: 1px solid var(--border);
    }
    
    #create-section .form-section {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 0;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    
    #create-section .form-section h2 {
      font-size: 1.125rem;
      color: var(--primary);
      margin-bottom: 1rem;
      font-weight: 700;
      letter-spacing: -0.025em;
      font-family: 'Poppins', sans-serif;
    }
    
    #create-section .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    
    #create-section .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    #create-section label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }
    
    #create-section input, #create-section select {
      padding: 0.875rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      background: var(--surface);
      transition: all var(--transition);
      outline: none;
      font-family: 'Inter', sans-serif;
      color: var(--text);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    #create-section select {
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }
    
    #create-section input:focus, #create-section select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-100), 0 1px 2px rgba(0, 0, 0, 0.05);
      background: var(--surface);
    }
    
    #create-section input:hover, #create-section select:hover {
      border-color: var(--border-dark);
    }
    
    /* Fixar tamanho dos campos Cluster e Categoria */
    #create-section #cluster,
    #create-section #categoria {
      width: 200px;
      min-width: 200px;
      max-width: 200px;
    }
    
    /* Estilo para campos desabilitados */
    #create-section #quantidade,
    #create-section #valorTotal {
      background-color: var(--bg-secondary) !important;
      color: var(--text-muted) !important;
      cursor: not-allowed !important;
      border-color: var(--border-light) !important;
    }
    
    #create-section #quantidade:focus,
    #create-section #valorTotal:focus {
      border-color: var(--border-light) !important;
      box-shadow: none !important;
      background-color: var(--bg-secondary) !important;
    }
    
    #create-section #quantidade:hover,
    #create-section #valorTotal:hover {
      border-color: var(--border-light) !important;
      background-color: var(--bg-secondary) !important;
    }
    
    #create-section textarea {
      font-family: 'Inter', sans-serif;
      line-height: 1.5;
    }
    
    #create-section textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-100);
    }
    
    #create-section textarea:hover {
      border-color: var(--border-dark);
    }
    
    /* Inputs de tamanhos responsivos e agrupados atualizados */
    #create-section .sizes-table {
      width: 100%;
      border: none;
      background: none;
      box-shadow: none;
      margin-top: 0.75rem;
      margin-bottom: 0;
      padding: 0;
    }
    
    #create-section .sizes-table thead {
      display: none;
    }
    
    #create-section .sizes-table tbody tr {
      display: flex;
      gap: 1rem;
      justify-content: flex-start;
      flex-wrap: wrap;
      background: none;
      border: none;
    }
    
    #create-section .sizes-table td {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      background: none;
      border: none;
      padding: 0;
      min-width: 80px;
      margin-bottom: 0.5rem;
    }
    
    #create-section .sizes-table label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }
    
    #create-section .sizes-table input {
      width: 100%;
      min-width: 0;
      padding: 0.75rem 0.75rem;
      font-size: 0.95rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface);
    }
    
    /* Estilos para a seção de variedade de produto */
    .variedade-container {
      margin-top: 1rem;
    }
    
    .variedade-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .cor-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1rem;
      position: relative;
    }
    
    .cor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .cor-nome {
      font-weight: 600;
      color: var(--text);
      font-size: 1rem;
    }
    
    .remove-cor-btn {
      background: var(--error);
      color: white;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    
    .remove-cor-btn:hover {
      background: #dc2626;
    }
    
    .tamanhos-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.6rem;
    }
    
    .tamanho-item {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      min-width: 0;
    }
    
    .tamanho-item label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    
    .tamanho-item input {
      padding: 0.4rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.8rem;
      background: var(--surface);
      width: 100%;
      min-width: 0;
    }
    
    .tamanho-item input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-100);
    }
    
    @media (max-width: 1200px) {
      .tamanhos-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.8rem;
      }
    }
    
    @media (max-width: 768px) {
      .tamanhos-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.8rem;
      }
      
      .variedade-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
      }
      
      .variedade-header > div {
        flex-direction: column;
        gap: 0.8rem;
      }
      
      #nova-cor-input {
        min-width: 100% !important;
      }
    }
    
    @media (max-width: 480px) {
      .tamanhos-grid {
        grid-template-columns: 1fr;
        gap: 0.6rem;
      }
      
      .tamanho-item input {
        padding: 0.5rem;
        font-size: 0.9rem;
      }
    }
    
    #create-section .actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1rem;
    }
    
    #create-section .actions button {
      min-width: 140px;
      padding: 0.875rem 1.75rem;
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      transition: all var(--transition);
      font-family: 'Inter', sans-serif;
    }
    
    #create-section .actions button:first-child {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow);
    }
    
    #create-section .actions button:first-child:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    #create-section .actions button.secondary {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    
    #create-section .actions button.secondary:hover {
      background: var(--border-light);
      color: var(--text);
    }
    
    @media (max-width: 700px) {
      #create-section form {
        padding: 1rem;
        max-width: 98vw;
      }
      #create-section .form-row {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      #create-section .actions {
        flex-direction: column;
        gap: 0.8rem;
        align-items: stretch;
      }
    }
    
    /* Filtros de fichas cadastradas sempre em linha atualizados */
    #list-section .filtros-wrapper {
      display: flex;
      flex-direction: row;
      gap: 2rem;
      flex-wrap: nowrap;
      align-items: center;
      overflow-x: auto;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    
    #list-section .filtros-wrapper > div {
      display: flex;
      align-items: center;
      gap: 1rem;
      min-width: 220px;
    }
    
    @media (max-width: 700px) {
      #list-section .filtros-wrapper {
        gap: 1rem;
      }
      #list-section .filtros-wrapper > div {
        min-width: 180px;
      }
    }
    
    /* Cards do dashboard atualizados */
    .dashboard-section > div > div {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
      font-family: 'Poppins', sans-serif;
    }
    
    /* Estilos para os cards do dashboard */
    .backdrop-blur-md {
      backdrop-filter: blur(8px);
    }
    
    .bg-white\/60 {
      background-color: rgba(255, 255, 255, 0.6);
    }
    
    .dark\:bg-slate-800\/60 {
      background-color: rgba(30, 41, 59, 0.6);
    }
    
    .border-white\/20 {
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .dark\:border-slate-700\/40 {
      border-color: rgba(51, 65, 85, 0.4);
    }
    
    .text-blue-600 {
      color: var(--primary);
    }
    
    .bg-blue-100 {
      background-color: var(--primary-100);
    }
    
    .text-blue-700 {
      color: var(--primary-dark);
    }
    
    .text-slate-500 {
      color: var(--text-secondary);
    }
    
    .text-slate-700 {
      color: var(--text);
    }
    
    .dark\:text-white {
      color: white;
    }
    
    .border-slate-200 {
      border-color: var(--border);
    }
    
    .bg-white\/70 {
      background-color: rgba(255, 255, 255, 0.7);
    }
    
    .dark\:bg-slate-800\/60 {
      background-color: rgba(30, 41, 59, 0.6);
    }
    
    .text-slate-700 {
      color: var(--text);
    }
    
    .dark\:text-white {
      color: white;
    }
    
    .focus\:ring-2 {
      box-shadow: 0 0 0 3px var(--primary-100);
    }
    
    .focus\:ring-blue-400 {
      box-shadow: 0 0 0 3px var(--primary-200);
    }
    
    .bg-blue-50 {
      background-color: var(--primary-50);
    }
    
    .dark\:bg-slate-800\/60 {
      background-color: rgba(30, 41, 59, 0.6);
    }
    
    .text-blue-900 {
      color: var(--primary-dark);
    }
    
    .dark\:text-white {
      color: white;
    }
    
    .divide-slate-100 {
      border-color: var(--border-light);
    }
    
    .dark\:divide-slate-800 {
      border-color: rgba(30, 41, 59, 0.8);
    }
    
    /* Estilos para gráficos animados */
    .chart-container {
      position: relative;
      transition: all 0.3s ease;
    }
    
    .chart-container:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .chart-title {
      margin-bottom: 1.5rem;
      color: var(--text);
      font-size: 1.25rem;
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .chart-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border-radius: 2px;
    }
    
    .chart-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--text-muted);
      font-style: italic;
    }
    
    .chart-no-data {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--text-muted);
      text-align: center;
      padding: 2rem;
    }
    
    .chart-no-data::before {
      content: '📊';
      font-size: 2rem;
      margin-bottom: 1rem;
      display: block;
    }
    
    /* Responsividade para botões de ação */
    @media (max-width: 768px) {
      .action-buttons {
        gap: 0.3rem;
      }
      
      .edit-btn, .delete-btn {
        min-width: 36px;
        height: 36px;
        font-size: 1.1rem;
        padding: 0.4rem;
      }
    }
    
    /* Estilos para filtros do dashboard */
    #dashboard-cluster-filter:focus,
    #dashboard-period-filter:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-100);
      outline: none;
    }
    
    #dashboard-cluster-filter:hover,
    #dashboard-period-filter:hover {
      border-color: var(--border-dark);
    }
    
    /* Responsividade para filtros do dashboard */
    @media (max-width: 768px) {
      #dashboard-section > div:first-child > div {
        flex-direction: column;
        gap: 1rem;
      }
      
      #dashboard-section > div:first-child > div > div {
        min-width: 100%;
      }
      
      #dashboard-section > div:first-child > div > div:last-child {
        justify-content: stretch;
      }
      
      #dashboard-section > div:first-child > div > div:last-child button {
        flex: 1;
        justify-content: center;
      }
    }
    
    @media (max-width: 480px) {
      .action-buttons {
        gap: 0.2rem;
      }
      
      .edit-btn, .delete-btn {
        min-width: 32px;
        height: 32px;
        font-size: 1rem;
        padding: 0.3rem;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar moderna -->
  <div id="sidebar" class="fixed z-40 left-0 top-0 h-full w-64 bg-white/70 dark:bg-slate-900/80 backdrop-blur-md border-r border-white/20 dark:border-slate-700/40 shadow-2xl transition-transform duration-300 transform -translate-x-full md:translate-x-0 flex flex-col">
    <div class="sidebar-header flex items-center gap-2 px-6 py-6 border-b border-white/20 dark:border-slate-700/40">
      <span class="material-icons text-blue-600 text-3xl">dashboard</span>
      <h1 class="font-poppins text-xl font-bold text-slate-800 dark:text-white tracking-wide">Follow Up</h1>
    </div>
    <nav class="sidebar-nav flex-1 flex flex-col gap-1 px-2 py-4">
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition hover:bg-blue-100/70 dark:hover:bg-slate-800/60 text-slate-700 dark:text-white font-medium" data-screen="dashboard">
        <span class="material-icons">bar_chart</span>
        <span>Dashboards</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition hover:bg-blue-100/70 dark:hover:bg-slate-800/60 text-slate-700 dark:text-white font-medium" data-screen="create">
        <span class="material-icons">add_circle</span>
        <span>Cadastrar</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition hover:bg-blue-100/70 dark:hover:bg-slate-800/60 text-slate-700 dark:text-white font-medium" data-screen="list">
        <span class="material-icons">dashboard</span>
        <span>Fichas</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition hover:bg-blue-100/70 dark:hover:bg-slate-800/60 text-slate-700 dark:text-white font-medium" data-screen="categorias">
        <span class="material-icons">category</span>
        <span>Categorias</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition hover:bg-blue-100/70 dark:hover:bg-slate-800/60 text-slate-700 dark:text-white font-medium" data-screen="clusters">
        <span class="material-icons">business</span>
        <span>Clusters</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition hover:bg-blue-100/70 dark:hover:bg-slate-800/60 text-slate-700 dark:text-white font-medium" data-screen="configuracoes">
        <span class="material-icons">settings</span>
        <span>Configurações</span>
      </div>
      
      <!-- Separador -->
      <div class="flex-1"></div>
      
      <!-- Botão de Logout -->
      <div class="border-t border-white/20 dark:border-slate-700/40 pt-4 mt-4">
        <div id="logout-button" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer transition hover:bg-red-100/70 dark:hover:bg-red-900/60 text-red-600 dark:text-red-400 font-medium">
          <span class="material-icons">logout</span>
          <span>Sair</span>
        </div>
      </div>
    </nav>
  </div>

  <!-- Botão de menu mobile -->
  <button id="mobile-menu-toggle" class="fixed top-4 left-4 z-50 md:hidden bg-blue-600 text-white rounded-full p-3 shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
    <span class="material-icons">menu</span>
  </button>

  <div class="content-wrapper md:ml-64 transition-all duration-300">
    <div class="content-header">
      <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <h2 id="page-title">Dashboard de Produção</h2>
          <div id="empresa-info" style="display: none; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--primary-50); border: 1px solid var(--primary-200); border-radius: var(--radius); color: var(--primary-dark); font-size: 0.9rem; font-weight: 500;">
            <span class="material-icons" style="font-size: 1rem;">business</span>
            <span id="empresa-nome-display">Nome da Empresa</span>
          </div>
        </div>
        
        <!-- Informações do usuário logado -->
        <div id="user-info" style="display: none; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow);">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <img id="user-photo" src="" alt="Foto do usuário" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary);" />
            <div style="display: flex; flex-direction: column; gap: 0.125rem;">
              <span id="user-name" style="font-weight: 600; color: var(--text); font-size: 0.9rem;">Nome do Usuário</span>
              <span id="user-email" style="color: var(--text-secondary); font-size: 0.8rem;">email@exemplo.com</span>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; background: var(--primary-50); border-radius: 4px;">
            <span class="material-icons" style="font-size: 0.875rem; color: var(--primary);">verified</span>
            <span style="font-size: 0.75rem; color: var(--primary); font-weight: 500;">Logado</span>
          </div>
        </div>
      </div>
    </div>
    <div class="content-body">
      <section id="list-section" style="display: none;">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
          <div class="flex flex-wrap gap-4 items-center">
            <div class="flex items-center gap-3 min-w-[200px]">
              <label for="cluster-filter" class="font-medium text-gray-700 text-sm">Filtrar por Cluster:</label>
              <select id="cluster-filter" class="px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-primary outline-none text-sm">
                <option value="">Todos os Clusters</option>
              </select>
            </div>
            <div class="flex items-center gap-3 min-w-[200px]">
              <label for="categoria-filter" class="font-medium text-gray-700 text-sm">Filtrar por Categoria:</label>
              <select id="categoria-filter" class="px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-primary outline-none text-sm">
                <option value="">Todas as Categorias</option>
              </select>
            </div>
            <div class="flex items-center gap-3 min-w-[200px]">
              <label for="pagamento-filter" class="font-medium text-gray-700 text-sm">Pagamentos:</label>
              <select id="pagamento-filter" class="px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-primary outline-none text-sm">
                <option value="">Todos os Pagamentos</option>
                <option value="pago">Pago</option>
                <option value="nao-pago">Não Pago</option>
              </select>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <table class="min-w-[800px] w-full text-sm">
          <thead>
              <tr class="bg-gray-50 border-b border-gray-200">
                <th class="px-4 py-3 font-semibold text-gray-700 text-left">Cluster</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-left">Categoria</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-left">Referência</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-center">Qtd. Peças</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-center">Valor Unit.</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-center">Valor Total</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-center">Pilotagem</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-center">Saída</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-center">Pagamento</th>
                <th class="px-4 py-3 font-semibold text-gray-700 text-center">Ações</th>
            </tr>
          </thead>
            <tbody id="fichas-list" class="divide-y divide-gray-100">
            <!-- Linhas dinâmicas -->
          </tbody>
        </table>
        </div>
      </section>
      <section id="create-section" style="display: none;">
        <form id="ficha-form" autocomplete="off">
          <div class="form-section">
            <h2>🗂️ Informações Gerais</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="cluster">Cluster</label>
                <select id="cluster" required>
                  <option value="">Selecione um cluster</option>
                </select>
              </div>
              <div class="form-group">
                <label for="categoria">Categoria</label>
                <select id="categoria" required>
                  <option value="">Selecione uma categoria</option>
                </select>
              </div>
              <div class="form-group">
                <label for="referencia">Referência</label>
                <input type="text" id="referencia" required />
              </div>
              <div class="form-group">
                <label for="quantidade">Quantidade de peças</label>
                <input type="number" id="quantidade" min="1" required disabled />
              </div>
              <div class="form-group">
                <label for="valorUnitario">Valor unitário</label>
                <input type="number" id="valorUnitario" min="0" step="0.01" required onchange="calcularValorTotal()" />
              </div>
              <div class="form-group">
                <label for="valorTotal">Valor total</label>
                <input type="number" id="valorTotal" min="0" step="0.01" required readonly disabled />
              </div>
            </div>
          </div>
          <div class="form-section">
            <h2>🧪 Processos</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="entrada">Data de entrada</label>
                <input type="date" id="entrada" />
              </div>
              <div class="form-group">
                <label for="pilotagem">Pilotagem</label>
                <select id="pilotagem" required>
                  <option value="Sim">Sim</option>
                  <option value="Não">Não</option>
                </select>
              </div>
              <div class="form-group">
                <label for="saida">Data de saída</label>
                <input type="date" id="saida" required />
              </div>
              <div class="form-group">
                <label for="pagamento">Pagamento / data</label>
                <input type="date" id="pagamento" />
              </div>
            </div>
          </div>
          <div class="form-section">
            <h2>🎨 Variedade de Produto</h2>
            <div class="variedade-container">
              <div class="variedade-header">
                <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.1rem; font-weight: 600;">Cores/Estampas</h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                  <input type="text" id="nova-cor-input" placeholder="Digite o nome da cor/estampa (ex: Branca)" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem; min-width: 250px;" />
                  <button type="button" id="add-cor-btn" style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                    <span class="material-icons" style="font-size: 1rem;">add</span>
                    Adicionar
                  </button>
                </div>
              </div>
              <div id="cores-container">
                <!-- Cores serão adicionadas dinamicamente aqui -->
              </div>
            </div>
          </div>
          <div class="form-section">
            <h2>📝 Observações</h2>
            <div class="form-row">
              <div class="form-group" style="flex: 1 1 100%;">
                <label for="observacoes">Observações</label>
                <textarea id="observacoes" rows="4" placeholder="Digite observações adicionais sobre a ficha (opcional)" style="width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.95rem; background: var(--surface); transition: all var(--transition); outline: none; font-family: 'Inter', sans-serif; color: var(--text); resize: vertical; min-height: 100px;"></textarea>
              </div>
            </div>
          </div>
          <div class="actions">
            <button type="submit">Cadastrar</button>
            <button type="button" class="secondary" id="cancelar-btn">Cancelar</button>
          </div>
        </form>
      </section>
      <section id="dashboard-section" style="display: block;">
        <!-- Filtros do Dashboard -->
        <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 2rem;">
          <div style="display: flex; align-items: end; gap: 1.5rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <label for="dashboard-cluster-filter" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif; font-size: 0.9rem;">Cluster:</label>
              <select id="dashboard-cluster-filter" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition); font-size: 0.9rem;">
                <option value="">Todos os Clusters</option>
              </select>
            </div>
            <div style="flex: 1; min-width: 200px;">
              <label for="dashboard-period-filter" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif; font-size: 0.9rem;">Período:</label>
              <select id="dashboard-period-filter" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition); font-size: 0.9rem;">
                <option value="">Todos os Períodos</option>
                <option value="7">Últimos 7 dias</option>
                <option value="30">Últimos 30 dias</option>
                <option value="90">Últimos 90 dias</option>
                <option value="180">Últimos 6 meses</option>
                <option value="365">Último ano</option>
              </select>
            </div>
            <div style="display: flex; gap: 0.75rem; align-items: end;">
              <button onclick="applyDashboardFilters()" style="background: var(--primary); color: white; border: none; padding: 0.75rem 1.25rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; box-shadow: var(--shadow); display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem;">filter_alt</span>
                Aplicar
              </button>
              <button onclick="clearDashboardFilters()" style="background: var(--bg-secondary); color: var(--text); border: 1px solid var(--border); padding: 0.75rem 1.25rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem;">clear</span>
                Limpar
              </button>
              <button onclick="showDashboardReport()" style="background: var(--success); color: white; border: none; padding: 0.75rem 1.25rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; box-shadow: var(--shadow); display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem;">assessment</span>
                Relatório
              </button>
            </div>
          </div>
        </div>

        <!-- Resumo Técnico -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 mb-8">
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-primary-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-primary">inventory_2</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="total-pecas">0</div>
              <div class="text-gray-600 text-sm font-medium">Total de Peças Produzidas</div>
            </div>
          </div>
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-primary-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-primary">assignment</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="total-fichas">0</div>
              <div class="text-gray-600 text-sm font-medium">Total de Fichas Cadastradas</div>
            </div>
          </div>
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-green-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-green-600">attach_money</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="total-valor">R$ 0,00</div>
              <div class="text-gray-600 text-sm font-medium">Valor Total Produzido</div>
            </div>
          </div>
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-blue-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-blue-600">groups</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="total-clusters">0</div>
              <div class="text-gray-600 text-sm font-medium">Clusters Ativos</div>
            </div>
          </div>
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-purple-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-purple-600">category</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="total-categorias">0</div>
              <div class="text-gray-600 text-sm font-medium">Categorias Utilizadas</div>
            </div>
          </div>
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-orange-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-orange-600">trending_up</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="media-valor">R$ 0,00</div>
              <div class="text-gray-600 text-sm font-medium">Valor Médio por Ficha</div>
            </div>
          </div>
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-indigo-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-indigo-600">format_list_numbered</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="media-pecas">0</div>
              <div class="text-gray-600 text-sm font-medium">Média de Peças por Ficha</div>
            </div>
          </div>
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-emerald-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-emerald-600">check_circle</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="pilotagem-sim">0</div>
              <div class="text-gray-600 text-sm font-medium">Fichas com Pilotagem</div>
            </div>
          </div>
          <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 flex items-center gap-4 transition-all duration-200 hover:shadow-md hover:border-primary-200">
            <div class="bg-teal-100 p-3 rounded-xl">
              <span class="material-icons text-2xl text-teal-600">monetization_on</span>
            </div>
            <div class="text-left">
              <div class="font-poppins text-2xl font-bold text-gray-900 mb-1" id="valor-medio-peca">R$ 0,00</div>
              <div class="text-gray-600 text-sm font-medium">Valor Médio por Peça</div>
            </div>
          </div>
        </div>

        <!-- Gráficos -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
          <!-- Gráfico de Pizza -->
          <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.25rem; font-weight: 600; font-family: 'Poppins', sans-serif;">Produção por Cluster</h3>
            <div style="display: flex; justify-content: center;">
              <canvas id="pieChart" width="300" height="300"></canvas>
            </div>
            <div id="chart-legend" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 0.75rem; margin-top: 1.5rem;"></div>
          </div>

          <!-- Gráfico de Linha -->
          <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.25rem; font-weight: 600; font-family: 'Poppins', sans-serif;">Produção por Período</h3>
            <div style="display: flex; justify-content: center;">
              <canvas id="lineChart" width="300" height="300"></canvas>
            </div>
          </div>
        </div>
        <!-- Gráficos de Categoria e Tempo de Produção lado a lado -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;" class="dashboard-charts-grid">
          <!-- Gráfico de Pizza por Categoria -->
          <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.25rem; font-weight: 600; font-family: 'Poppins', sans-serif;">Quantidade de Peças por Categoria</h3>
            <div style="display: flex; justify-content: center;">
              <canvas id="pieCategoriaChart" width="320" height="320"></canvas>
            </div>
            <div id="pie-categoria-legend" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 0.75rem; margin-top: 1.5rem;"></div>
          </div>
          
          <!-- Gráfico de Tempo de Produção -->
          <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.25rem; font-weight: 600; font-family: 'Poppins', sans-serif;">Tempo de Produção (dias)</h3>
            <div style="display: flex; justify-content: center;">
              <canvas id="tempoProducaoChart" width="320" height="320"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section id="configuracoes-section" style="display: none;">
        <h2 style="margin-bottom:1.5rem;">Configurações do Sistema</h2>
        
        <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem; max-width: 600px;">
          <!-- Configurações Gerais -->
          <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--primary); font-size: 1.25rem;">settings</span>
              Configurações Gerais
            </h3>
            <form id="config-form">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label for="empresa-nome" style="display: block; margin-bottom: 0.3rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif; font-size: 0.9rem;">Nome da Empresa</label>
                  <input type="text" id="empresa-nome" placeholder="Digite o nome da empresa" style="width: 100%; padding: 0.6rem 0.8rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition); font-size: 0.9rem;" />
                </div>
                <div>
                  <label for="empresa-cnpj" style="display: block; margin-bottom: 0.3rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif; font-size: 0.9rem;">CNPJ</label>
                  <input type="text" id="empresa-cnpj" placeholder="00.000.000/0000-00" maxlength="18" style="width: 100%; padding: 0.6rem 0.8rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition); font-size: 0.9rem;" />
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                  <label for="empresa-endereco" style="display: block; margin-bottom: 0.3rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif; font-size: 0.9rem;">Endereço</label>
                  <input type="text" id="empresa-endereco" placeholder="Digite o endereço completo" style="width: 100%; padding: 0.6rem 0.8rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition); font-size: 0.9rem;" />
                </div>
                <div>
                  <label for="empresa-telefone" style="display: block; margin-bottom: 0.3rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif; font-size: 0.9rem;">Telefone</label>
                  <input type="text" id="empresa-telefone" placeholder="(00) 00000-0000" maxlength="15" style="width: 100%; padding: 0.6rem 0.8rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition); font-size: 0.9rem;" />
                </div>
              </div>
              <button type="submit" style="background: var(--primary); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; box-shadow: var(--shadow); font-size: 0.9rem;">Salvar Configurações</button>
            </form>
            
            <style>
              #config-form input:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 3px var(--primary-100);
                outline: none;
              }
              #config-form input:hover {
                border-color: var(--border-dark);
              }
              #config-form button:hover {
                background: var(--primary-dark);
                transform: translateY(-1px);
                box-shadow: var(--shadow-lg);
              }
              
              /* Estilos para o formulário de clusters */
              #cluster-form input:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 3px var(--primary-100);
                outline: none;
              }
              #cluster-form input:hover {
                border-color: var(--border-dark);
              }
              #cluster-form button:hover {
                background: var(--primary-dark);
                transform: translateY(-1px);
                box-shadow: var(--shadow-lg);
              }
            </style>
            </form>
          </div>
          
          <!-- Backup e Restauração -->
          <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--primary); font-size: 1.25rem;">backup</span>
              Backup e Restauração
            </h3>
            <p style="color: var(--muted); margin-bottom: 1rem; font-size: 0.85rem; line-height: 1.4;">Faça backup dos seus dados ou restaure de um arquivo anterior.</p>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
              <button onclick="exportarDados()" style="background: var(--primary); color: white; border: none; padding: 0.75rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem;">download</span>
                Exportar Dados
              </button>
              <button onclick="importarDados()" style="background: var(--bg-secondary); color: var(--text); border: 1px solid var(--border); padding: 0.75rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9rem;">
                <span class="material-icons" style="font-size: 1rem;">upload</span>
                Importar Dados
              </button>
            </div>
            <input type="file" id="import-file" accept=".json" style="display: none;" />
          </div>
          
          <!-- Limpeza de Dados -->
          <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--error); font-size: 1.25rem;">delete_forever</span>
              Limpeza de Dados
            </h3>
            <p style="color: var(--muted); margin-bottom: 1rem; font-size: 0.85rem; line-height: 1.4;">Ações irreversíveis. Use com cuidado.</p>
            <button onclick="limparTodosDados()" style="background: var(--error); color: white; border: none; padding: 0.75rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9rem; width: 100%;">
              <span class="material-icons" style="font-size: 1rem;">delete_sweep</span>
              Limpar Todos os Dados
            </button>
          </div>
          
          <!-- Informações do Sistema -->
          <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
            <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.1rem; font-weight: 600; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--primary); font-size: 1.25rem;">info</span>
              Informações do Sistema
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.85rem;">
              <div>
                <p style="color: var(--text-secondary); margin-bottom: 0.5rem; font-family: 'Inter', sans-serif;"><strong style="color: var(--text);">Versão:</strong> 1.0.0</p>
                <p style="color: var(--text-secondary); margin-bottom: 0.5rem; font-family: 'Inter', sans-serif;"><strong style="color: var(--text);">Desenvolvido por:</strong> Follow Up</p>
              </div>
              <div>
                <p style="color: var(--text-secondary); margin-bottom: 0.5rem; font-family: 'Inter', sans-serif;"><strong style="color: var(--text);">Total de fichas:</strong> <span id="total-fichas-config">0</span></p>
                <p style="color: var(--text-secondary); margin-bottom: 0.5rem; font-family: 'Inter', sans-serif;"><strong style="color: var(--text);">Espaço usado:</strong> <span id="espaco-usado">0 KB</span></p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal de Edição -->
  <div class="modal-overlay" id="edit-modal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3>Editar Ficha</h3>
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="edit-form">
          <div class="form-section">
            <h2>🗂️ Informações Gerais</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="edit-cluster">Cluster</label>
                <select id="edit-cluster" required>
                  <option value="">Selecione um cluster</option>
                </select>
              </div>
              <div class="form-group">
                <label for="edit-categoria">Categoria</label>
                <select id="edit-categoria" required>
                  <option value="">Selecione uma categoria</option>
                </select>
              </div>
              <div class="form-group">
                <label for="edit-referencia">Referência</label>
                <input type="text" id="edit-referencia" required />
              </div>
              <div class="form-group">
                <label for="edit-quantidade">Quantidade de peças</label>
                <input type="number" id="edit-quantidade" min="1" required disabled />
              </div>
              <div class="form-group">
                <label for="edit-valorUnitario">Valor unitário</label>
                <input type="number" id="edit-valorUnitario" min="0" step="0.01" required onchange="calcularValorTotalEdit()" />
              </div>
              <div class="form-group">
                <label for="edit-valorTotal">Valor total</label>
                <input type="number" id="edit-valorTotal" min="0" step="0.01" required readonly disabled />
              </div>
            </div>
          </div>
          <div class="form-section">
            <h2>🧪 Processos</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="edit-entrada">Data de entrada</label>
                <input type="date" id="edit-entrada" />
              </div>
              <div class="form-group">
                <label for="edit-pilotagem">Pilotagem</label>
                <select id="edit-pilotagem" required>
                  <option value="Sim">Sim</option>
                  <option value="Não">Não</option>
                </select>
              </div>
              <div class="form-group">
                <label for="edit-saida">Data de saída</label>
                <input type="date" id="edit-saida" required />
              </div>
              <div class="form-group">
                <label for="edit-pagamento">Pagamento / data</label>
                <input type="date" id="edit-pagamento" />
              </div>
            </div>
          </div>
          <div class="form-section">
            <h2>🎨 Variedade de Produto</h2>
            <div class="variedade-container">
              <div class="variedade-header">
                <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.1rem; font-weight: 600;">Cores/Estampas</h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                  <input type="text" id="edit-nova-cor-input" placeholder="Digite o nome da cor/estampa (ex: Branca)" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem; min-width: 250px;" />
                  <button type="button" id="edit-add-cor-btn" style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                    <span class="material-icons" style="font-size: 1rem;">add</span>
                    Adicionar
                  </button>
                </div>
              </div>
              <div id="edit-cores-container">
                <!-- Cores serão adicionadas dinamicamente aqui -->
              </div>
            </div>
          </div>
          <div class="form-section">
            <h2>📝 Observações</h2>
            <div class="form-row">
              <div class="form-group" style="flex: 1 1 100%;">
                <label for="edit-observacoes">Observações</label>
                <textarea id="edit-observacoes" rows="4" placeholder="Digite observações adicionais sobre a ficha (opcional)" style="width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.95rem; background: var(--surface); transition: all var(--transition); outline: none; font-family: 'Inter', sans-serif; color: var(--text); resize: vertical; min-height: 100px;"></textarea>
              </div>
            </div>
          </div>
          <div class="actions">
            <button type="submit">Salvar Alterações</button>
            <button type="button" class="secondary" onclick="closeEditModal()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de Detalhes -->
  <div class="modal-overlay" id="details-modal" style="display: none;">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>Detalhes da Ficha</h3>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button onclick="exportFichaToPDF()" style="background: var(--success); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
            <span class="material-icons" style="font-size: 1rem;">download</span>
            Exportar PDF
          </button>
          <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="ficha-details-content">
          <!-- Conteúdo será preenchido dinamicamente -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Relatório do Dashboard -->
  <div class="modal-overlay" id="report-modal" style="display: none;">
    <div class="modal" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>Relatório Detalhado - Dashboard de Produção</h3>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button onclick="exportReportToPDF()" style="background: var(--success); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
            <span class="material-icons" style="font-size: 1rem;">download</span>
            Exportar PDF
          </button>
          <button class="modal-close" onclick="closeReportModal()">&times;</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="report-content">
          <!-- Conteúdo será preenchido dinamicamente -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Função para testar localStorage
    function testLocalStorage() {
      try {
        const testKey = 'test_' + Date.now();
        const testValue = 'test_value_' + Date.now();
        
        localStorage.setItem(testKey, testValue);
        const retrievedValue = localStorage.getItem(testKey);
        localStorage.removeItem(testKey);
        
        return retrievedValue === testValue;
      } catch (error) {
        console.error('Erro ao testar localStorage:', error);
        return false;
      }
    }

    // Verificação de login robusta para Firefox
    async function checkLogin() {
      try {
        console.log('Iniciando verificação de login...');
        
        // Primeiro, tentar verificar Firebase Auth
        if (window.FirebaseAuth) {
          try {
            console.log('🔄 Verificando Firebase Auth...');
            const currentUser = await window.FirebaseAuth.getCurrentUser();
            
            if (currentUser) {
              console.log('✅ Usuário autenticado no Firebase:', currentUser.email);
              
              // Salvar dados no localStorage para compatibilidade
              try {
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUser', currentUser.email);
                localStorage.setItem('loginTimestamp', Date.now().toString());
                localStorage.setItem('userDisplayName', currentUser.displayName || currentUser.email);
                localStorage.setItem('userPhotoURL', currentUser.photoURL || '');
              } catch (localError) {
                console.log('⚠️ Não foi possível salvar no localStorage:', localError);
              }
              
              return true;
            } else {
              console.log('❌ Usuário não autenticado no Firebase');
            }
          } catch (firebaseError) {
            console.error('❌ Erro ao verificar Firebase Auth:', firebaseError);
          }
        }
        
        // Fallback para verificação local
        console.log('🔄 Verificando login local...');
        
        // Verificar se localStorage está disponível
        if (typeof localStorage === 'undefined') {
          console.error('localStorage não está disponível');
          redirectToLogin();
          return false;
        }
        
        // Testar localStorage primeiro
        if (!testLocalStorage()) {
          console.error('localStorage não está funcionando corretamente');
          redirectToLogin();
          return false;
        }
        
        // Verificar dados de login no localStorage
        let isLoggedIn = localStorage.getItem('isLoggedIn');
        let currentUser = localStorage.getItem('currentUser');
        let loginTimestamp = localStorage.getItem('loginTimestamp');
        
        console.log('Verificação localStorage:', { isLoggedIn, currentUser, loginTimestamp });
        
        // Se localStorage falhou, tentar sessionStorage
        if (!isLoggedIn || isLoggedIn !== 'true' || !currentUser) {
          console.log('localStorage falhou, tentando sessionStorage...');
          
          if (typeof sessionStorage !== 'undefined') {
            const sessionLogin = sessionStorage.getItem('isLoggedIn');
            const sessionUser = sessionStorage.getItem('currentUser');
            const sessionTimestamp = sessionStorage.getItem('loginTimestamp');
            
            console.log('Verificação sessionStorage:', { sessionLogin, sessionUser, sessionTimestamp });
            
            if (sessionLogin === 'true' && sessionUser) {
              console.log('Login encontrado no sessionStorage');
              // Migrar para localStorage se possível
              try {
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUser', sessionUser);
                localStorage.setItem('loginTimestamp', sessionTimestamp || Date.now().toString());
                console.log('Dados migrados para localStorage');
              } catch (migrationError) {
                console.log('Não foi possível migrar para localStorage, continuando com sessionStorage');
              }
              return true;
            }
          }
          
          // Se ambos falharam, tentar verificar novamente após delay
          console.log('Ambas verificações falharam, tentando novamente após delay...');
          
          setTimeout(() => {
            const retryLocalLogin = localStorage.getItem('isLoggedIn');
            const retryLocalUser = localStorage.getItem('currentUser');
            const retrySessionLogin = sessionStorage.getItem('isLoggedIn');
            const retrySessionUser = sessionStorage.getItem('currentUser');
            
            console.log('Verificação após delay:', {
              localStorage: { login: retryLocalLogin, user: retryLocalUser },
              sessionStorage: { login: retrySessionLogin, user: retrySessionUser }
            });
            
            if ((retryLocalLogin === 'true' && retryLocalUser) || 
                (retrySessionLogin === 'true' && retrySessionUser)) {
              console.log('Login encontrado após delay');
            } else {
              console.log('Login não encontrado após delay, redirecionando...');
              redirectToLogin();
            }
          }, 500);
          
          return false;
        }
        
        console.log('Usuário logado via localStorage, continuando...');
        return true;
      } catch (error) {
        console.error('Erro ao verificar login:', error);
        redirectToLogin();
        return false;
      }
    }
    
    // Função para redirecionar para login
    function redirectToLogin() {
      // Adicionar timestamp para evitar cache
      const timestamp = Date.now();
      const loginUrl = `index.html?t=${timestamp}&redirected=true`;
      
      console.log('Redirecionando para login:', loginUrl);
      
      // Pequeno delay para garantir que tudo foi processado
      setTimeout(() => {
        window.location.href = loginUrl;
      }, 100);
    }

    // Função de logout
    async function logout() {
      try {
        console.log('🔄 Iniciando logout...');
        
        // Logout do Firebase Auth
        if (window.FirebaseAuth) {
          console.log('🔄 Fazendo logout do Firebase Auth...');
          await window.FirebaseAuth.signOutUser();
          console.log('✅ Logout do Firebase realizado com sucesso');
        } else {
          console.log('⚠️ FirebaseAuth não disponível, pulando logout do Firebase');
        }
        
        // Limpar localStorage
        console.log('🔄 Limpando localStorage...');
        const keysToRemove = [
          'isLoggedIn',
          'currentUser', 
          'loginTimestamp',
          'userDisplayName',
          'userPhotoURL'
        ];
        
        keysToRemove.forEach(key => {
          try {
            localStorage.removeItem(key);
            console.log(`✅ Removido do localStorage: ${key}`);
          } catch (error) {
            console.error(`❌ Erro ao remover ${key} do localStorage:`, error);
          }
        });
        
        // Limpar sessionStorage também
        if (typeof sessionStorage !== 'undefined') {
          console.log('🔄 Limpando sessionStorage...');
          keysToRemove.forEach(key => {
            try {
              sessionStorage.removeItem(key);
              console.log(`✅ Removido do sessionStorage: ${key}`);
            } catch (error) {
              console.error(`❌ Erro ao remover ${key} do sessionStorage:`, error);
            }
          });
        }
        
        console.log('✅ Logout realizado, todos os dados limpos');
        
        // Pequeno delay para garantir que tudo foi processado
        setTimeout(() => {
          console.log('🔄 Redirecionando para página de login...');
          const timestamp = Date.now();
          const loginUrl = `index.html?t=${timestamp}&logout=true`;
          window.location.href = loginUrl;
        }, 500);
        
      } catch (error) {
        console.error('❌ Erro ao fazer logout:', error);
        console.error('❌ Detalhes do erro:', error.message);
        
        // Mesmo com erro, limpar dados locais e redirecionar
        console.log('🔄 Limpando dados locais mesmo com erro...');
        try {
          localStorage.removeItem('isLoggedIn');
          localStorage.removeItem('currentUser');
          localStorage.removeItem('loginTimestamp');
          localStorage.removeItem('userDisplayName');
          localStorage.removeItem('userPhotoURL');
        } catch (localError) {
          console.error('❌ Erro ao limpar localStorage:', localError);
        }
        
        // Redirecionar mesmo com erro
        setTimeout(() => {
          console.log('🔄 Redirecionando para login mesmo com erro...');
          const timestamp = Date.now();
          const loginUrl = `index.html?t=${timestamp}&logout=true&error=true`;
          window.location.href = loginUrl;
        }, 1000);
      }
    }

    // Verificar login após o DOM estar carregado
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('DOM carregado, verificando login...');
      
      // Verificar se localStorage está disponível
      if (typeof localStorage === 'undefined') {
        console.error('localStorage não está disponível');
        redirectToLogin();
        return;
      }
      
      // Verificar se foi redirecionado do login
      const urlParams = new URLSearchParams(window.location.search);
      const redirected = urlParams.get('redirected');
      const user = urlParams.get('user');
      const firefox = urlParams.get('firefox');
      
      if (redirected === 'true' && user) {
        console.log('Usuário redirecionado do login:', user);
        // Verificar se o login foi salvo corretamente
        const savedLogin = localStorage.getItem('isLoggedIn');
        const savedUser = localStorage.getItem('currentUser');
        
        if (savedLogin === 'true' && savedUser === user) {
          console.log('Login verificado após redirecionamento');
        } else {
          console.log('Login não encontrado após redirecionamento, salvando...');
          localStorage.setItem('isLoggedIn', 'true');
          localStorage.setItem('currentUser', user);
          localStorage.setItem('loginTimestamp', Date.now().toString());
        }
      }
      
      // Verificação específica para Firefox
      if (firefox === 'true' && user) {
        console.log('Detectado redirecionamento do Firefox, verificando login...');
        
        // Verificar localStorage primeiro
        let savedLogin = localStorage.getItem('isLoggedIn');
        let savedUser = localStorage.getItem('currentUser');
        
        if (savedLogin === 'true' && savedUser === user) {
          console.log('Login encontrado no localStorage');
        } else {
          // Verificar sessionStorage
          const sessionLogin = sessionStorage.getItem('isLoggedIn');
          const sessionUser = sessionStorage.getItem('currentUser');
          
          if (sessionLogin === 'true' && sessionUser === user) {
            console.log('Login encontrado no sessionStorage, migrando para localStorage...');
            try {
              localStorage.setItem('isLoggedIn', 'true');
              localStorage.setItem('currentUser', user);
              localStorage.setItem('loginTimestamp', Date.now().toString());
            } catch (error) {
              console.log('Não foi possível migrar para localStorage');
            }
          } else {
            console.log('Login não encontrado, salvando...');
            try {
              localStorage.setItem('isLoggedIn', 'true');
              localStorage.setItem('currentUser', user);
              localStorage.setItem('loginTimestamp', Date.now().toString());
            } catch (error) {
              console.log('Falha ao salvar no localStorage, tentando sessionStorage...');
              sessionStorage.setItem('isLoggedIn', 'true');
              sessionStorage.setItem('currentUser', user);
              sessionStorage.setItem('loginTimestamp', Date.now().toString());
            }
          }
        }
      }
      
      const isLoggedIn = await checkLogin();
      if (!isLoggedIn) {
        return; // A função checkLogin já redireciona se necessário
      }
      
      // Exibir informações do usuário logado
      try {
        await updateUserInfo();
      } catch (error) {
        console.error('Erro ao exibir informações do usuário:', error);
      }
      
      // Carregar dados do Firebase
      console.log('🔄 Iniciando carregamento do Firebase...');
      waitForFirebaseAuth().then(() => {
        console.log('✅ Carregamento do Firebase concluído');
      }).catch(error => {
        console.error('❌ Erro no carregamento do Firebase:', error);
      });
      
      // Adicionar event listener para o botão de logout
      const logoutButton = document.getElementById('logout-button');
      if (logoutButton) {
        console.log('✅ Botão de logout encontrado, adicionando event listener...');
        logoutButton.addEventListener('click', async () => {
          try {
            console.log('🔄 Botão de logout clicado...');
            
            // Feedback visual - desabilitar botão
            const originalText = logoutButton.innerHTML;
            logoutButton.innerHTML = `
              <span class="material-icons">hourglass_empty</span>
              <span>Saindo...</span>
            `;
            logoutButton.style.pointerEvents = 'none';
            logoutButton.style.opacity = '0.7';
            
            // Executar logout
            await logout();
            
          } catch (error) {
            console.error('❌ Erro ao fazer logout:', error);
            console.error('❌ Detalhes do erro:', error.message);
            
            // Restaurar botão em caso de erro
            logoutButton.innerHTML = `
              <span class="material-icons">logout</span>
              <span>Sair</span>
            `;
            logoutButton.style.pointerEvents = 'auto';
            logoutButton.style.opacity = '1';
            
            // Mesmo com erro, redirecionar para login
            setTimeout(() => {
              console.log('🔄 Redirecionando para login após erro...');
              const timestamp = Date.now();
              const loginUrl = `index.html?t=${timestamp}&logout=true&error=true`;
              window.location.href = loginUrl;
            }, 1000);
          }
        });
        console.log('✅ Event listener do logout adicionado com sucesso');
      } else {
        console.error('❌ Botão de logout não encontrado');
      }
    });

    // Navegação entre telas
    const sidebar = document.getElementById('sidebar');
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const navItems = document.querySelectorAll('.nav-item');
    const pageTitle = document.getElementById('page-title');
    const listSection = document.getElementById('list-section');
    const createSection = document.getElementById('create-section');
    const dashboardSection = document.getElementById('dashboard-section');
    const configuracoesSection = document.getElementById('configuracoes-section');
    const fichaForm = document.getElementById('ficha-form');
    const editForm = document.getElementById('edit-form');
    const editModal = document.getElementById('edit-modal');
    const cancelarBtn = document.getElementById('cancelar-btn');
    const fichasList = document.getElementById('fichas-list');
    const fichasTable = document.getElementById('fichas-table');
    const clusterFilter = document.getElementById('cluster-filter');
    const categoriaFilter = document.getElementById('categoria-filter');
    const configForm = document.getElementById('config-form');

    let fichas = [];
    let filteredFichas = [];
    let editingIndex = -1;
    
    // Variáveis para gerenciar cores no modal de edição
    let editCoresArray = [];
    let editCorCounter = 0;
    
    // Função para carregar fichas do Firebase
    async function loadFichasFromFirebase() {
      try {
        console.log('🔄 Carregando fichas do Firebase...');
        
        if (window.FirebaseAuth) {
          console.log('✅ FirebaseAuth disponível, verificando usuário...');
          
          // Verificar se há usuário autenticado
          const currentUser = await window.FirebaseAuth.getCurrentUser();
          console.log('👤 Usuário atual:', currentUser ? currentUser.email : 'Não autenticado');
          
          if (!currentUser) {
            console.error('❌ Usuário não autenticado');
            // Fallback para localStorage
            fichas = JSON.parse(localStorage.getItem('fichas') || '[]');
            filteredFichas = [...fichas];
            return;
          }
          
          const firebaseFichas = await window.FirebaseAuth.getFichas();
          fichas = firebaseFichas || [];
          filteredFichas = [...fichas];
          
          console.log('✅ Fichas carregadas do Firebase:', fichas.length);
          console.log('✅ Fichas filtradas:', filteredFichas.length);
          console.log('📊 Dados das fichas:', fichas);
          
          // Atualizar dashboard se estiver na tela de dashboard
          if (document.getElementById('dashboard-section').style.display === 'block') {
            console.log('🔄 Atualizando dashboard...');
            renderDashboard();
          }
          
          // Atualizar lista se estiver na tela de lista
          if (document.getElementById('list-section').style.display === 'block') {
            console.log('🔄 Atualizando lista de fichas...');
            renderFichas();
          }
          
          // Atualizar filtros
          console.log('🔄 Atualizando filtros...');
          await updateClusterFilter();
          await updateCategoriaFilter();
          updatePagamentoFilter();
          await updateClusterSelects();
          await updateCategoriaSelects();
        } else {
          console.error('❌ FirebaseAuth não está disponível');
          // Fallback para localStorage
          fichas = JSON.parse(localStorage.getItem('fichas') || '[]');
          filteredFichas = [...fichas];
        }
      } catch (error) {
        console.error('❌ Erro ao carregar fichas do Firebase:', error);
        console.error('❌ Detalhes do erro:', error.message);
        // Fallback para localStorage
        fichas = JSON.parse(localStorage.getItem('fichas') || '[]');
        filteredFichas = [...fichas];
      }
    }
    
    // Função para carregar clusters do Firebase
    async function loadClustersFromFirebase() {
      try {
        console.log('🔄 Carregando clusters do Firebase...');
        
        if (window.FirebaseAuth) {
          const firebaseClusters = await window.FirebaseAuth.getClusters();
          const clustersData = firebaseClusters || [];
          console.log('✅ Clusters carregados do Firebase:', clustersData.length);
          return clustersData;
        } else {
          console.error('❌ FirebaseAuth não está disponível');
          // Fallback para localStorage
          return JSON.parse(localStorage.getItem('clustersCadastrados') || '[]');
        }
      } catch (error) {
        console.error('❌ Erro ao carregar clusters do Firebase:', error);
        // Fallback para localStorage
        return JSON.parse(localStorage.getItem('clustersCadastrados') || '[]');
      }
    }
    
    // Função para carregar categorias do Firebase
    async function loadCategoriasFromFirebase() {
      try {
        console.log('🔄 Carregando categorias do Firebase...');
        
        if (window.FirebaseAuth) {
          const firebaseCategorias = await window.FirebaseAuth.getCategorias();
          const categoriasData = firebaseCategorias || [];
          console.log('✅ Categorias carregadas do Firebase:', categoriasData.length);
          return categoriasData;
        } else {
          console.error('❌ FirebaseAuth não está disponível');
          // Fallback para localStorage
          return JSON.parse(localStorage.getItem('categoriasCadastradas') || '[]');
        }
      } catch (error) {
        console.error('❌ Erro ao carregar categorias do Firebase:', error);
        // Fallback para localStorage
        return JSON.parse(localStorage.getItem('categoriasCadastradas') || '[]');
      }
    }
    
    // Função para atualizar informações do usuário
    async function updateUserInfo() {
      try {
        console.log('🔄 Atualizando informações do usuário...');
        
        const userInfoElement = document.getElementById('user-info');
        const userNameElement = document.getElementById('user-name');
        const userEmailElement = document.getElementById('user-email');
        const userPhotoElement = document.getElementById('user-photo');
        
        if (!userInfoElement || !userNameElement || !userEmailElement || !userPhotoElement) {
          console.error('❌ Elementos de usuário não encontrados');
          return;
        }
        
        let userDisplayName = '';
        let userEmail = '';
        let userPhotoURL = '';
        
        // Tentar obter informações do Firebase primeiro
        if (window.FirebaseAuth) {
          try {
            const currentUser = await window.FirebaseAuth.getCurrentUser();
            if (currentUser) {
              console.log('✅ Usuário encontrado no Firebase:', currentUser.email);
              userDisplayName = currentUser.displayName || currentUser.email;
              userEmail = currentUser.email;
              userPhotoURL = currentUser.photoURL || '';
            }
          } catch (firebaseError) {
            console.error('❌ Erro ao obter usuário do Firebase:', firebaseError);
          }
        }
        
        // Fallback para localStorage se Firebase não disponível
        if (!userDisplayName || !userEmail) {
          console.log('🔄 Usando dados do localStorage...');
          userDisplayName = localStorage.getItem('userDisplayName') || localStorage.getItem('currentUser') || 'Usuário';
          userEmail = localStorage.getItem('currentUser') || 'email@exemplo.com';
          userPhotoURL = localStorage.getItem('userPhotoURL') || '';
        }
        
        // Atualizar elementos
        userNameElement.textContent = userDisplayName;
        userEmailElement.textContent = userEmail;
        
        if (userPhotoURL) {
          userPhotoElement.src = userPhotoURL;
          userPhotoElement.style.display = 'block';
        } else {
          // Usar ícone padrão se não há foto
          userPhotoElement.style.display = 'none';
          userPhotoElement.parentElement.innerHTML = `
            <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary);">
              <span class="material-icons" style="color: white; font-size: 1rem;">person</span>
            </div>
          `;
        }
        
        // Mostrar informações do usuário
        userInfoElement.style.display = 'flex';
        console.log('✅ Informações do usuário atualizadas:', { userDisplayName, userEmail });
        
      } catch (error) {
        console.error('❌ Erro ao atualizar informações do usuário:', error);
      }
    }
    
    // Função para aguardar Firebase Auth carregar
    async function waitForFirebaseAuth() {
      let attempts = 0;
      const maxAttempts = 50; // 5 segundos
      
      while (!window.FirebaseAuth && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      
      if (window.FirebaseAuth) {
        console.log('✅ FirebaseAuth carregado');
        await loadFichasFromFirebase();
        await updateUserInfo(); // Atualizar informações do usuário
      } else {
        console.error('❌ FirebaseAuth não carregou após 5 segundos');
        // Fallback para localStorage
        fichas = JSON.parse(localStorage.getItem('fichas') || '[]');
        filteredFichas = [...fichas];
        await updateUserInfo(); // Atualizar informações do usuário mesmo sem Firebase
      }
    }

    // Menu mobile - removido event listener duplicado
    // O event listener correto está definido mais abaixo

    // Navegação lateral
    navItems.forEach(item => {
      item.onclick = function() {
        const screen = this.dataset.screen;
        switchScreen(screen);
        
        // Atualizar estado ativo
        navItems.forEach(nav => nav.classList.remove('active'));
        this.classList.add('active');
        
        // Fechar menu mobile
        sidebar.classList.remove('open');
      };
    });

    async function switchScreen(screen) {
      console.log('Mudando para tela:', screen);
      if (screen === 'list') {
        listSection.style.display = 'block';
        createSection.style.display = 'none';
        dashboardSection.style.display = 'none';
        configuracoesSection.style.display = 'none';
        // Remover seção de categorias se existir
        const existingCategoriasSection = document.getElementById('categorias-section');
        if (existingCategoriasSection) {
          existingCategoriasSection.remove();
        }
        // Remover seção de clusters se existir
        const existingClustersSection = document.getElementById('clusters-section');
        if (existingClustersSection) {
          existingClustersSection.remove();
        }
        pageTitle.textContent = 'Fichas Cadastradas';
        renderFichas();
        updateClusterFilter();
        updateCategoriaFilter();
      } else if (screen === 'create') {
        listSection.style.display = 'none';
        createSection.style.display = 'block';
        dashboardSection.style.display = 'none';
        configuracoesSection.style.display = 'none';
        // Remover seção de categorias se existir
        const existingCategoriasSection = document.getElementById('categorias-section');
        if (existingCategoriasSection) {
          existingCategoriasSection.remove();
        }
        // Remover seção de clusters se existir
        const existingClustersSection = document.getElementById('clusters-section');
        if (existingClustersSection) {
          existingClustersSection.remove();
        }
        pageTitle.textContent = 'Cadastrar Ficha';
        fichaForm.reset();
        updateClusterSelects();
        updateCategoriaSelects();
      } else if (screen === 'dashboard') {
        listSection.style.display = 'none';
        createSection.style.display = 'none';
        dashboardSection.style.display = 'block';
        configuracoesSection.style.display = 'none';
        // Remover seção de categorias se existir
        const existingCategoriasSection = document.getElementById('categorias-section');
        if (existingCategoriasSection) {
          existingCategoriasSection.remove();
        }
        // Remover seção de clusters se existir
        const existingClustersSection = document.getElementById('clusters-section');
        if (existingClustersSection) {
          existingClustersSection.remove();
        }
        pageTitle.textContent = 'Dashboard de Produção';
        renderDashboard();
      } else if (screen === 'categorias') {
        listSection.style.display = 'none';
        createSection.style.display = 'none';
        dashboardSection.style.display = 'none';
        configuracoesSection.style.display = 'none';
        // Remover seção de clusters se existir
        const existingClustersSection = document.getElementById('clusters-section');
        if (existingClustersSection) {
          existingClustersSection.remove();
        }
        pageTitle.textContent = 'Categorias';
        // Criar seção de categorias
        const categoriasSection = document.createElement('section');
        categoriasSection.id = 'categorias-section';
        categoriasSection.style.display = 'block';
        categoriasSection.innerHTML = `
          <h2 style="margin-bottom:1.5rem;">Categorias</h2>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow);">
              <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.2rem;">Adicionar Nova Categoria</h3>
              <form id="categoria-form">
                <div style="margin-bottom: 1.5rem;">
                  <label for="nova-categoria" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text);">Nome da Categoria</label>
                  <input type="text" id="nova-categoria" placeholder="Digite o nome da categoria" required style="width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg);" />
                </div>
                <button type="submit" style="background: var(--primary); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: var(--radius); font-weight: 600; cursor: pointer;">Adicionar Categoria</button>
              </form>
            </div>
            <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow);">
              <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.2rem;">Categorias Cadastradas</h3>
              <div id="lista-categorias" style="max-height: 300px; overflow-y: auto;">
                <p style="color: var(--muted); text-align: center; padding: 2rem;">Nenhuma categoria cadastrada</p>
              </div>
            </div>
          </div>
        `;
        
        // Limpar conteúdo anterior e adicionar nova seção
        const contentBody = document.querySelector('.content-body');
        const existingCategoriasSection = document.getElementById('categorias-section');
        if (existingCategoriasSection) {
          existingCategoriasSection.remove();
        }
        contentBody.appendChild(categoriasSection);
        
        // Adicionar funcionalidade para categorias
        const categoriaForm = document.getElementById('categoria-form');
        const novaCategoriaInput = document.getElementById('nova-categoria');
        const listaCategorias = document.getElementById('lista-categorias');
        
        async function renderCategorias() {
          try {
            console.log('🔄 Renderizando categorias...');
            
            // Carregar categorias do Firebase
            const categoriasCadastradas = await loadCategoriasFromFirebase();
            console.log('📊 Categorias carregadas:', categoriasCadastradas);
            
            if (categoriasCadastradas.length === 0) {
              listaCategorias.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">Nenhuma categoria cadastrada</p>';
              return;
            }
            
            listaCategorias.innerHTML = '';
            categoriasCadastradas.forEach((cat, idx) => {
              const div = document.createElement('div');
              div.style.display = 'flex';
              div.style.justifyContent = 'space-between';
              div.style.alignItems = 'center';
              div.style.padding = '0.8rem';
              div.style.marginBottom = '0.5rem';
              div.style.backgroundColor = 'var(--bg)';
              div.style.borderRadius = '8px';
              div.style.border = '1px solid var(--border)';
              div.innerHTML = `
                <span style="font-weight: 500; color: var(--text);">${cat}</span>
                <button onclick="removerCategoria('${cat}')" style="background: #e53935; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Remover</button>
              `;
              listaCategorias.appendChild(div);
            });
            
            console.log('✅ Categorias renderizadas com sucesso');
          } catch (error) {
            console.error('❌ Erro ao renderizar categorias:', error);
            listaCategorias.innerHTML = '<p style="color: var(--error); text-align: center; padding: 2rem;">Erro ao carregar categorias</p>';
          }
        }
        
        window.removerCategoria = function(idx) {
          if (confirm('Deseja realmente remover esta categoria?')) {
            categoriasCadastradas.splice(idx, 1);
            localStorage.setItem('categoriasCadastradas', JSON.stringify(categoriasCadastradas));
            renderCategorias();
            updateCategoriaSelects();
          }
        };
        
        if (categoriaForm) {
          categoriaForm.onsubmit = async function(e) {
            e.preventDefault();
            const novaCategoria = novaCategoriaInput.value.trim();
            
            if (!novaCategoria) {
              alert('Por favor, digite o nome da categoria');
              return;
            }
            
            try {
              console.log('🔄 Salvando categoria no Firebase...');
              
              if (window.FirebaseAuth) {
                // Carregar categorias existentes do Firebase
                const categoriasExistentes = await loadCategoriasFromFirebase();
                
                if (categoriasExistentes.includes(novaCategoria)) {
                  alert('Esta categoria já existe!');
                  return;
                }
                
                // Adicionar nova categoria
                const novasCategorias = [...categoriasExistentes, novaCategoria];
                await window.FirebaseAuth.saveCategorias(novasCategorias);
                
                console.log('✅ Categoria salva no Firebase');
                novaCategoriaInput.value = '';
                
                // Recarregar e renderizar
                await loadCategoriasFromFirebase();
                renderCategorias();
                await updateCategoriaSelects();
                await updateCategoriaFilter();
              } else {
                console.error('❌ FirebaseAuth não está disponível');
                // Fallback para localStorage
                if (!categoriasCadastradas.includes(novaCategoria)) {
                  categoriasCadastradas.push(novaCategoria);
                  localStorage.setItem('categoriasCadastradas', JSON.stringify(categoriasCadastradas));
                  novaCategoriaInput.value = '';
                  renderCategorias();
                  updateCategoriaSelects();
                } else {
                  alert('Esta categoria já existe!');
                }
              }
            } catch (error) {
              console.error('❌ Erro ao salvar categoria no Firebase:', error);
              // Fallback para localStorage
              if (!categoriasCadastradas.includes(novaCategoria)) {
                categoriasCadastradas.push(novaCategoria);
                localStorage.setItem('categoriasCadastradas', JSON.stringify(categoriasCadastradas));
                novaCategoriaInput.value = '';
                renderCategorias();
                updateCategoriaSelects();
              } else {
                alert('Esta categoria já existe!');
              }
            }
          };
        }
        
        renderCategorias();
      } else if (screen === 'clusters') {
        listSection.style.display = 'none';
        createSection.style.display = 'none';
        dashboardSection.style.display = 'none';
        configuracoesSection.style.display = 'none';
        // Remover seção de categorias se existir
        const existingCategoriasSection = document.getElementById('categorias-section');
        if (existingCategoriasSection) {
          existingCategoriasSection.remove();
        }
        pageTitle.textContent = 'Gestão de Clusters';
        // Criar seção de clusters
        const clustersSection = document.createElement('section');
        clustersSection.id = 'clusters-section';
        clustersSection.style.display = 'block';
        clustersSection.innerHTML = `
          <h2 style="margin-bottom:1.5rem;">Gestão de Clusters</h2>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
              <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.25rem; font-weight: 600; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.75rem;">
                <span class="material-icons" style="color: var(--primary); font-size: 1.5rem;">add_business</span>
                Adicionar Novo Cluster
              </h3>
              <form id="cluster-form">
                <div style="margin-bottom: 1.5rem;">
                  <label for="novo-cluster" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-family: 'Inter', sans-serif;">Nome do Cluster</label>
                  <input type="text" id="novo-cluster" placeholder="Digite o nome do cluster" required style="width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); font-family: 'Inter', sans-serif; color: var(--text); transition: all var(--transition);" />
                </div>
                <button type="submit" style="background: var(--primary); color: white; border: none; padding: 0.875rem 1.75rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: 'Inter', sans-serif; box-shadow: var(--shadow);">Adicionar Cluster</button>
              </form>
            </div>
            <div style="background: var(--surface); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border);">
              <h3 style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.25rem; font-weight: 600; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.75rem;">
                <span class="material-icons" style="color: var(--primary); font-size: 1.5rem;">business</span>
                Clusters Cadastrados
              </h3>
              <div id="lista-clusters" style="max-height: 300px; overflow-y: auto;">
                <p style="color: var(--muted); text-align: center; padding: 2rem;">Nenhum cluster cadastrado</p>
              </div>
            </div>
          </div>
        `;
        
        // Limpar conteúdo anterior e adicionar nova seção
        const contentBody = document.querySelector('.content-body');
        const existingClustersSection = document.getElementById('clusters-section');
        if (existingClustersSection) {
          existingClustersSection.remove();
        }
        contentBody.appendChild(clustersSection);
        
        // Adicionar funcionalidade para clusters
        const clusterForm = document.getElementById('cluster-form');
        const novoClusterInput = document.getElementById('novo-cluster');
        const listaClusters = document.getElementById('lista-clusters');
        
        console.log('🔍 Elementos de clusters encontrados:', {
          clusterForm: !!clusterForm,
          novoClusterInput: !!novoClusterInput,
          listaClusters: !!listaClusters
        });
        
        async function renderClusters() {
          try {
            console.log('🔄 Renderizando clusters...');
            
            // Verificar se o elemento listaClusters existe
            if (!listaClusters) {
              console.error('❌ Elemento listaClusters não encontrado');
              return;
            }
            
            // Carregar clusters do Firebase
            const clustersCadastrados = await loadClustersFromFirebase();
            console.log('📊 Clusters carregados:', clustersCadastrados);
            
            if (clustersCadastrados.length === 0) {
              console.log('ℹ️ Nenhum cluster encontrado, exibindo mensagem');
              listaClusters.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">Nenhum cluster cadastrado</p>';
              return;
            }
            
            listaClusters.innerHTML = '';
            clustersCadastrados.forEach((cluster, idx) => {
              const div = document.createElement('div');
              div.style.display = 'flex';
              div.style.justifyContent = 'space-between';
              div.style.alignItems = 'center';
              div.style.padding = '0.8rem';
              div.style.marginBottom = '0.5rem';
              div.style.backgroundColor = 'var(--bg-secondary)';
              div.style.borderRadius = '8px';
              div.style.border = '1px solid var(--border)';
              div.innerHTML = `
                <span style="font-weight: 500; color: var(--text);">${cluster}</span>
                <div style="display: flex; gap: 0.5rem;">
                  <button onclick="editarCluster('${cluster}')" style="background: var(--primary); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Editar</button>
                  <button onclick="removerCluster('${cluster}')" style="background: var(--error); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Remover</button>
                </div>
              `;
              listaClusters.appendChild(div);
            });
            
            console.log('✅ Clusters renderizados com sucesso');
          } catch (error) {
            console.error('❌ Erro ao renderizar clusters:', error);
            listaClusters.innerHTML = '<p style="color: var(--error); text-align: center; padding: 2rem;">Erro ao carregar clusters</p>';
          }
        }
        
        window.removerCluster = function(idx) {
          if (confirm('Deseja realmente remover este cluster?')) {
            clustersCadastrados.splice(idx, 1);
            localStorage.setItem('clustersCadastrados', JSON.stringify(clustersCadastrados));
            renderClusters();
            updateClusterSelects();
            updateClusterFilter();
          }
        };
        
        window.editarCluster = function(idx) {
          const clusterAtual = clustersCadastrados[idx];
          const novoNome = prompt('Digite o novo nome do cluster:', clusterAtual);
          
          if (novoNome && novoNome.trim() !== '') {
            const nomeLimpo = novoNome.trim();
            
            // Verificar se o novo nome já existe (exceto o próprio)
            const existeOutro = clustersCadastrados.some((cluster, index) => 
              index !== idx && cluster.toLowerCase() === nomeLimpo.toLowerCase()
            );
            
            if (existeOutro) {
              alert('Já existe um cluster com este nome!');
              return;
            }
            
            // Atualizar o cluster
            clustersCadastrados[idx] = nomeLimpo;
            localStorage.setItem('clustersCadastrados', JSON.stringify(clustersCadastrados));
            renderClusters();
            updateClusterSelects();
            updateClusterFilter();
          }
        };
        
        if (clusterForm) {
          clusterForm.onsubmit = async function(e) {
            e.preventDefault();
            const novoCluster = novoClusterInput.value.trim();
            
            if (!novoCluster) {
              alert('Por favor, digite o nome do cluster');
              return;
            }
            
            try {
              console.log('🔄 Salvando cluster no Firebase...');
              
              if (window.FirebaseAuth) {
                // Carregar clusters existentes do Firebase
                const clustersExistentes = await loadClustersFromFirebase();
                
                if (clustersExistentes.includes(novoCluster)) {
                  alert('Este cluster já existe!');
                  return;
                }
                
                // Adicionar novo cluster
                const novosClusters = [...clustersExistentes, novoCluster];
                await window.FirebaseAuth.saveClusters(novosClusters);
                
                console.log('✅ Cluster salvo no Firebase');
                novoClusterInput.value = '';
                
                // Recarregar e renderizar
                await loadClustersFromFirebase();
                renderClusters();
                await updateClusterSelects();
                await updateClusterFilter();
              } else {
                console.error('❌ FirebaseAuth não está disponível');
                // Fallback para localStorage
                if (!clustersCadastrados.includes(novoCluster)) {
                  clustersCadastrados.push(novoCluster);
                  localStorage.setItem('clustersCadastrados', JSON.stringify(clustersCadastrados));
                  novoClusterInput.value = '';
                  renderClusters();
                  updateClusterSelects();
                  updateClusterFilter();
                } else {
                  alert('Este cluster já existe!');
                }
              }
            } catch (error) {
              console.error('❌ Erro ao salvar cluster no Firebase:', error);
              // Fallback para localStorage
              if (!clustersCadastrados.includes(novoCluster)) {
                clustersCadastrados.push(novoCluster);
                localStorage.setItem('clustersCadastrados', JSON.stringify(clustersCadastrados));
                novoClusterInput.value = '';
                renderClusters();
                updateClusterSelects();
                updateClusterFilter();
              } else {
                alert('Este cluster já existe!');
              }
            }
          };
        }
        
        console.log('🔄 Chamando renderClusters...');
        await renderClusters();
        console.log('✅ renderClusters concluído');
      } else if (screen === 'configuracoes') {
        listSection.style.display = 'none';
        createSection.style.display = 'none';
        dashboardSection.style.display = 'none';
        configuracoesSection.style.display = 'block';
        // Remover seção de categorias se existir
        const existingCategoriasSection = document.getElementById('categorias-section');
        if (existingCategoriasSection) {
          existingCategoriasSection.remove();
        }
        // Remover seção de clusters se existir
        const existingClustersSection = document.getElementById('clusters-section');
        if (existingClustersSection) {
          existingClustersSection.remove();
        }
        pageTitle.textContent = 'Configurações do Sistema';
        // Preencher formulário de configurações
        configForm.reset();
        // Carregar configurações existentes
        const config = JSON.parse(localStorage.getItem('config') || '{}');
        document.getElementById('empresa-nome').value = config.empresaNome || '';
        document.getElementById('empresa-cnpj').value = config.empresaCnpj || '';
        document.getElementById('empresa-endereco').value = config.empresaEndereco || '';
        document.getElementById('empresa-telefone').value = config.empresaTelefone || '';
        // Atualizar informações do sistema
        atualizarInformacoesSistema();
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Função de edição
    window.editFicha = function(idx) {
      const ficha = filteredFichas[idx];
      editingIndex = fichas.indexOf(ficha);
      
      // Limpar container de cores
      const editCoresContainer = document.getElementById('edit-cores-container');
      editCoresContainer.innerHTML = '';
      editCoresArray = [];
      editCorCounter = 0;
      
      // Preencher formulário de edição
      document.getElementById('edit-cluster').value = ficha.cluster;
      document.getElementById('edit-categoria').value = ficha.categoria;
      document.getElementById('edit-referencia').value = ficha.referencia;
      document.getElementById('edit-quantidade').value = ficha.quantidade;
      document.getElementById('edit-valorUnitario').value = ficha.valorUnitario;
      document.getElementById('edit-valorTotal').value = ficha.valorTotal;
      document.getElementById('edit-pilotagem').value = ficha.pilotagem;
      document.getElementById('edit-saida').value = ficha.saida;
      document.getElementById('edit-pagamento').value = ficha.pagamento;
      document.getElementById('edit-entrada').value = ficha.entrada;
      document.getElementById('edit-observacoes').value = ficha.observacoes || '';
      
      // Carregar cores existentes se houver
      if (ficha.cores && Array.isArray(ficha.cores)) {
        ficha.cores.forEach(cor => {
          const corId = `edit-cor-${editCorCounter++}`;
          const corItem = document.createElement('div');
          corItem.className = 'cor-item';
          corItem.id = corId;
          corItem.style.cssText = `
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
          `;
          
          corItem.innerHTML = `
            <div class="cor-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <span class="cor-nome" style="font-weight: 600; color: var(--text); font-size: 1rem;">${cor.nome}</span>
              <button type="button" class="remove-cor-btn" onclick="removerCorEdit('${corId}')" style="background: var(--error); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
                <span class="material-icons" style="font-size: 1rem;">delete</span>
                Remover
              </button>
            </div>
            <div class="tamanhos-grid">
              <div class="tamanho-item">
                <label>PP / 36</label>
                <input type="number" min="0" value="${cor.pp || 0}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>P / 38</label>
                <input type="number" min="0" value="${cor.p || 0}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>M / 40</label>
                <input type="number" min="0" value="${cor.m || 0}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>G / 42</label>
                <input type="number" min="0" value="${cor.g || 0}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>GG / 44</label>
                <input type="number" min="0" value="${cor.gg || 0}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
            </div>
          `;
          
          editCoresContainer.appendChild(corItem);
          editCoresArray.push({ id: corId, nome: cor.nome });
        });
      } else {
        // Fallback para dados antigos (compatibilidade)
        const coresData = [
          { nome: 'Cor Principal', pp: ficha.pp || 0, p: ficha.p || 0, m: ficha.m || 0, g: ficha.g || 0, gg: ficha.gg || 0 }
        ];
        
        coresData.forEach(cor => {
          const corId = `edit-cor-${editCorCounter++}`;
          const corItem = document.createElement('div');
          corItem.className = 'cor-item';
          corItem.id = corId;
          corItem.style.cssText = `
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
          `;
          
          corItem.innerHTML = `
            <div class="cor-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <span class="cor-nome" style="font-weight: 600; color: var(--text); font-size: 1rem;">${cor.nome}</span>
              <button type="button" class="remove-cor-btn" onclick="removerCorEdit('${corId}')" style="background: var(--error); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
                <span class="material-icons" style="font-size: 1rem;">delete</span>
                Remover
              </button>
            </div>
            <div class="tamanhos-grid">
              <div class="tamanho-item">
                <label>PP / 36</label>
                <input type="number" min="0" value="${cor.pp}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>P / 38</label>
                <input type="number" min="0" value="${cor.p}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>M / 40</label>
                <input type="number" min="0" value="${cor.m}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>G / 42</label>
                <input type="number" min="0" value="${cor.g}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
              <div class="tamanho-item">
                <label>GG / 44</label>
                <input type="number" min="0" value="${cor.gg}" onchange="atualizarQuantidadeTotalEdit()" />
              </div>
            </div>
          `;
          
          editCoresContainer.appendChild(corItem);
          editCoresArray.push({ id: corId, nome: cor.nome });
        });
      }
      
      editModal.style.display = 'flex';
    };

    function closeEditModal() {
      editModal.style.display = 'none';
      editingIndex = -1;
    }

    // Função para mostrar detalhes da ficha
    function showFichaDetails(idx) {
      const ficha = filteredFichas[idx];
      const detailsModal = document.getElementById('details-modal');
      const detailsContent = document.getElementById('ficha-details-content');
      
      if (!ficha) {
        console.error('Ficha não encontrada');
        return;
      }
      
      // Armazenar ficha atual para exportação
      window.currentFichaDetails = ficha;
      
      // Formatar datas
      const formatarData = (dataString) => {
        if (!dataString) return '-';
        const data = new Date(dataString);
        return data.toLocaleDateString('pt-BR');
      };
      
      // Formatar valor monetário
      const formatarValor = (valor) => {
        return `R$ ${Number(valor).toFixed(2)}`;
      };
      
      // Gerar HTML dos detalhes
      const detailsHTML = `
        <div style="display: grid; gap: 1.5rem;">
          <!-- Informações Básicas -->
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--primary); font-size: 1.2rem;">info</span>
              Informações Básicas
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Cluster:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${ficha.cluster}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Categoria:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${ficha.categoria}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Referência:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${ficha.referencia}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Quantidade:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${ficha.quantidade} peças</p>
              </div>
            </div>
          </div>

          <!-- Informações Financeiras -->
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--success); font-size: 1.2rem;">payments</span>
              Informações Financeiras
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Valor Unitário:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarValor(ficha.valorUnitario)}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Valor Total:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarValor(ficha.valorTotal)}</p>
              </div>
            </div>
          </div>

          <!-- Datas e Prazos -->
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--warning); font-size: 1.2rem;">schedule</span>
              Datas e Prazos
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Data de Entrada:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarData(ficha.entrada)}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Data de Saída:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarData(ficha.saida)}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Data de Pagamento:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarData(ficha.pagamento)}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Pilotagem:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarData(ficha.pilotagem)}</p>
              </div>
            </div>
          </div>

          <!-- Tamanhos e Cores -->
          ${ficha.cores && ficha.cores.length > 0 ? `
            <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
              <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-icons" style="color: var(--primary); font-size: 1.2rem;">palette</span>
                Cores e Tamanhos
              </h4>
              <div style="display: grid; gap: 1rem;">
                ${ficha.cores.map(cor => `
                  <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                    <h5 style="margin: 0 0 0.5rem 0; color: var(--text); font-size: 1rem; font-weight: 600;">${cor.nome}</h5>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem;">
                      <div style="text-align: center;">
                        <strong style="color: var(--text-secondary); font-size: 0.8rem;">PP/36</strong>
                        <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${cor.pp || 0}</p>
                      </div>
                      <div style="text-align: center;">
                        <strong style="color: var(--text-secondary); font-size: 0.8rem;">P/38</strong>
                        <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${cor.p || 0}</p>
                      </div>
                      <div style="text-align: center;">
                        <strong style="color: var(--text-secondary); font-size: 0.8rem;">M/40</strong>
                        <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${cor.m || 0}</p>
                      </div>
                      <div style="text-align: center;">
                        <strong style="color: var(--text-secondary); font-size: 0.8rem;">G/42</strong>
                        <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${cor.g || 0}</p>
                      </div>
                      <div style="text-align: center;">
                        <strong style="color: var(--text-secondary); font-size: 0.8rem;">GG/44</strong>
                        <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${cor.gg || 0}</p>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <!-- Observações -->
          ${ficha.observacoes ? `
            <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
              <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-icons" style="color: var(--text-secondary); font-size: 1.2rem;">note</span>
                Observações
              </h4>
              <p style="margin: 0; color: var(--text); line-height: 1.6;">${ficha.observacoes}</p>
            </div>
          ` : ''}
        </div>
      `;
      
      detailsContent.innerHTML = detailsHTML;
      detailsModal.style.display = 'flex';
    }

    // Função para fechar modal de detalhes
    function closeDetailsModal() {
      const detailsModal = document.getElementById('details-modal');
      detailsModal.style.display = 'none';
    }

    // Função para mostrar relatório do dashboard
    function showDashboardReport() {
      const reportModal = document.getElementById('report-modal');
      const reportContent = document.getElementById('report-content');
      
      // Obter dados filtrados atuais
      const dataToUse = dashboardFilteredFichas.length > 0 && (currentClusterFilter || currentPeriodFilter) ? dashboardFilteredFichas : fichas;
      
      // Obter filtros ativos
      const clusterFilter = document.getElementById('dashboard-cluster-filter').value;
      const periodFilter = document.getElementById('dashboard-period-filter').value;
      
      // Formatar datas
      const formatarData = (dataString) => {
        if (!dataString) return '-';
        const data = new Date(dataString);
        return data.toLocaleDateString('pt-BR');
      };
      
      // Formatar valor monetário
      const formatarValor = (valor) => {
        return `R$ ${Number(valor).toFixed(2)}`;
      };
      
      // Calcular estatísticas
      const totalPecas = dataToUse.reduce((sum, f) => sum + f.quantidade, 0);
      const totalValor = dataToUse.reduce((sum, f) => sum + f.valorTotal, 0);
      const mediaValor = dataToUse.length > 0 ? totalValor / dataToUse.length : 0;
      const mediaPecas = dataToUse.length > 0 ? totalPecas / dataToUse.length : 0;
      const clustersUnicos = [...new Set(dataToUse.map(f => f.cluster))];
      const categoriasUnicas = [...new Set(dataToUse.map(f => f.categoria))];
      
      // Calcular estatísticas por cluster
      const statsPorCluster = {};
      dataToUse.forEach(f => {
        if (!statsPorCluster[f.cluster]) {
          statsPorCluster[f.cluster] = { fichas: 0, pecas: 0, valor: 0 };
        }
        statsPorCluster[f.cluster].fichas++;
        statsPorCluster[f.cluster].pecas += f.quantidade;
        statsPorCluster[f.cluster].valor += f.valorTotal;
      });
      
      // Calcular estatísticas por categoria
      const statsPorCategoria = {};
      dataToUse.forEach(f => {
        if (!statsPorCategoria[f.categoria]) {
          statsPorCategoria[f.categoria] = { fichas: 0, pecas: 0, valor: 0 };
        }
        statsPorCategoria[f.categoria].fichas++;
        statsPorCategoria[f.categoria].pecas += f.quantidade;
        statsPorCategoria[f.categoria].valor += f.valorTotal;
      });
      
      // Gerar HTML do relatório
      const reportHTML = `
        <div style="display: grid; gap: 2rem;">
          <!-- Cabeçalho do Relatório -->
          <div style="background: var(--primary-50); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--primary-200);">
            <h4 style="margin: 0 0 1rem 0; color: var(--primary-dark); font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--primary); font-size: 1.3rem;">assessment</span>
              Filtros Aplicados
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Cluster:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${clusterFilter || 'Todos'}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Período:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${periodFilter ? `${periodFilter} dias` : 'Todos'}</p>
              </div>
              <div>
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Fichas Analisadas:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${dataToUse.length}</p>
              </div>
            </div>
          </div>

          <!-- Resumo Executivo -->
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--success); font-size: 1.3rem;">trending_up</span>
              Resumo Executivo
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
              <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Total de Peças:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 600; font-size: 1.1rem;">${totalPecas.toLocaleString('pt-BR')}</p>
              </div>
              <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Valor Total:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 600; font-size: 1.1rem;">${formatarValor(totalValor)}</p>
              </div>
              <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Valor Médio por Ficha:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 600; font-size: 1.1rem;">${formatarValor(mediaValor)}</p>
              </div>
              <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                <strong style="color: var(--text-secondary); font-size: 0.9rem;">Média de Peças por Ficha:</strong>
                <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 600; font-size: 1.1rem;">${Math.round(mediaPecas)}</p>
              </div>
            </div>
          </div>

          <!-- Análise por Cluster -->
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--primary); font-size: 1.3rem;">groups</span>
              Análise por Cluster
            </h4>
            <div style="display: grid; gap: 1rem;">
              ${Object.entries(statsPorCluster).map(([cluster, stats]) => `
                <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                  <h5 style="margin: 0 0 0.5rem 0; color: var(--text); font-size: 1rem; font-weight: 600;">${cluster}</h5>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div>
                      <strong style="color: var(--text-secondary); font-size: 0.8rem;">Fichas:</strong>
                      <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${stats.fichas}</p>
                    </div>
                    <div>
                      <strong style="color: var(--text-secondary); font-size: 0.8rem;">Peças:</strong>
                      <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${stats.pecas.toLocaleString('pt-BR')}</p>
                    </div>
                    <div>
                      <strong style="color: var(--text-secondary); font-size: 0.8rem;">Valor Total:</strong>
                      <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarValor(stats.valor)}</p>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Análise por Categoria -->
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--warning); font-size: 1.3rem;">category</span>
              Análise por Categoria
            </h4>
            <div style="display: grid; gap: 1rem;">
              ${Object.entries(statsPorCategoria).map(([categoria, stats]) => `
                <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                  <h5 style="margin: 0 0 0.5rem 0; color: var(--text); font-size: 1rem; font-weight: 600;">${categoria}</h5>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div>
                      <strong style="color: var(--text-secondary); font-size: 0.8rem;">Fichas:</strong>
                      <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${stats.fichas}</p>
                    </div>
                    <div>
                      <strong style="color: var(--text-secondary); font-size: 0.8rem;">Peças:</strong>
                      <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${stats.pecas.toLocaleString('pt-BR')}</p>
                    </div>
                    <div>
                      <strong style="color: var(--text-secondary); font-size: 0.8rem;">Valor Total:</strong>
                      <p style="margin: 0.25rem 0 0 0; color: var(--text); font-weight: 500;">${formatarValor(stats.valor)}</p>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Lista Detalhada de Fichas -->
          <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-icons" style="color: var(--text-secondary); font-size: 1.3rem;">list</span>
              Lista Detalhada de Fichas
            </h4>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
                  <tr style="background: var(--surface); border-bottom: 2px solid var(--border);">
                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text);">Cluster</th>
                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text);">Categoria</th>
                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text);">Referência</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: var(--text);">Quantidade</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: var(--text);">Valor Unit.</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: var(--text);">Valor Total</th>
                    <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: var(--text);">Saída</th>
                  </tr>
                </thead>
                <tbody>
                  ${dataToUse.map(ficha => `
                    <tr style="border-bottom: 1px solid var(--border);">
                      <td style="padding: 0.75rem; color: var(--text);">${ficha.cluster}</td>
                      <td style="padding: 0.75rem; color: var(--text);">${ficha.categoria}</td>
                      <td style="padding: 0.75rem; color: var(--text);">${ficha.referencia}</td>
                      <td style="padding: 0.75rem; text-align: right; color: var(--text);">${ficha.quantidade.toLocaleString('pt-BR')}</td>
                      <td style="padding: 0.75rem; text-align: right; color: var(--text);">${formatarValor(ficha.valorUnitario)}</td>
                      <td style="padding: 0.75rem; text-align: right; color: var(--text); font-weight: 600;">${formatarValor(ficha.valorTotal)}</td>
                      <td style="padding: 0.75rem; text-align: center; color: var(--text);">${formatarData(ficha.saida)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      reportContent.innerHTML = reportHTML;
      reportModal.style.display = 'flex';
    }

    // Função para fechar modal de relatório
    function closeReportModal() {
      const reportModal = document.getElementById('report-modal');
      reportModal.style.display = 'none';
    }

    // Função para exportar relatório para PDF
    function exportReportToPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Obter dados filtrados atuais
        const dataToUse = dashboardFilteredFichas.length > 0 && (currentClusterFilter || currentPeriodFilter) ? dashboardFilteredFichas : fichas;
        const clusterFilter = document.getElementById('dashboard-cluster-filter').value;
        const periodFilter = document.getElementById('dashboard-period-filter').value;
        
        // Calcular estatísticas
        const totalPecas = dataToUse.reduce((sum, f) => sum + f.quantidade, 0);
        const totalValor = dataToUse.reduce((sum, f) => sum + f.valorTotal, 0);
        const mediaValor = dataToUse.length > 0 ? totalValor / dataToUse.length : 0;
        const mediaPecas = dataToUse.length > 0 ? totalPecas / dataToUse.length : 0;
        
        // Configurar fonte
        doc.setFont('helvetica');
        doc.setFontSize(16);
        
        // Título
        doc.text('Relatório Detalhado - Dashboard de Produção', 20, 20);
        
        // Informações dos filtros
        doc.setFontSize(12);
        doc.text(`Filtros Aplicados:`, 20, 40);
        doc.setFontSize(10);
        doc.text(`Cluster: ${clusterFilter || 'Todos'}`, 30, 50);
        doc.text(`Período: ${periodFilter ? `${periodFilter} dias` : 'Todos'}`, 30, 60);
        doc.text(`Fichas Analisadas: ${dataToUse.length}`, 30, 70);
        
        // Resumo executivo
        doc.setFontSize(12);
        doc.text('Resumo Executivo:', 20, 90);
        doc.setFontSize(10);
        doc.text(`Total de Peças: ${totalPecas.toLocaleString('pt-BR')}`, 30, 100);
        doc.text(`Valor Total: R$ ${totalValor.toFixed(2)}`, 30, 110);
        doc.text(`Valor Médio por Ficha: R$ ${mediaValor.toFixed(2)}`, 30, 120);
        doc.text(`Média de Peças por Ficha: ${Math.round(mediaPecas)}`, 30, 130);
        
        // Tabela de fichas
        doc.setFontSize(12);
        doc.text('Lista Detalhada de Fichas:', 20, 160);
        
        const tableData = dataToUse.map(ficha => [
          ficha.cluster,
          ficha.categoria,
          ficha.referencia,
          ficha.quantidade.toString(),
          `R$ ${ficha.valorUnitario.toFixed(2)}`,
          `R$ ${ficha.valorTotal.toFixed(2)}`,
          ficha.saida ? new Date(ficha.saida).toLocaleDateString('pt-BR') : '-'
        ]);
        
        doc.autoTable({
          startY: 170,
          head: [['Cluster', 'Categoria', 'Referência', 'Quantidade', 'Valor Unit.', 'Valor Total', 'Saída']],
          body: tableData,
          theme: 'grid',
          headStyles: { fillColor: [37, 99, 235] },
          styles: { fontSize: 8 }
        });
        
        // Gerar nome do arquivo
        const timestamp = new Date().toISOString().slice(0, 10);
        const fileName = `relatorio_dashboard_${timestamp}.pdf`;
        
        // Salvar PDF
        doc.save(fileName);
        
        console.log('✅ Relatório exportado com sucesso');
      } catch (error) {
        console.error('❌ Erro ao exportar relatório:', error);
        alert('Erro ao exportar relatório. Verifique o console para mais detalhes.');
      }
    }

    // Função para exportar ficha para PDF
    function exportFichaToPDF() {
      try {
        // Obter dados da ficha atual (precisamos armazenar a ficha atual)
        const currentFicha = window.currentFichaDetails;
        
        if (!currentFicha) {
          alert('Nenhuma ficha selecionada para exportar.');
          return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Formatar datas
        const formatarData = (dataString) => {
          if (!dataString) return '-';
          const data = new Date(dataString);
          return data.toLocaleDateString('pt-BR');
        };
        
        // Formatar valor monetário
        const formatarValor = (valor) => {
          return `R$ ${Number(valor).toFixed(2)}`;
        };
        
        // Configurar fonte
        doc.setFont('helvetica');
        doc.setFontSize(16);
        
        // Título
        doc.text('Detalhes da Ficha', 20, 20);
        
        // Informações básicas
        doc.setFontSize(12);
        doc.text('Informações Básicas:', 20, 40);
        doc.setFontSize(10);
        doc.text(`Cluster: ${currentFicha.cluster}`, 30, 50);
        doc.text(`Categoria: ${currentFicha.categoria}`, 30, 60);
        doc.text(`Referência: ${currentFicha.referencia}`, 30, 70);
        doc.text(`Quantidade: ${currentFicha.quantidade} peças`, 30, 80);
        
        // Informações financeiras
        doc.setFontSize(12);
        doc.text('Informações Financeiras:', 20, 100);
        doc.setFontSize(10);
        doc.text(`Valor Unitário: ${formatarValor(currentFicha.valorUnitario)}`, 30, 110);
        doc.text(`Valor Total: ${formatarValor(currentFicha.valorTotal)}`, 30, 120);
        
        // Datas e prazos
        doc.setFontSize(12);
        doc.text('Datas e Prazos:', 20, 140);
        doc.setFontSize(10);
        doc.text(`Data de Entrada: ${formatarData(currentFicha.entrada)}`, 30, 150);
        doc.text(`Data de Saída: ${formatarData(currentFicha.saida)}`, 30, 160);
        doc.text(`Data de Pagamento: ${formatarData(currentFicha.pagamento)}`, 30, 170);
        doc.text(`Pilotagem: ${formatarData(currentFicha.pilotagem)}`, 30, 180);
        
        // Cores e tamanhos (se houver)
        if (currentFicha.cores && currentFicha.cores.length > 0) {
          doc.setFontSize(12);
          doc.text('Cores e Tamanhos:', 20, 200);
          doc.setFontSize(10);
          
          let yPosition = 210;
          currentFicha.cores.forEach((cor, index) => {
            if (yPosition > 250) {
              doc.addPage();
              yPosition = 20;
            }
            
            doc.text(`${cor.nome}:`, 30, yPosition);
            yPosition += 10;
            doc.text(`PP/36: ${cor.pp || 0}`, 40, yPosition);
            yPosition += 5;
            doc.text(`P/38: ${cor.p || 0}`, 40, yPosition);
            yPosition += 5;
            doc.text(`M/40: ${cor.m || 0}`, 40, yPosition);
            yPosition += 5;
            doc.text(`G/42: ${cor.g || 0}`, 40, yPosition);
            yPosition += 5;
            doc.text(`GG/44: ${cor.gg || 0}`, 40, yPosition);
            yPosition += 10;
          });
        }
        
        // Observações (se houver)
        if (currentFicha.observacoes) {
          doc.setFontSize(12);
          doc.text('Observações:', 20, doc.lastAutoTable.finalY + 20);
          doc.setFontSize(10);
          doc.text(currentFicha.observacoes, 30, doc.lastAutoTable.finalY + 30);
        }
        
        // Gerar nome do arquivo
        const timestamp = new Date().toISOString().slice(0, 10);
        const fileName = `ficha_${currentFicha.referencia}_${timestamp}.pdf`;
        
        // Salvar PDF
        doc.save(fileName);
        
        console.log('✅ Ficha exportada com sucesso');
      } catch (error) {
        console.error('❌ Erro ao exportar ficha:', error);
        alert('Erro ao exportar ficha. Verifique o console para mais detalhes.');
      }
    }

    function calcularValorTotalEdit() {
      const quantidade = Number(document.getElementById('edit-quantidade').value) || 0;
      const valorUnitario = Number(document.getElementById('edit-valorUnitario').value) || 0;
      const valorTotal = quantidade * valorUnitario;
      document.getElementById('edit-valorTotal').value = valorTotal.toFixed(2);
    }

    editForm.onsubmit = function(e) {
      e.preventDefault();
      
      // Coletar dados das cores dinamicamente
      const coresData = [];
      const coresItems = document.querySelectorAll('#edit-cores-container .cor-item');
      
      coresItems.forEach(corItem => {
        const nomeCor = corItem.querySelector('.cor-nome').textContent;
        const inputs = corItem.querySelectorAll('input[type="number"]');
        const pp = parseInt(inputs[0].value) || 0;
        const p = parseInt(inputs[1].value) || 0;
        const m = parseInt(inputs[2].value) || 0;
        const g = parseInt(inputs[3].value) || 0;
        const gg = parseInt(inputs[4].value) || 0;
        
        coresData.push({
          id: Date.now() + Math.random(),
          nome: nomeCor,
          pp: pp,
          p: p,
          m: m,
          g: g,
          gg: gg
        });
      });
      
      // Calcular totais das cores
      const totalPp = coresData.reduce((sum, cor) => sum + cor.pp, 0);
      const totalP = coresData.reduce((sum, cor) => sum + cor.p, 0);
      const totalM = coresData.reduce((sum, cor) => sum + cor.m, 0);
      const totalG = coresData.reduce((sum, cor) => sum + cor.g, 0);
      const totalGg = coresData.reduce((sum, cor) => sum + cor.gg, 0);
      const totalQuantidade = totalPp + totalP + totalM + totalG + totalGg;
      
      const fichaEditada = {
        cluster: document.getElementById('edit-cluster').value.trim(),
        categoria: document.getElementById('edit-categoria').value.trim(),
        referencia: document.getElementById('edit-referencia').value.trim(),
        quantidade: totalQuantidade,
        valorUnitario: Number(document.getElementById('edit-valorUnitario').value),
        valorTotal: Number(document.getElementById('edit-valorUnitario').value) * totalQuantidade,
        pilotagem: document.getElementById('edit-pilotagem').value,
        saida: document.getElementById('edit-saida').value,
        pagamento: document.getElementById('edit-pagamento').value || '',
        entrada: document.getElementById('edit-entrada').value || '',
        observacoes: document.getElementById('edit-observacoes').value.trim(),
        // Dados das cores
        cores: coresData,
        // Totais para compatibilidade
        pp: totalPp,
        p: totalP,
        m: totalM,
        g: totalG,
        gg: totalGg
      };
      
      fichas[editingIndex] = fichaEditada;
      localStorage.setItem('fichas', JSON.stringify(fichas));
      filteredFichas = [...fichas];
      
      closeEditModal();
      renderFichas();
      updateClusterFilter();
      updateCategoriaFilter();
      updatePagamentoFilter();
      updateClusterSelects();
      updateCategoriaSelects();
    };

    // Sistema de cores dinâmicas
    let coresArray = [];
    let corCounter = 0;
    
    function adicionarCor() {
      const coresContainer = document.getElementById('cores-container');
      const novaCorInput = document.getElementById('nova-cor-input');
      const nomeCor = novaCorInput.value.trim();
      
      if (!nomeCor) {
        alert('Por favor, digite o nome da cor/estampa');
        novaCorInput.focus();
        return;
      }
      
      const corId = `cor-${corCounter}`;
      
      const corItem = document.createElement('div');
      corItem.className = 'cor-item';
      corItem.innerHTML = `
        <div class="cor-header">
          <div class="cor-nome">${nomeCor}</div>
          <button type="button" class="remove-cor-btn" onclick="removerCor('${corId}')">
            <span class="material-icons" style="font-size: 0.8rem;">delete</span>
            Remover
          </button>
        </div>
        <div class="tamanhos-grid">
          <div class="tamanho-item">
            <label>PP / 36</label>
            <input type="number" id="${corId}-pp" min="0" value="0" onchange="atualizarQuantidadeTotal()" />
          </div>
          <div class="tamanho-item">
            <label>P / 38</label>
            <input type="number" id="${corId}-p" min="0" value="0" onchange="atualizarQuantidadeTotal()" />
          </div>
          <div class="tamanho-item">
            <label>M / 40</label>
            <input type="number" id="${corId}-m" min="0" value="0" onchange="atualizarQuantidadeTotal()" />
          </div>
          <div class="tamanho-item">
            <label>G / 42</label>
            <input type="number" id="${corId}-g" min="0" value="0" onchange="atualizarQuantidadeTotal()" />
          </div>
          <div class="tamanho-item">
            <label>GG / 44</label>
            <input type="number" id="${corId}-gg" min="0" value="0" onchange="atualizarQuantidadeTotal()" />
          </div>
        </div>
      `;
      
      coresContainer.appendChild(corItem);
      coresArray.push(corId);
      corCounter++;
      
      // Limpar o campo de input
      novaCorInput.value = '';
      novaCorInput.focus();
    }
    
    function removerCor(corId) {
      const corItem = document.querySelector(`[id="${corId}-pp"]`).closest('.cor-item');
      corItem.remove();
      coresArray = coresArray.filter(id => id !== corId);
      atualizarQuantidadeTotal();
    }
    
    function atualizarQuantidadeTotal() {
      let total = 0;
      
      coresArray.forEach(corId => {
        const pp = Number(document.getElementById(`${corId}-pp`).value) || 0;
        const p = Number(document.getElementById(`${corId}-p`).value) || 0;
        const m = Number(document.getElementById(`${corId}-m`).value) || 0;
        const g = Number(document.getElementById(`${corId}-g`).value) || 0;
        const gg = Number(document.getElementById(`${corId}-gg`).value) || 0;
        total += pp + p + m + g + gg;
      });
      
      document.getElementById('quantidade').value = total;
      calcularValorTotal();
    }
    
    // Adicionar primeira cor automaticamente
    document.addEventListener('DOMContentLoaded', function() {
      const addCorBtn = document.getElementById('add-cor-btn');
      const novaCorInput = document.getElementById('nova-cor-input');
      
      if (addCorBtn) {
        addCorBtn.addEventListener('click', adicionarCor);
      }
      
      if (novaCorInput) {
        novaCorInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            adicionarCor();
          }
        });
      }
    });

    // Fechar modal ao clicar fora
    editModal.onclick = function(e) {
      if (e.target === editModal) {
        closeEditModal();
      }
    };

    // Fechar modal de detalhes ao clicar fora
    const detailsModal = document.getElementById('details-modal');
    if (detailsModal) {
      detailsModal.onclick = function(e) {
        if (e.target === detailsModal) {
          closeDetailsModal();
        }
      };
    }

    // Fechar modal de relatório ao clicar fora
    const reportModal = document.getElementById('report-modal');
    if (reportModal) {
      reportModal.onclick = function(e) {
        if (e.target === reportModal) {
          closeReportModal();
        }
      };
    }

    async function updateClusterFilter() {
      try {
        // Tentar carregar clusters do Firebase primeiro
        const clustersCadastrados = await loadClustersFromFirebase();
        clusterFilter.innerHTML = '<option value="">Todos os Clusters</option>';
        clustersCadastrados.forEach(cluster => {
          const option = document.createElement('option');
          option.value = cluster;
          option.textContent = cluster;
          clusterFilter.appendChild(option);
        });
      } catch (error) {
        // Fallback para clusters das fichas
        const clusters = [...new Set(fichas.map(f => f.cluster))];
        clusterFilter.innerHTML = '<option value="">Todos os Clusters</option>';
        clusters.forEach(cluster => {
          const option = document.createElement('option');
          option.value = cluster;
          option.textContent = cluster;
          clusterFilter.appendChild(option);
        });
      }
    }

    async function updateCategoriaFilter() {
      try {
        // Tentar carregar categorias do Firebase primeiro
        const categoriasCadastradas = await loadCategoriasFromFirebase();
        categoriaFilter.innerHTML = '<option value="">Todas as Categorias</option>';
        categoriasCadastradas.forEach(categoria => {
          const option = document.createElement('option');
          option.value = categoria;
          option.textContent = categoria;
          categoriaFilter.appendChild(option);
        });
      } catch (error) {
        // Fallback para categorias das fichas
        const categorias = [...new Set(fichas.map(f => f.categoria))];
        categoriaFilter.innerHTML = '<option value="">Todas as Categorias</option>';
        categorias.forEach(categoria => {
          const option = document.createElement('option');
          option.value = categoria;
          option.textContent = categoria;
          categoriaFilter.appendChild(option);
        });
      }
    }

    async function updateCategoriaSelects() {
      const categoriasCadastradas = await loadCategoriasFromFirebase();
      const categoriaSelect = document.getElementById('categoria');
      const editCategoriaSelect = document.getElementById('edit-categoria');
      
      // Atualizar select de cadastro
      if (categoriaSelect) {
        categoriaSelect.innerHTML = '<option value="">Selecione uma categoria</option>';
        categoriasCadastradas.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          categoriaSelect.appendChild(option);
        });
      }
      
      // Atualizar select de edição
      if (editCategoriaSelect) {
        editCategoriaSelect.innerHTML = '<option value="">Selecione uma categoria</option>';
        categoriasCadastradas.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          editCategoriaSelect.appendChild(option);
        });
      }
    }
    
    async function updateClusterSelects() {
      const clustersCadastrados = await loadClustersFromFirebase();
      const clusterSelect = document.getElementById('cluster');
      const editClusterSelect = document.getElementById('edit-cluster');
      
      // Atualizar select de cadastro
      if (clusterSelect) {
        clusterSelect.innerHTML = '<option value="">Selecione um cluster</option>';
        clustersCadastrados.forEach(cluster => {
          const option = document.createElement('option');
          option.value = cluster;
          option.textContent = cluster;
          clusterSelect.appendChild(option);
        });
      }
      
      // Atualizar select de edição
      if (editClusterSelect) {
        editClusterSelect.innerHTML = '<option value="">Selecione um cluster</option>';
        clustersCadastrados.forEach(cluster => {
          const option = document.createElement('option');
          option.value = cluster;
          option.textContent = cluster;
          editClusterSelect.appendChild(option);
        });
      }
    }

    clusterFilter.onchange = function() {
      aplicarFiltros();
    };

    categoriaFilter.onchange = function() {
      aplicarFiltros();
    };

    // Event listener para filtro de pagamentos
    document.getElementById('pagamento-filter').onchange = function() {
      aplicarFiltros();
    };

    function updatePagamentoFilter() {
      const pagamentoFilter = document.getElementById('pagamento-filter');
      if (pagamentoFilter) {
        // O filtro de pagamentos não precisa ser atualizado dinamicamente
        // pois as opções são fixas: Todos, Pago, Não Pago
        pagamentoFilter.value = '';
      }
    }

    function aplicarFiltros() {
      const selectedCluster = clusterFilter.value;
      const selectedCategoria = categoriaFilter.value;
      const selectedPagamento = document.getElementById('pagamento-filter').value;
      
      filteredFichas = fichas.filter(f => {
        const matchCluster = selectedCluster === '' || f.cluster === selectedCluster;
        const matchCategoria = selectedCategoria === '' || f.categoria === selectedCategoria;
        
        // Filtro de pagamento
        let matchPagamento = true;
        if (selectedPagamento === 'pago') {
          matchPagamento = f.pagamento && f.pagamento.trim() !== '';
        } else if (selectedPagamento === 'nao-pago') {
          matchPagamento = !f.pagamento || f.pagamento.trim() === '';
        }
        
        return matchCluster && matchCategoria && matchPagamento;
      });
      
      renderFichas();
    }

    function renderFichas() {
      console.log('Renderizando fichas...', filteredFichas.length);
      
      // Verificar se o elemento existe
      if (!fichasList) {
        console.error('Elemento fichasList não encontrado');
        return;
      }
      
      fichasList.innerHTML = '';
      if (filteredFichas.length === 0) {
        fichasList.innerHTML = `<tr><td colspan="10" style="color:var(--muted);padding:2rem;">Nenhuma ficha encontrada.</td></tr>`;
        return;
      }
      filteredFichas.forEach((ficha, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${ficha.cluster}</td>
          <td>${ficha.categoria}</td>
          <td>${ficha.referencia}</td>
          <td>${ficha.quantidade}</td>
          <td>R$ ${Number(ficha.valorUnitario).toFixed(2)}</td>
          <td>R$ ${Number(ficha.valorTotal).toFixed(2)}</td>
          <td>${ficha.pilotagem}</td>
          <td>${ficha.saida || '-'}</td>
          <td>${ficha.pagamento || '-'}</td>
          <td>
            <div class="action-buttons" style="display: flex; gap: 0.3rem; justify-content: center;">
              <button class="details-btn" title="Ver Detalhes" onclick="showFichaDetails(${idx})" style="background: var(--primary); color: white; border: none; padding: 0.5rem; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; min-width: 36px; height: 36px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                <span class="material-icons" style="font-size: 1rem;">visibility</span>
              </button>
              <button class="edit-btn" title="Editar" onclick="editFicha(${idx})" style="background: transparent; color: var(--warning); border: 1px solid var(--warning); padding: 0.4rem; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; min-width: 32px; height: 32px; transition: all 0.2s ease;" onmouseover="this.style.background='var(--warning)'; this.style.color='white'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='transparent'; this.style.color='var(--warning)'; this.style.transform='scale(1)'">
                <span class="material-icons" style="font-size: 0.875rem;">edit</span>
              </button>
              <button class="delete-btn" title="Excluir" onclick="deleteFicha(${idx})" style="background: transparent; color: var(--error); border: 1px solid var(--error); padding: 0.4rem; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; min-width: 32px; height: 32px; transition: all 0.2s ease;" onmouseover="this.style.background='var(--error)'; this.style.color='white'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='transparent'; this.style.color='var(--error)'; this.style.transform='scale(1)'">
                <span class="material-icons" style="font-size: 0.875rem;">delete</span>
              </button>
            </div>
          </td>
        `;
        fichasList.appendChild(tr);
      });
    }

    // Variáveis para filtros do dashboard
    let dashboardFilteredFichas = [...fichas];
    let currentClusterFilter = '';
    let currentPeriodFilter = '';

    // Função para aplicar filtros do dashboard
    function applyDashboardFilters() {
      const clusterFilter = document.getElementById('dashboard-cluster-filter').value;
      const periodFilter = document.getElementById('dashboard-period-filter').value;

      // Salvar filtros atuais
      currentClusterFilter = clusterFilter;
      currentPeriodFilter = periodFilter;

      // Filtrar fichas
      dashboardFilteredFichas = fichas.filter(ficha => {
        // Filtro por cluster
        const matchCluster = !clusterFilter || ficha.cluster === clusterFilter;

        // Filtro por período
        let matchPeriod = true;
        if (periodFilter) {
          const fichaDate = new Date(ficha.saida);
          const daysDiff = (Date.now() - fichaDate.getTime()) / (1000 * 60 * 60 * 24);
          matchPeriod = daysDiff <= parseInt(periodFilter);
        }

        return matchCluster && matchPeriod;
      });

      console.log('Filtros aplicados:', {
        cluster: clusterFilter,
        period: periodFilter,
        fichasFiltradas: dashboardFilteredFichas.length,
        totalFichas: fichas.length
      });

      // Atualizar dashboard com dados filtrados
      updateResumoTecnico();
      renderPieChart();
      renderLineChart();
      renderPieCategoriaChart();
      renderTempoProducaoChart();
    }

    // Função para limpar filtros do dashboard
    function clearDashboardFilters() {
      document.getElementById('dashboard-cluster-filter').value = '';
      document.getElementById('dashboard-period-filter').value = '';

      // Resetar filtros
      currentClusterFilter = '';
      currentPeriodFilter = '';
      dashboardFilteredFichas = [...fichas];

      console.log('Filtros limpos, mostrando todos os dados');

      // Atualizar dashboard com todos os dados
      updateResumoTecnico();
      renderPieChart();
      renderLineChart();
      renderPieCategoriaChart();
      renderTempoProducaoChart();
    }

    // Função para atualizar filtro de cluster
    function updateDashboardClusterFilter() {
      const clusterFilter = document.getElementById('dashboard-cluster-filter');
      const clusters = [...new Set(fichas.map(f => f.cluster))];
      
      clusterFilter.innerHTML = '<option value="">Todos os Clusters</option>';
      clusters.forEach(cluster => {
        const option = document.createElement('option');
        option.value = cluster;
        option.textContent = cluster;
        clusterFilter.appendChild(option);
      });
    }



    function renderDashboard() {
      // Atualizar filtros
      updateDashboardClusterFilter();
      
      // Adicionar event listeners para filtros
      document.getElementById('dashboard-cluster-filter').addEventListener('change', applyDashboardFilters);
      document.getElementById('dashboard-period-filter').addEventListener('change', applyDashboardFilters);

      updateResumoTecnico();
      
      // Animar entrada dos gráficos
      const chartElements = document.querySelectorAll('#pieChart, #lineChart, #pieCategoriaChart, #tempoProducaoChart');
      chartElements.forEach((element, index) => {
        setTimeout(() => {
          animateChartEntry(element);
        }, index * 200);
      });
      
      renderPieChart();
      renderLineChart();
      renderPieCategoriaChart();
      renderTempoProducaoChart();
      
      // Adicionar efeitos de hover
      setTimeout(() => {
        addChartHoverEffects();
      }, 1000);
    }

    function updateResumoTecnico() {
      // Usar dados filtrados se houver filtros ativos
      const dataToUse = dashboardFilteredFichas.length > 0 && (currentClusterFilter || currentPeriodFilter) ? dashboardFilteredFichas : fichas;
      
      const totalPecas = dataToUse.reduce((sum, f) => sum + f.quantidade, 0);
      const totalFichas = dataToUse.length;
      const totalValor = dataToUse.reduce((sum, f) => sum + f.valorTotal, 0);
      const totalClusters = new Set(dataToUse.map(f => f.cluster)).size;
      const totalCategorias = new Set(dataToUse.map(f => f.categoria)).size;
      const mediaValor = totalFichas > 0 ? totalValor / totalFichas : 0;
      const mediaPecas = totalFichas > 0 ? totalPecas / totalFichas : 0;
      const pilotagemSim = dataToUse.filter(f => f.pilotagem === 'Sim').length;
      
      // Calcular valor médio por peça
      const valorMedioPeca = totalPecas > 0 ? totalValor / totalPecas : 0;

      document.getElementById('total-pecas').textContent = totalPecas.toLocaleString();
      document.getElementById('total-fichas').textContent = totalFichas;
      document.getElementById('total-valor').textContent = `R$ ${totalValor.toFixed(2).replace('.', ',')}`;
      document.getElementById('total-clusters').textContent = totalClusters;
      document.getElementById('total-categorias').textContent = totalCategorias;
      document.getElementById('media-valor').textContent = `R$ ${mediaValor.toFixed(2).replace('.', ',')}`;
      document.getElementById('media-pecas').textContent = Math.round(mediaPecas);
      document.getElementById('pilotagem-sim').textContent = pilotagemSim;
      document.getElementById('valor-medio-peca').textContent = `R$ ${valorMedioPeca.toFixed(2).replace('.', ',')}`;
    }

    // Variáveis globais para os gráficos Chart.js
    let pieChart, lineChart, pieCategoriaChart, tempoProducaoChart;

    function renderPieChart() {
      const ctx = document.getElementById('pieChart').getContext('2d');
      
      // Destruir gráfico existente se houver
      if (pieChart) {
        pieChart.destroy();
      }
      
      // Usar dados filtrados se houver filtros ativos
      const dataToUse = dashboardFilteredFichas.length > 0 && (currentClusterFilter || currentPeriodFilter) ? dashboardFilteredFichas : fichas;
      
      if (dataToUse.length === 0) {
        document.getElementById('pieChart').style.display = 'none';
        document.getElementById('chart-legend').innerHTML = '<p style="text-align: center; color: var(--text-muted);">Nenhum dado disponível</p>';
        return;
      }
      
      document.getElementById('pieChart').style.display = 'block';

      // Calcular dados por cluster
      const clusterData = {};
      let totalPecas = 0;
      
      dataToUse.forEach(ficha => {
        if (!clusterData[ficha.cluster]) {
          clusterData[ficha.cluster] = 0;
        }
        clusterData[ficha.cluster] += ficha.quantidade;
        totalPecas += ficha.quantidade;
      });

      const labels = Object.keys(clusterData);
      const data = Object.values(clusterData);
      const colors = [
        '#3b82f6', '#1d4ed8', '#2563eb', '#1e40af', 
        '#60a5fa', '#3b82f6', '#1d4ed8', '#1e3a8a'
      ];

      pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderColor: '#ffffff',
            borderWidth: 2,
            hoverBorderWidth: 3,
            hoverBorderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: 'rgba(255, 255, 255, 0.2)',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  const percentage = ((value / totalPecas) * 100).toFixed(1);
                  return `${label}: ${value} peças (${percentage}%)`;
                }
              }
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 1000,
            easing: 'easeOutQuart'
          },
          cutout: '60%',
          radius: '90%'
        }
      });

      // Criar legenda customizada
      const legend = document.getElementById('chart-legend');
      legend.innerHTML = '';
      
      labels.forEach((label, index) => {
        const percentage = ((data[index] / totalPecas) * 100).toFixed(1);
        const legendItem = document.createElement('div');
        legendItem.style.cssText = `
          display: flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.5rem 0.75rem;
          background: var(--surface);
          border-radius: 8px;
          font-size: 0.85rem;
          border: 1px solid var(--border);
          transition: all 0.2s ease;
          cursor: pointer;
        `;
        
        legendItem.innerHTML = `
          <div style="width: 12px; height: 12px; background-color: ${colors[index]}; border-radius: 50%; border: 2px solid #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div>
          <span style="font-weight: 600; color: var(--text);">${label}</span>
          <span style="color: var(--text-secondary); font-size: 0.8rem;">${data[index]} peças (${percentage}%)</span>
        `;
        
        // Hover effect
        legendItem.addEventListener('mouseenter', () => {
          legendItem.style.background = 'var(--primary-50)';
          legendItem.style.borderColor = 'var(--primary)';
        });
        
        legendItem.addEventListener('mouseleave', () => {
          legendItem.style.background = 'var(--surface)';
          legendItem.style.borderColor = 'var(--border)';
        });
        
        legend.appendChild(legendItem);
      });
    }

    function renderLineChart() {
      const ctx = document.getElementById('lineChart').getContext('2d');
      
      // Destruir gráfico existente se houver
      if (lineChart) {
        lineChart.destroy();
      }
      
      // Usar dados filtrados se houver filtros ativos
      const dataToUse = dashboardFilteredFichas.length > 0 && (currentClusterFilter || currentPeriodFilter) ? dashboardFilteredFichas : fichas;
      
      if (dataToUse.length === 0) {
        document.getElementById('lineChart').style.display = 'none';
        return;
      }
      
      document.getElementById('lineChart').style.display = 'block';

      // Agrupar dados por mês
      const monthlyData = {};
      dataToUse.forEach(ficha => {
        const date = new Date(ficha.saida);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = 0;
        }
        monthlyData[monthKey] += ficha.quantidade;
      });

      const months = Object.keys(monthlyData).sort();
      const values = months.map(month => monthlyData[month]);
      
      // Formatar labels dos meses
      const monthLabels = months.map(month => {
        const [year, monthNum] = month.split('-');
        const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 
                           'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        return `${monthNames[parseInt(monthNum) - 1]}/${year.slice(2)}`;
      });

      lineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [{
            label: 'Produção Mensal',
            data: values,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8,
            pointHoverBackgroundColor: '#1d4ed8',
            pointHoverBorderColor: '#ffffff',
            pointHoverBorderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: 'rgba(255, 255, 255, 0.2)',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                title: function(context) {
                  return `Período: ${context[0].label}`;
                },
                label: function(context) {
                  return `Produção: ${context.parsed.y} peças`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(226, 232, 240, 0.5)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b',
                font: {
                  size: 12,
                  family: 'Inter'
                }
              }
            },
            y: {
              grid: {
                color: 'rgba(226, 232, 240, 0.5)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b',
                font: {
                  size: 12,
                  family: 'Inter'
                },
                callback: function(value) {
                  return value.toLocaleString('pt-BR');
                }
              }
            }
          },
          animation: {
            duration: 1500,
            easing: 'easeOutQuart'
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          elements: {
            point: {
              hoverRadius: 8
            }
          }
        }
      });
    }

    function calcularValorTotal() {
      const quantidade = Number(document.getElementById('quantidade').value) || 0;
      const valorUnitario = Number(document.getElementById('valorUnitario').value) || 0;
      const valorTotal = quantidade * valorUnitario;
      document.getElementById('valorTotal').value = valorTotal.toFixed(2);
    }

    window.deleteFicha = function(idx) {
      if (confirm('Deseja realmente excluir esta ficha?')) {
        const originalIdx = fichas.indexOf(filteredFichas[idx]);
        fichas.splice(originalIdx, 1);
        localStorage.setItem('fichas', JSON.stringify(fichas));
        filteredFichas = [...fichas];
        renderFichas();
        updateClusterFilter();
        updateCategoriaFilter();
        updatePagamentoFilter();
        updateClusterSelects();
        updateCategoriaSelects();
      }
    }

    fichaForm.onsubmit = async function(e) {
      e.preventDefault();
      
      // Validação dos campos obrigatórios
      const cluster = document.getElementById('cluster').value.trim();
      const categoria = document.getElementById('categoria').value.trim();
      const referencia = document.getElementById('referencia').value.trim();
      const entrada = document.getElementById('entrada').value;
      const saida = document.getElementById('saida').value;
      const pagamento = document.getElementById('pagamento').value;
      const pilotagem = document.getElementById('pilotagem').value;
      const valorUnitario = Number(document.getElementById('valorUnitario').value);
      const quantidade = Number(document.getElementById('quantidade').value);
      const observacoes = document.getElementById('observacoes').value.trim();
      
      // Verificar campos obrigatórios
      if (!cluster) {
        alert('Por favor, preencha o campo Cluster');
        document.getElementById('cluster').focus();
        return;
      }
      if (!categoria) {
        alert('Por favor, selecione uma categoria');
        document.getElementById('categoria').focus();
        return;
      }
      if (!referencia) {
        alert('Por favor, preencha o campo Referência');
        document.getElementById('referencia').focus();
        return;
      }
      if (!saida) {
        alert('Por favor, preencha a data de saída');
        document.getElementById('saida').focus();
        return;
      }
      if (!pilotagem) {
        alert('Por favor, selecione se há pilotagem');
        document.getElementById('pilotagem').focus();
        return;
      }
      if (!valorUnitario || valorUnitario <= 0) {
        alert('Por favor, preencha um valor unitário válido');
        document.getElementById('valorUnitario').focus();
        return;
      }
      if (!quantidade || quantidade <= 0) {
        alert('Por favor, preencha a quantidade de peças');
        document.getElementById('quantidade').focus();
        return;
      }
      
      // Coletar dados das cores
      const coresData = [];
      coresArray.forEach(corId => {
        const corElement = document.querySelector(`[id="${corId}-pp"]`).closest('.cor-item');
        const nomeCor = corElement.querySelector('.cor-nome').textContent;
        
        const corData = {
          id: corId,
          nome: nomeCor,
          pp: Number(document.getElementById(`${corId}-pp`).value) || 0,
          p: Number(document.getElementById(`${corId}-p`).value) || 0,
          m: Number(document.getElementById(`${corId}-m`).value) || 0,
          g: Number(document.getElementById(`${corId}-g`).value) || 0,
          gg: Number(document.getElementById(`${corId}-gg`).value) || 0
        };
        coresData.push(corData);
      });
      
      const ficha = {
        cluster: cluster,
        categoria: categoria,
        referencia: referencia,
        quantidade: quantidade,
        valorUnitario: valorUnitario,
        valorTotal: Number(document.getElementById('valorTotal').value),
        pilotagem: pilotagem,
        saida: saida,
        pagamento: pagamento || '',
        entrada: entrada || '',
        observacoes: observacoes,
        cores: coresData,
        // Manter compatibilidade com dados antigos
        pp: coresData.reduce((sum, cor) => sum + cor.pp, 0),
        p: coresData.reduce((sum, cor) => sum + cor.p, 0),
        m: coresData.reduce((sum, cor) => sum + cor.m, 0),
        g: coresData.reduce((sum, cor) => sum + cor.g, 0),
        gg: coresData.reduce((sum, cor) => sum + cor.gg, 0)
      };
      
      // Adicionar ficha ao Firebase
      try {
        console.log('🔄 Salvando ficha no Firebase...');
        
        if (window.FirebaseAuth) {
          const fichaId = await window.FirebaseAuth.addFicha(ficha);
          console.log('✅ Ficha salva no Firebase com ID:', fichaId);
          
          // Recarregar fichas do Firebase
          await loadFichasFromFirebase();
        } else {
          console.error('❌ FirebaseAuth não está disponível, salvando no localStorage');
          // Fallback para localStorage
          fichas.push(ficha);
          localStorage.setItem('fichas', JSON.stringify(fichas));
          filteredFichas = [...fichas];
        }
        
        console.log('Ficha adicionada:', ficha);
        console.log('Total de fichas:', fichas.length);
      } catch (error) {
        console.error('❌ Erro ao salvar ficha no Firebase:', error);
        // Fallback para localStorage
        fichas.push(ficha);
        localStorage.setItem('fichas', JSON.stringify(fichas));
        filteredFichas = [...fichas];
      }
      
      // Limpar formulário
      fichaForm.reset();
      
      // Resetar cores
      const coresContainer = document.getElementById('cores-container');
      const novaCorInput = document.getElementById('nova-cor-input');
      
      if (coresContainer) {
        coresContainer.innerHTML = '';
        coresArray = [];
        corCounter = 0;
      }
      
      if (novaCorInput) {
        novaCorInput.value = '';
      }
      
      // Resetar quantidade e valor total
      document.getElementById('quantidade').value = '0';
      document.getElementById('valorTotal').value = '0.00';
      
      // Limpar campo de observações
      document.getElementById('observacoes').value = '';
      
      // Mostrar mensagem de sucesso
      alert('Ficha cadastrada com sucesso!');
      
      // Atualizar filtros e selects
      updateClusterFilter();
      updateCategoriaFilter();
      updatePagamentoFilter();
      
      // Redirecionar para a lista
      switchScreen('list');
    };

    // Atualizar quantidade automaticamente ao alterar tamanhos na edição
    function atualizarQuantidadeEdit() {
      const pp = Number(document.getElementById('edit-pp').value) || 0;
      const p = Number(document.getElementById('edit-p').value) || 0;
      const m = Number(document.getElementById('edit-m').value) || 0;
      const g = Number(document.getElementById('edit-g').value) || 0;
      const gg = Number(document.getElementById('edit-gg').value) || 0;
      const total = pp + p + m + g + gg;
      document.getElementById('edit-quantidade').value = total;
      calcularValorTotalEdit();
    }
    document.getElementById('edit-pp').addEventListener('input', atualizarQuantidadeEdit);
    document.getElementById('edit-p').addEventListener('input', atualizarQuantidadeEdit);
    document.getElementById('edit-m').addEventListener('input', atualizarQuantidadeEdit);
    document.getElementById('edit-g').addEventListener('input', atualizarQuantidadeEdit);
    document.getElementById('edit-gg').addEventListener('input', atualizarQuantidadeEdit);

    // Funções de configurações
    configForm.onsubmit = function(e) {
      e.preventDefault();
      const config = {
        empresaNome: document.getElementById('empresa-nome').value.trim(),
        empresaCnpj: document.getElementById('empresa-cnpj').value.trim(),
        empresaEndereco: document.getElementById('empresa-endereco').value.trim(),
        empresaTelefone: document.getElementById('empresa-telefone').value.trim()
      };
      localStorage.setItem('config', JSON.stringify(config));
      alert('Configurações salvas com sucesso!');
      // Atualizar a última atualização
      document.getElementById('ultima-atualizacao').textContent = new Date().toLocaleDateString();
    };

    function exportarDados() {
      const data = JSON.stringify(fichas, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'fichas_followup.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert('Dados exportados com sucesso!');
    }

    function importarDados() {
      const input = document.getElementById('import-file');
      input.click();
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const importedData = JSON.parse(e.target.result);
              if (Array.isArray(importedData)) {
                fichas = importedData;
                localStorage.setItem('fichas', JSON.stringify(fichas));
                filteredFichas = [...fichas];
    renderFichas();
    updateClusterFilter();
    updateCategoriaFilter();
    updatePagamentoFilter();
                alert('Dados importados com sucesso!');
              } else {
                alert('O arquivo selecionado não contém um array de fichas válido.');
              }
            } catch (error) {
              alert('Erro ao importar dados: ' + error.message);
            }
          };
          reader.readAsText(file);
        }
      };
    }

    function limparTodosDados() {
      if (confirm('Tem certeza de que deseja limpar todos os dados? Esta ação é irreversível.')) {
        localStorage.removeItem('fichas');
        localStorage.removeItem('config');
        fichas = [];
        filteredFichas = [];
        renderFichas();
        updateClusterFilter();
        updateCategoriaFilter();
        updatePagamentoFilter();
        alert('Todos os dados foram removidos com sucesso!');
        // Atualizar a última atualização
        document.getElementById('ultima-atualizacao').textContent = new Date().toLocaleDateString();
        document.getElementById('total-fichas-config').textContent = 0;
        document.getElementById('espaco-usado').textContent = '0 KB';
      }
    }

    function atualizarInformacoesSistema() {
      // Atualizar total de fichas
      document.getElementById('total-fichas-config').textContent = fichas.length;
      
      // Calcular espaço usado
      const dados = {
        fichas: fichas,
        config: JSON.parse(localStorage.getItem('config') || '{}'),
        categorias: JSON.parse(localStorage.getItem('categoriasCadastradas') || '[]')
      };
      const tamanhoBytes = new Blob([JSON.stringify(dados)]).size;
      const tamanhoKB = (tamanhoBytes / 1024).toFixed(2);
      document.getElementById('espaco-usado').textContent = `${tamanhoKB} KB`;
      
      // Atualizar última atualização
      const ultimaAtualizacao = localStorage.getItem('ultimaAtualizacao') || new Date().toLocaleDateString();
      document.getElementById('ultima-atualizacao').textContent = ultimaAtualizacao;
    }

    // Inicialização
    switchScreen('dashboard');
    updateClusterFilter();
    updateCategoriaFilter();
    updatePagamentoFilter();
    updateCategoriaSelects();
    updateClusterSelects();
    
    // Adicionar categorias padrão se não existirem
    const categoriasExistentes = JSON.parse(localStorage.getItem('categoriasCadastradas') || '[]');
    if (categoriasExistentes.length === 0) {
      const categoriasPadrao = ['Camisetas', 'Calças', 'Vestidos', 'Blusas', 'Jaquetas', 'Shorts', 'Saias', 'Outros'];
      localStorage.setItem('categoriasCadastradas', JSON.stringify(categoriasPadrao));
      updateCategoriaSelects();
    }
    
    // Adicionar clusters padrão se não existirem
    const clustersExistentes = JSON.parse(localStorage.getItem('clustersCadastrados') || '[]');
    if (clustersExistentes.length === 0) {
      const clustersPadrao = ['Cluster A', 'Cluster B', 'Cluster C', 'Cluster D', 'Cluster E'];
      localStorage.setItem('clustersCadastrados', JSON.stringify(clustersPadrao));
    }
    
    // Salvar data da última atualização
    localStorage.setItem('ultimaAtualizacao', new Date().toLocaleDateString());

    function renderTempoProducaoChart() {
      const ctx = document.getElementById('tempoProducaoChart').getContext('2d');
      
      // Destruir gráfico existente se houver
      if (tempoProducaoChart) {
        tempoProducaoChart.destroy();
      }
      
      // Usar dados filtrados se houver filtros ativos
      const dataToUse = dashboardFilteredFichas.length > 0 && (currentClusterFilter || currentPeriodFilter) ? dashboardFilteredFichas : fichas;
      
      if (dataToUse.length === 0) {
        document.getElementById('tempoProducaoChart').style.display = 'none';
        return;
      }
      
      document.getElementById('tempoProducaoChart').style.display = 'block';

      // Calcular tempo médio de produção por categoria
      const categoriaTempos = {};
      const categoriaCounts = {};
      
      dataToUse.forEach(f => {
        const entrada = new Date(f.entrada);
        const saida = new Date(f.saida);
        const diff = (saida - entrada) / (1000 * 60 * 60 * 24);
        const tempo = isNaN(diff) ? 0 : Math.max(0, Math.round(diff));
        
        if (!categoriaTempos[f.categoria]) {
          categoriaTempos[f.categoria] = 0;
          categoriaCounts[f.categoria] = 0;
        }
        categoriaTempos[f.categoria] += tempo;
        categoriaCounts[f.categoria]++;
      });

      // Calcular tempo médio por categoria
      const labels = Object.keys(categoriaTempos);
      const data = labels.map(categoria => {
        const totalTempo = categoriaTempos[categoria];
        const count = categoriaCounts[categoria];
        return Math.round(totalTempo / count);
      });

      tempoProducaoChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Tempo de Produção (dias)',
            data: data,
            backgroundColor: 'rgba(245, 158, 11, 0.8)',
            borderColor: '#f59e0b',
            borderWidth: 2,
            borderRadius: 6,
            borderSkipped: false,
            hoverBackgroundColor: 'rgba(245, 158, 11, 1)',
            hoverBorderColor: '#d97706',
            hoverBorderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: 'rgba(255, 255, 255, 0.2)',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  const dias = context.parsed.x;
                  const categoria = context[0].label;
                  const count = categoriaCounts[categoria];
                  return `${dias} dia${dias === 1 ? '' : 's'} (média de ${count} ficha${count === 1 ? '' : 's'})`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(226, 232, 240, 0.5)',
                drawBorder: false
              },
              ticks: {
                color: '#64748b',
                font: {
                  size: 12,
                  family: 'Inter'
                },
                callback: function(value) {
                  return `${value} dia${value === 1 ? '' : 's'}`;
                }
              }
            },
            y: {
              grid: {
                display: false
              },
              ticks: {
                color: '#64748b',
                font: {
                  size: 11,
                  family: 'Inter'
                },
                maxRotation: 0
              }
            }
          },
          animation: {
            duration: 1500,
            easing: 'easeOutQuart'
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
    }

    function renderPieCategoriaChart() {
      const ctx = document.getElementById('pieCategoriaChart').getContext('2d');
      
      // Destruir gráfico existente se houver
      if (pieCategoriaChart) {
        pieCategoriaChart.destroy();
      }
      
      // Usar dados filtrados se houver filtros ativos
      const dataToUse = dashboardFilteredFichas.length > 0 && (currentClusterFilter || currentPeriodFilter) ? dashboardFilteredFichas : fichas;
      
      if (dataToUse.length === 0) {
        document.getElementById('pieCategoriaChart').style.display = 'none';
        document.getElementById('pie-categoria-legend').innerHTML = '<p style="text-align: center; color: var(--text-muted);">Nenhum dado disponível</p>';
        return;
      }
      
      document.getElementById('pieCategoriaChart').style.display = 'block';

      // Calcular dados por categoria
      const categoriaData = {};
      let totalPecas = 0;
      
      dataToUse.forEach(ficha => {
        if (!categoriaData[ficha.categoria]) {
          categoriaData[ficha.categoria] = 0;
        }
        categoriaData[ficha.categoria] += ficha.quantidade;
        totalPecas += ficha.quantidade;
      });

      const labels = Object.keys(categoriaData);
      const data = Object.values(categoriaData);
      const colors = [
        '#10b981', '#059669', '#047857', '#065f46',
        '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'
      ];

      pieCategoriaChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderColor: '#ffffff',
            borderWidth: 2,
            hoverBorderWidth: 3,
            hoverBorderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: 'rgba(255, 255, 255, 0.2)',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  const percentage = ((value / totalPecas) * 100).toFixed(1);
                  return `${label}: ${value} peças (${percentage}%)`;
                }
              }
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 1000,
            easing: 'easeOutQuart'
          },
          cutout: '60%',
          radius: '90%'
        }
      });

      // Criar legenda customizada
      const legend = document.getElementById('pie-categoria-legend');
      if (legend) {
        legend.innerHTML = '';
        
        labels.forEach((label, index) => {
          const percentage = ((data[index] / totalPecas) * 100).toFixed(1);
          const legendItem = document.createElement('div');
          legendItem.style.cssText = `
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--surface);
            border-radius: 8px;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            cursor: pointer;
          `;
          
          legendItem.innerHTML = `
            <div style="width: 12px; height: 12px; background-color: ${colors[index]}; border-radius: 50%; border: 2px solid #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div>
            <span style="font-weight: 600; color: var(--text);">${label}</span>
            <span style="color: var(--text-secondary); font-size: 0.8rem;">${data[index]} peças (${percentage}%)</span>
          `;
          
          // Hover effect
          legendItem.addEventListener('mouseenter', () => {
            legendItem.style.background = 'var(--success-light)';
            legendItem.style.borderColor = 'var(--success)';
          });
          
          legendItem.addEventListener('mouseleave', () => {
            legendItem.style.background = 'var(--surface)';
            legendItem.style.borderColor = 'var(--border)';
          });
          
          legend.appendChild(legendItem);
        });
      }
    }

    // Sidebar retrátil responsiva (usar variáveis já declaradas no início do script)
    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      sidebar.classList.remove('translate-x-0');
    }
    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      sidebar.classList.add('translate-x-0');
    }
    
    // Verificar se estamos em mobile
    function isMobile() {
      return window.innerWidth < 768;
    }
    
    // Inicializar estado da sidebar baseado no tamanho da tela
    function initializeSidebar() {
      if (isMobile()) {
        closeSidebar();
      } else {
        openSidebar();
      }
    }
    
    // Inicializar sidebar
    initializeSidebar();
    
    mobileMenuToggle.addEventListener('click', function() {
      console.log('🔄 Botão de menu mobile clicado');
      console.log('📱 Estado atual da sidebar:', sidebar.classList.contains('-translate-x-full') ? 'fechada' : 'aberta');
      
      if (sidebar.classList.contains('-translate-x-full')) {
        console.log('📱 Abrindo sidebar...');
        openSidebar();
      } else {
        console.log('📱 Fechando sidebar...');
        closeSidebar();
      }
    });
    
    // Atualizar sidebar quando a tela é redimensionada
    window.addEventListener('resize', function() {
      if (!isMobile()) {
        openSidebar();
      } else {
        closeSidebar();
      }
    });
    // Fecha sidebar ao clicar fora no mobile
    document.addEventListener('click', function(e) {
      if (window.innerWidth < 768 && !sidebar.contains(e.target) && !mobileMenuToggle.contains(e.target)) {
        closeSidebar();
      }
    });
    // Fecha sidebar ao navegar
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        if (window.innerWidth < 768) closeSidebar();
      });
    });
    
    // Event listener para o botão de logout
    document.getElementById('logout-button').addEventListener('click', async () => {
      try {
        console.log('🔄 Botão de logout clicado...');
        
        // Feedback visual - desabilitar botão
        const logoutButton = document.getElementById('logout-button');
        const originalText = logoutButton.innerHTML;
        logoutButton.innerHTML = `
          <span class="material-icons">hourglass_empty</span>
          <span>Saindo...</span>
        `;
        logoutButton.style.pointerEvents = 'none';
        logoutButton.style.opacity = '0.7';
        
        // Executar logout
        await logout();
        
      } catch (error) {
        console.error('❌ Erro ao fazer logout:', error);
        console.error('❌ Detalhes do erro:', error.message);
        
        // Restaurar botão em caso de erro
        const logoutButton = document.getElementById('logout-button');
        logoutButton.innerHTML = `
          <span class="material-icons">logout</span>
          <span>Sair</span>
        `;
        logoutButton.style.pointerEvents = 'auto';
        logoutButton.style.opacity = '1';
        
        // Mesmo com erro, redirecionar para login
        setTimeout(() => {
          console.log('🔄 Redirecionando para login após erro...');
          const timestamp = Date.now();
          const loginUrl = `index.html?t=${timestamp}&logout=true&error=true`;
          window.location.href = loginUrl;
        }, 1000);
      }
    });

    // Função para animar entrada dos gráficos
    function animateChartEntry(chartElement) {
      chartElement.style.opacity = '0';
      chartElement.style.transform = 'scale(0.9)';
      
      setTimeout(() => {
        chartElement.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
        chartElement.style.opacity = '1';
        chartElement.style.transform = 'scale(1)';
      }, 100);
    }
    
    // Função para adicionar efeitos de hover nos containers dos gráficos
    function addChartHoverEffects() {
      const chartContainers = document.querySelectorAll('[id*="Chart"]').forEach(container => {
        if (container.parentElement) {
          const parent = container.parentElement;
          parent.style.transition = 'all 0.3s ease';
          
          parent.addEventListener('mouseenter', () => {
            parent.style.transform = 'translateY(-4px)';
            parent.style.boxShadow = 'var(--shadow-xl)';
          });
          
          parent.addEventListener('mouseleave', () => {
            parent.style.transform = 'translateY(0)';
            parent.style.boxShadow = 'var(--shadow)';
          });
        }
      });
    }

    // Função para adicionar cor no modal de edição
    function adicionarCorEdit() {
      const novaCorInput = document.getElementById('edit-nova-cor-input');
      const nomeCor = novaCorInput.value.trim();
      
      if (!nomeCor) {
        alert('Por favor, digite o nome da cor/estampa');
        return;
      }
      
      const corId = `edit-cor-${editCorCounter++}`;
      const coresContainer = document.getElementById('edit-cores-container');
      
      const corItem = document.createElement('div');
      corItem.className = 'cor-item';
      corItem.id = corId;
      corItem.style.cssText = `
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow);
      `;
      
      corItem.innerHTML = `
        <div class="cor-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <span class="cor-nome" style="font-weight: 600; color: var(--text); font-size: 1rem;">${nomeCor}</span>
          <button type="button" class="remove-cor-btn" onclick="removerCorEdit('${corId}')" style="background: var(--error); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
            <span class="material-icons" style="font-size: 1rem;">delete</span>
            Remover
          </button>
        </div>
        <div class="tamanhos-grid">
          <div class="tamanho-item">
            <label>PP / 36</label>
            <input type="number" min="0" value="0" onchange="atualizarQuantidadeTotalEdit()" />
          </div>
          <div class="tamanho-item">
            <label>P / 38</label>
            <input type="number" min="0" value="0" onchange="atualizarQuantidadeTotalEdit()" />
          </div>
          <div class="tamanho-item">
            <label>M / 40</label>
            <input type="number" min="0" value="0" onchange="atualizarQuantidadeTotalEdit()" />
          </div>
          <div class="tamanho-item">
            <label>G / 42</label>
            <input type="number" min="0" value="0" onchange="atualizarQuantidadeTotalEdit()" />
          </div>
          <div class="tamanho-item">
            <label>GG / 44</label>
            <input type="number" min="0" value="0" onchange="atualizarQuantidadeTotalEdit()" />
          </div>
        </div>
      `;
      
      coresContainer.appendChild(corItem);
      editCoresArray.push({ id: corId, nome: nomeCor });
      
      novaCorInput.value = '';
      novaCorInput.focus();
      atualizarQuantidadeTotalEdit();
    }
    
    // Função para remover cor no modal de edição
    function removerCorEdit(corId) {
      const corItem = document.getElementById(corId);
      if (corItem) {
        corItem.remove();
        editCoresArray = editCoresArray.filter(cor => cor.id !== corId);
        atualizarQuantidadeTotalEdit();
      }
    }
    
    // Função para atualizar quantidade total no modal de edição
    function atualizarQuantidadeTotalEdit() {
      const coresItems = document.querySelectorAll('#edit-cores-container .cor-item');
      let totalQuantidade = 0;
      
      coresItems.forEach(corItem => {
        const inputs = corItem.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
          totalQuantidade += parseInt(input.value) || 0;
        });
      });
      
      document.getElementById('edit-quantidade').value = totalQuantidade;
      calcularValorTotalEdit();
    }

    // Event listeners para o modal de edição
    document.addEventListener('DOMContentLoaded', function() {
      const editAddCorBtn = document.getElementById('edit-add-cor-btn');
      const editNovaCorInput = document.getElementById('edit-nova-cor-input');
      
      if (editAddCorBtn) {
        editAddCorBtn.addEventListener('click', adicionarCorEdit);
      }
      
      if (editNovaCorInput) {
        editNovaCorInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            adicionarCorEdit();
          }
        });
      }
    });

    // Função para carregar configurações da empresa
    function carregarConfiguracoesEmpresa() {
      const configEmpresa = JSON.parse(localStorage.getItem('configEmpresa') || '{}');
      
      // Preencher formulário
      document.getElementById('empresa-nome').value = configEmpresa.nome || '';
      document.getElementById('empresa-cnpj').value = configEmpresa.cnpj || '';
      document.getElementById('empresa-endereco').value = configEmpresa.endereco || '';
      document.getElementById('empresa-telefone').value = configEmpresa.telefone || '';
      
      // Atualizar exibição na barra superior
      atualizarNomeEmpresaHeader(configEmpresa.nome);
    }
    
    // Função para atualizar nome da empresa no header
    function atualizarNomeEmpresaHeader(nomeEmpresa) {
      const empresaInfo = document.getElementById('empresa-info');
      const empresaNomeDisplay = document.getElementById('empresa-nome-display');
      
      if (nomeEmpresa && nomeEmpresa.trim() !== '') {
        empresaNomeDisplay.textContent = nomeEmpresa;
        empresaInfo.style.display = 'flex';
      } else {
        empresaInfo.style.display = 'none';
      }
    }
    
    // Event listener para o formulário de configurações
    configForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const configEmpresa = {
        nome: document.getElementById('empresa-nome').value.trim(),
        cnpj: document.getElementById('empresa-cnpj').value.trim(),
        endereco: document.getElementById('empresa-endereco').value.trim(),
        telefone: document.getElementById('empresa-telefone').value.trim()
      };
      
      // Salvar no localStorage
      localStorage.setItem('configEmpresa', JSON.stringify(configEmpresa));
      
      // Atualizar exibição na barra superior
      atualizarNomeEmpresaHeader(configEmpresa.nome);
      
      // Feedback visual
      alert('Configurações salvas com sucesso!');
    });
    
    // Carregar configurações ao iniciar
    document.addEventListener('DOMContentLoaded', function() {
      carregarConfiguracoesEmpresa();
      
      // Adicionar máscaras aos campos CNPJ e Telefone
      const cnpjInput = document.getElementById('empresa-cnpj');
      const telefoneInput = document.getElementById('empresa-telefone');
      
      if (cnpjInput) {
        cnpjInput.addEventListener('input', function() {
          formatarCNPJ(this);
        });
        cnpjInput.addEventListener('keypress', function(e) {
          // Permite apenas números
          if (!/\d/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete') {
            e.preventDefault();
          }
        });
      }
      
      if (telefoneInput) {
        telefoneInput.addEventListener('input', function() {
          formatarTelefone(this);
        });
        telefoneInput.addEventListener('keypress', function(e) {
          // Permite apenas números
          if (!/\d/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete') {
            e.preventDefault();
          }
        });
      }
    });

    // Funções de formatação para CNPJ e Telefone
    function formatarCNPJ(input) {
      let value = input.value.replace(/\D/g, ''); // Remove tudo que não é dígito
      
      if (value.length <= 14) {
        // Aplica a máscara: XX.XXX.XXX/XXXX-XX
        value = value.replace(/^(\d{2})(\d)/, '$1.$2');
        value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
        value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
        value = value.replace(/(\d{4})(\d)/, '$1-$2');
      }
      
      input.value = value;
    }
    
    function formatarTelefone(input) {
      let value = input.value.replace(/\D/g, ''); // Remove tudo que não é dígito
      
      if (value.length <= 11) {
        // Aplica a máscara: (XX) XXXXX-XXXX ou (XX) XXXX-XXXX
        if (value.length <= 10) {
          // Telefone fixo: (XX) XXXX-XXXX
          value = value.replace(/^(\d{2})(\d)/, '($1) $2');
          value = value.replace(/(\d{4})(\d)/, '$1-$2');
        } else {
          // Celular: (XX) XXXXX-XXXX
          value = value.replace(/^(\d{2})(\d)/, '($1) $2');
          value = value.replace(/(\d{5})(\d)/, '$1-$2');
        }
      }
      
      input.value = value;
    }
    
    // Função para carregar configurações da empresa
  </script>
</body>
</html> 